<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}" 
	layout:fragment="Content">
<head>
	<style>
		.main-table {
			border: 2px solid #0d6efd;
		}

		.main-table th {
			background-color: #e3f2fd;
			text-align: center;
			vertical-align: middle;
			font-weight: bold;
			border: 1px solid #ddd;
		}

		.main-table td {
			text-align: center;
			vertical-align: middle;
			border: 1px solid #ddd;
		}

		.detail-table {
			margin-top: 20px;
		}

		.detail-table th {
			background-color: #f8f9fa;
			text-align: center;
			font-size: 14px;
			padding: 8px;
		}

		.detail-table td {
			text-align: center;
			font-size: 14px;
			padding: 8px;
		}

		.search-container {
			margin-bottom: 20px;
		}

		.btn-group-custom {
			margin-bottom: 20px;
		}

		.tui-pagination {
			padding-bottom: 10px;
		}
		.row-selected {
    		background-color: #e6f2ff !important;
  		}	
	</style>
</head>
<body class="bg-light">
	<div class="container-fluid mt-4">
		<div class="d-flex justify-content-between align-items-center mb-3">
		<h3 class="mb-4 text-secondary fw-bold border-bottom border-secondary pb-2">주문관리</h3>
		</div>
		<!--수정하기 -->
		<!-- 상단 버튼 정렬 -->
		<!-- 🔍 검색 조건 카드 -->
<div class="card mb-3 shadow-sm">
  <div class="card-body">
    <div class="row g-3 align-items-center">

      <!-- 검색 조건 -->
      <div class="col-md-4">
        <label for="orderSelect" class="form-label">검색 조건</label>
        <div class="input-group">
          <select class="form-select" id="orderSelect">
            <option value="ordCode">주문코드</option>
            <option value="vdrName">거래처명</option>
            <option value="vdrCode">거래처코드</option>
          </select>
          <input type="text" class="form-control" id="orderInput" placeholder="검색어 입력">
        </div>
				<ul id="autoOrderList"
											class="list-group position-absolute w-100 shadow-sm"
											style="top: 100%; z-index: 1050; max-height: 200px; overflow-y: auto; display: none;">
				</ul>
      </div>

			  <div class="col-md-3">
        <label class="form-label">납기일자</label>
        <div class="d-flex gap-2">
          <input type="date" id="reqDlvStartDate" class="form-control">
          <input type="date" id="reqDlvEndDate" class="form-control">
        </div>
      </div>

     

      <!-- 상태 -->
      <div class="col-md-3">
        <label class="form-label d-block">진행 상태</label>
        <div class="d-flex gap-2 flex-wrap">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="orderStatus" id="statusAll" value="" checked>
            <label class="form-check-label" for="statusAll">전체</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="orderStatus" id="status1" value="ost01">
            <label class="form-check-label" for="status1">주문등록</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="orderStatus" id="status2" value="ost02">
            <label class="form-check-label" for="status2">출고대기</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="orderStatus" id="status3" value="ost03">
            <label class="form-check-label" for="status3">출고완료</label>
          </div>
        </div>
      </div>

      <!-- 검색 버튼 -->
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" id="orderSearchBtn">
          <i class="fas fa-search"></i> 검색
        </button>
      </div>

    </div>
  </div>
</div>
<!-- ✅ 버튼 그룹 (검색박스 아래 자연스럽게 배치) -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div></div> <!-- 왼쪽 공간 비워두기 (필요 시 추가 요소 가능) -->
  <div class="d-flex flex-wrap gap-2">
    <button id="excel" class="btn btn-success">
      <i class="fas fa-file-excel"></i> 엑셀
    </button>
    <button id="addRow" class="btn btn-secondary">
      <i class="fas fa-plus"></i> 행추가
    </button>

    <button id="ordreg2" class="btn btn-primary">
      <i class="fas fa-pen"></i> 주문등록
    </button>
		  
    <button id="deleteRow" class="btn btn-danger">
      <i class="fas fa-trash"></i> 행삭제
    </button>
  </div>
</div>
  <!-- 검색창 영역 -->
		<div id="orderGrid" class="mb-4"></div>
		<!-- 상세 버튼 정렬 -->
			  <div class="row mb-3">	
        		<div class="col-12 d-flex justify-content-end">
                <div class="btn-group-custom">
                	<button class="btn btn-secondary me-2" id="addRowdtl">
                        <i class="fas fa-pen"></i>  상세행추가
                    </button>
					<!-- <button class="btn btn-warning" id="modRowdtl">
						<i class="fas fa-eye"></i>  상세수정
					</button> -->
					<button class="btn btn-primary" id="saveRowdtl">
                        <i class="fas fa-save"></i> 상세저장
                    </button>
                    <button class="btn btn-danger me-2" id="delRowdtl">
                        <i class="fas fa-trash"></i> 상세행삭제
                    </button>
                </div>
            </div>
        </div>

		<!-- 상세 그리드 -->
		<div id="ordDtlGrid"></div>

		<!-- 품목 모달 -->
		<div class="modal fade" id="exampleModalToggle" tabindex="-1" aria-labelledby="exampleModalToggleLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      
      <!-- 모달 헤더 -->
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalToggleLabel">품목 선택</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- 모달 바디 -->
      <div class="modal-body">
        <!-- 검색창 -->
        <div class="position-relative mb-3" style="max-width: 500px;">
          <div class="input-group">
            <select class="form-select" id="itemSelect" style="max-width: 30%;">
              <option value="itemCode" selected>아이템코드</option>
              <option value="name">아이템명</option>
            </select>
            <input type="text" class="form-control" placeholder="검색어를 입력하세요" id="itemInput" autocomplete="off">
            <button class="btn btn-outline-secondary" type="button" id="itemSearchBtn">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <!-- 자동완성 리스트 -->
          <ul id="autoitemList"
              class="list-group position-absolute w-100 shadow-sm"
              style="top: 100%; z-index: 1050; max-height: 200px; overflow-y: auto; display: none;">
          </ul>
        </div>

        <!-- 결과 리스트 영역 -->
        <div id="itemList"></div>
      </div>

      <!-- 모달 푸터 -->
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-target="#exampleModalToggle2" data-bs-toggle="modal" data-bs-dismiss="modal">
          품목 선택
        </button>
      </div>
    </div>
  </div>
</div>
	

		<!-- 거래처 모달 1 -->
		 <div class="modal fade" id="vdrModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-body">
					<!--검색창-->
						<div class="position-relative mt-4 mb-0" style="max-width: 500px;">
						    <div class="input-group">
						        <select class="form-select col-4" id="vdrSelect" style="max-width: 30%;">
						            <option value="vdrCode" selected>거래처코드</option>
						            <option value="vdrName">거래처명</option>
						        </select>
						        <input type="text" class="form-control" placeholder="검색어를 입력하세요" id="vdrInput" autocomplete="off">
						        <button class="btn btn-outline-secondary" type="button" id="vdrSearchBtn">
						            <i class="fas fa-search"></i>
						        </button>
						    </div>
						
						    <!-- 자동완성 리스트 -->
						    <ul id="autoVdrList"
						        class="list-group position-absolute w-100 shadow-sm"
						        style="top: 100%; z-index: 1050; max-height: 200px; overflow-y: auto; display: none;">
						    </ul>
						</div>
					</div>
						<!--검색창 끝 -->
					<div id="vdrList"></div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>  

		<!-- 거래처 모달 2 -->
		<div class="modal fade" id="vdrmymodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="exampleModalLabel">거래처목록</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div id="vdrList"></div>
					<div class="modal-body">
						<div class="row card">
							<div class="form-floating mb-3">
								<input type="date" class="form-control" id="floatingInput" placeholder="날짜 선택">
								<label for="floatingInput">일자</label>
							</div>
						</div>
						<div class="container-fluid">
							<div id="modal"></div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
		<!-- 거래처 모달 3 -->
		<div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="exampleModalLabel">거래처목록</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div id="vdrList"></div>
					<div class="modal-body">
						<div class="row card">
							<div class="form-floating mb-3">
								<input type="date" class="form-control" id="floatingInput" placeholder="날짜 선택">
								<label for="floatingInput">일자</label>
							</div>
						</div>
						<div class="container-fluid">
							<div id="modal"></div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>


	</div>
</body>
<script th:inline="javascript">
	//타임리프 
	let vdrAll; //모든 vdr을담는 리스트 
	let newOrdRowNo; //
	let newNo; // dtl 주문신규행을 추가했을때 받아오는 행번호
	let newItemInfoList = new Map(); //[{1:['itemCode''name','price',],2:{}] 
	let orderTotprice = new Map(); //[1:['totprice','discPrice'],2:['totPrice','discPrice']]  orderDtl의 총금액과 할인금액을 가져옴 
	let vdrdiscount; //거래처할인율
	let newOrdPlus; //상단헤더에서  새로추가한 행번호
	let newDtlList = []; //[] 새로운 주문상세 행번호를 받아옴  
	let pageStatus='search'; //페이지 기본값 search로 두기 


	var payMethod = /*[[${payMethod}]]*/ [];
	var ordStatus = /*[[${status}]]*/ [];  
	var itemType = /*[[${itemType}]]*/ []; 
	var ordStatusList=/*[[${ordStatus}]]*/ [];  

	orderList(); //주문조회  
	itemList(); //제품조회 
	vdrList(); //거래처조회


let map=new Map(); 

$('#orderSearchBtn').on('click',function(){

if(pageStatus=='register'){
		Swal.fire({
			title: "현재등록을 중단하시겠습니까?",
			text: "검색을 진행합니다",
			icon: "warning",
			showCancelButton: true,
			confirmButtonColor: "#3085d6",
			cancelButtonColor: "#d33",
			confirmButtonText: "검색하기"
			}).then((result) => {
			if (result.isConfirmed) {
				pageStatus='search';
				ordDtlGrid.resetData([]); 
			}
			});
		}		


		let reqDlvStartDate=document.getElementById('reqDlvStartDate').value;
		let reqDlvEndDate=document.getElementById('reqDlvEndDate').value; 
		let type=$('#orderSelect  option:selected').val();
		let value=$('#orderInput').val();
		let url='/erp/sales/orderList'; 
	
		const status = document.querySelector('input[name="orderStatus"]:checked').value;
		commonSearchObject({type,value,reqDlvStartDate ,reqDlvEndDate,status},url,orderGrid);

})
    //자동완성기능
	$('#vdrInput').on('keyup',ev => {
		 setupAutocomplete({
			    inputSelector: '#vdrInput',                              //인풋에 겁색값
			    selectSelector: $('#vdrSelect  option:selected').val(),  //selected 결과값
			    listSelector: '#autoVdrList',                            //자동완성 되는값 
			    ajaxUrl: '/erp/sales/venderAll'                     //ajaxurl
		 });
	});
	$('#vdrInput').on('keyup',ev => {
		if(ev.keyCode ==13){
			let type = $("#vdrSelect option:selected").val();
			let value = $("#vdrInput").val();
			let url ='/erp/sales/venderAll';
			let grid = vdrGrid
			commonSearch(type,value,url,grid);
		}
	})
	

   //아이템 검색 자동완성
	$('#itemInput').on('keyup',ev => {
		 setupAutocomplete({
			    inputSelector: '#itemInput',                              //인풋에 겁색값
			    selectSelector: $('#itemSelect  option:selected').val(),  //selected 결과값
			    listSelector: '#autoitemList',                            //자동완성 되는값 
			    ajaxUrl: '/erp/sales/itemAll'                     //ajaxurl
		 });
	});
	$('#itemInput').on('keyup',ev => {
		if(ev.keyCode ==13){
			let type = $("#itemSelect option:selected").val();
			let value = $("#itemInput").val();
			let url ='/erp/sales/itemAll';
			let grid = itemGrid
			commonSearch(type,value,url,grid);
		}
	})
	//order 
	$('#orderInput').on('keyup',ev => {
		 setupAutocomplete({
			    inputSelector: '#orderInput',                              //인풋에 겁색값
			    selectSelector: $('#orderSelect  option:selected').val(),  //selected 결과값
			    listSelector: '#autoOrderList',                            //자동완성 되는값 
			    ajaxUrl: '/erp/sales/orderList'                     
		 });
	});
	$('#orderInput').on('keyup',ev => {
		if(ev.keyCode ==13){
			let type = $("#orderSelect option:selected").val();
			let value = $("#orderInput").val();
			let url ='/erp/sales/orderList';
			let grid = orderGrid
		//	commonSearchObject({type,value, , },url,grid);
		}
	})	
	//setTimeout(); //초기설정
	const orderGrid = new tui.Grid({
		//toastui 아이디 가져오기
		el: document.getElementById('orderGrid'),
		//checkbox부여
		rowHeaders: ['checkbox'],
		//editingEvent: 'click',	
		//페이지네이션
		pageOptions: {
			perPage: 5,
			useClient: true,
		},
		//필드값 구성
		columns: [
			{header: '주문번호',name: 'ordCode',	align: 'center',width: 100,	},
			{header: '등록일자',name: 'createdDate',align: 'center'},
			{header: '거래처이름',name: 'vdrName',	align: 'center'},
			{header: '거래처코드',name: 'vdrCode',align: 'center'},
			{header: '납기일자',name: 'reqDlvDate',align: 'center',editor: 'datePicker'},
			{header: '총금액',	name: 'totPrice',	align:'right',
				formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + '원',
				},
			{header: '여신한도',name: 'creditPrice',align:'right', 
				formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + '원',
				},
			{header: '여신잔액',name: 'creditBalPrice',	align:'right',
				formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + '원', 	
			},
			{header: '지불방식',	name: 'payMethod',align: 'center',
				formatter: 'listItemText',	
				editor: {type: 'select',
						 		 options: {listItems: payMethod}
						}//Map형태로 담아옴 [{"text":"","value":""}]
			},
			{header: '진행상태',name: 'status',align: 'center',
					formatter:({ value }) => {
    				    if(value=='ost01'|| value==null ){
    				       return `<span class="start-action">주문등록</span>`;
    				    }else if(value=='ost02'){
    				       return `<span class="end-action">출고대기</span>`;
    				    }else if(value=='ost03'){
    				       return `<span class="del-action">출고완료</span>`;
    				    }
    				    return '';
    				},
			
			}, 
			{header: '할인율',name: 'discount',align: 'center',
				formatter: function (discount) {
					if (discount.value == null) {
						return discount.value = ' ';
					} else if (discount.value != null) {
						return discount.value = discount.value + '%';
					}
				}
			}
		]

		});

	let  selectedRowKey; 
	orderGrid.on('click', (ev) => {

		//이 전에 선택한 행 색깔이 원래대로 돌아옴 
		orderGrid.removeRowClassName(selectedRowKey,'row-selected'); 
		selectedRowKey=ev.rowKey; 
		orderGrid.addRowClassName(ev.rowKey,'row-selected'); 

		const checkedRows = orderGrid.getCheckedRowKeys();	 	

		if (checkedRows.length > 1 || checkedRows[0] !== ev.rowKey) {
				orderGrid.uncheckAll(); // 전체 해제
				orderGrid.check(ev.rowKey); // 현재 행만 체크
		}
		if (ev.columnName == "vdrCode" || ev.columnName == "vdrName") {
			openVdrmodal();
		
		} //모달열기
		const rowData = orderGrid.getRow(ev.rowKey);
		if (rowData && rowData.ordCode?.trim()) {
			if(pageStatus=='search'){
				ordDtlList(rowData.ordCode);
			}
		}


		let headTotPrice = 0;
		//null값 방지 
		for (let i = 0; i < ordDtlGrid.getData().length; i++) {
				// if (ordDtlGrid.getData()[i].ordCode == null) {
				// 	ordDtlGrid.setValue(i, "ordCode", orderGrid.getRow(ev.rowKey).ordCode);
				// }
				if (ordDtlGrid.getData()[i].quantity == null) {
					ordDtlGrid.setValue(i, "quantity", 1); //수량null값 이면 default 1로 부여하기로함   
				}
				ordDtlGrid.setValue(i, "totPrice",
					ordDtlGrid.getData()[i].supPrice +
					ordDtlGrid.getData()[i].vatPrice -
					ordDtlGrid.getData()[i].discPrice);
			//	console.log('ordDtlGrid.getData(i)', ordDtlGrid.getData()[i]);
				headTotPrice += ordDtlGrid.getData()[i].totPrice;
		}

		console.log('null값 방지', ordDtlGrid.getData());
	})
	orderGrid.on('afterChange', ev => {
		if (ev.changes[0].columnName == 'vdrCode') {
			let vdrCode = ev.changes[0].value; //거래처번호  
			for (let i = 0; i < vdrAll.length; i++) { //[{},{},{}] 거래처리스트중에 해당하는 
				console.log(vdrAll.length);
				if (vdrAll[i].vdrCode == vdrCode) {
					orderGrid.setValue(ev.changes[0].rowKey, "vdrName", vdrAll[i].vdrName); //이름 
					orderGrid.setValue(ev.changes[0].rowKey, "creditPrice", vdrAll[i].creditPrice); //여신가격 
					orderGrid.setValue(ev.changes[0].rowKey, "creditBalPrice", vdrAll[i].creditBalPrice); //여신잔액 
					orderGrid.setValue(ev.changes[0].rowKey, "discount", vdrAll[i].discount); //할인율 
					vdrdiscount = vdrAll[i].discount / 100; //거래처 추가할때 할인율을 변수로 지정해서 받아옴 
				}
			}
		}
	})
	//주문번호를 받아와서 상세품목 조회후 테이블 생성하는 함수 	
	// ordDtlGrid.resetData(result);
	let ordDtlGrid = new tui.Grid({
		el: document.getElementById('ordDtlGrid'),
		rowHeaders: ['checkbox'],
		columns: [
			{header: '주문상세정보',name: 'ordDtlCode',	align: 'center',width: 110},
			{header: '품목코드',name: 'itemCode',align: 'center',editor:'text',width:100},
			{header: '품목명',name: 'name',align: 'left',resizable: true,width:180},
			{header: '단가',name: 'price',	align: 'right',
				formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + '원',},
			{header: '수량',name: 'quantity',align: 'center',	
			 	formatter: ({value }) => (value == null || value === 0) ? '' : value.toLocaleString() + '개',
				editor: 'text'},
			{header: '공급가액',name: 'supPrice',align: 'right',
			 	formatter: ({value}) => (value == null || value === 0) ? '' : value.toLocaleString() + '원'},
			{header: '부가세',name: 'vatPrice',	align: 'right',
				formatter: ({value}) => (value == null || value === 0) ? '' : value.toLocaleString() + '원'},
			{header: '할인금액',name: 'discPrice',	align: 'right',	
				formatter: ({value}) => (value == null || value === 0) ? '' : value.toLocaleString() + '원'}, 
			{header: '총가격',name: 'totPrice',	align: 'right',
				formatter: ({value}) => (value == null || value === 0) ? '' : value.toLocaleString() + '원',
				editor:'text'}
		]
	})
	//아이템 모달안에 아이템그리드 생성  
	let itemGrid = new tui.Grid({
		el: document.getElementById('itemList'), //아이템그리드 아이디 찾기 
		rowHeaders: ['checkbox'], //체크박스 
		pageOptions: {
			perPage: 10, //10개씩 보여주기 
			useClient: true,
		},
		columns: [
			{header: '종류', name: 'type',align: 'center',
				formatter: ({ value }) => formatItemType(value)},
			{header: '품목코드',name: 'itemCode',align: 'center'},
			{header: '품목명',name: 'name',align: 'left'},
			{header: '가격',name: 'price',align:'right',
				formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + '원'		
		}
		]
	})
	//vdr 모달안에  vdrGrid 생성  
	let vdrGrid = new tui.Grid({
		el: document.getElementById('vdrList'),
		rowHeaders: ['checkbox'], //체크박스
		pageOptions: {
			perPage: 10,
			useClient: true,
		},
		columns: [
			{header: '거래처코드',name: 'vdrCode',align: 'center'},
			{header: '거래처명',name: 'vdrName',align: 'center'},
			{header: '여신한도',name: 'creditPrice',align: 'center',
				formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + '원'
			},
			{header: '여신잔액',name:'creditBalPrice',align: 'center',
					formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + '원'
			},
			{header: '할인율',name:'discount',align: 'center',
					formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + '%'
			}
		]
	})
	vdrGrid.on('click', (ev) => {
		console.log('새로추가된 행의번호', newOrdPlus);
		const checkedRows = vdrGrid.getCheckedRowKeys();
		if (checkedRows.length > 1 || checkedRows[0] !== ev.rowKey) {
			vdrGrid.uncheckAll(); // 전체 해제
			vdrGrid.check(ev.rowKey); // 현재 행만 체크
		}
		const rowData = vdrGrid.getRow(ev.rowKey); //행
		const rowNo = orderGrid.getCheckedRowKeys()

		orderGrid.setValue(rowNo[0], 'discount', rowData.discount);
		orderGrid.setValue(rowNo[0], 'creditPrice', rowData.creditPrice);
		orderGrid.setValue(rowNo[0], "creditBalPrice", rowData.creditBalPrice);
		orderGrid.setValue(rowNo[0], "vdrName", rowData.vdrName);
		orderGrid.setValue(rowNo[0], "vdrCode", rowData.vdrCode);
		vdrdiscount = rowData.discount / 100; //거래처 추가할때 할인율을 변수로 지정해서 받아옴

		const vdrModalInstance = bootstrap.Modal.getInstance(document.getElementById('vdrModal'));
		if (vdrModalInstance) {
			vdrModalInstance.hide();
		}
		vdrGrid.uncheckAll(); 
		vdrList();
		
	})
	//item 항목 선택 했을때 항목 적용 newItemInfoList 에 추가할 품목과 해당 행의 번호가 모두 저장됨 
	itemGrid.on('click', (ev) => {
		//	console.log(ev); 
		console.log('신규 추가된 해당 행', newNo); // 행추가할때마다 newNo는 계속 바뀜 
		newDtlList.push(newNo); //등록할때 배열에 담김 
		//console.log(newDtlList);   
		const checkedRows = itemGrid.getCheckedRowKeys(); //아이템그리드 체크된 행번호 가져오기
		if (checkedRows.length > 1 || checkedRows[0] !== ev.rowKey) {
			itemGrid.uncheckAll(); // 전체 해제
			itemGrid.check(ev.rowKey); // 현재 행만 체크
		}
		const rowData = itemGrid.getRow(ev.rowKey); //행의 값을 가져옴 {itemCode:"item-101"}
		let newitemInfo = itemInfo(rowData.itemCode, rowData.name, rowData.price); //itemInfo값 반환
		newItemInfoList.set(newNo, newitemInfo); //품목추가된 정보를 계속 담음   
		console.log(newItemInfoList); //새로 추가한 행의 아이템 정보의 행과 아이템정보 저장함 {1:[itemCode,name,price],2:[]}

		ordDtlGrid.setValue(newNo, "itemCode", rowData.itemCode);
		ordDtlGrid.setValue(newNo, "name", rowData.name);
		ordDtlGrid.setValue(newNo, "price", rowData.price); // 
		ordDtlGrid.setValue(newNo, "supPrice", rowData.price); //공급가액 
		ordDtlGrid.setValue(newNo, "vatPrice", rowData.price / 10); //부가세 
		ordDtlGrid.setValue(newNo, "totPrice", rowData.price + rowData.price / 10); //총가격 아이템 선택시 기본세팅 수량 1기준으로 자동입력됨
		ordDtlGrid.setValue(newNo, "discPrice", (rowData.price + rowData.price / 10) * vdrdiscount); // 총금액 * 할인율  

		const itemModalInstance = bootstrap.Modal.getInstance(document.getElementById('exampleModalToggle'));
		if (itemModalInstance) {
			itemModalInstance.hide();
		}

		itemGrid.uncheckAll();
		 
	});
	//데이터 불러오는 함수
	function orderList() {
		$.ajax({
			url: "/erp/sales/orderList",
			method: "GET",
			success: function (result) {
				//console.log('주문정보 불러오기', result);
				console.log(result);
				orderGrid.resetData(result);
			}
		})
		

	}
	//메인리스트 불러오기 
	function mainList(){
		pageStatus='search'; 
		orderList(); //조회다시 하기 
	}

	//주문번호에 해당하는 상세정보 불러오는 함수
	function ordDtlList(ordcode) {
		$.ajax({
			url: "/erp/sales/ordDtlList",
			method: "GET",
			data: {
				ordCode: ordcode
			},
			success: function (result) {
				//console.log('주문상세정보 불러오기', result);
				ordDtlGrid.resetData(result);
				console.log('상세정보조회',result);
			}
		})
	}
	//아이템리스트 불러오는 함수  
	function itemList() {
		$.ajax({
			url: "/erp/sales/itemAll",
			method: "GET",
			success: function (result) {
				//	console.log(result);
				itemGrid.resetData(result);
			}
		})
	}

	function vdrList() { //거래처리스트조회 
		$.ajax({
			url: "/erp/sales/venderAll",
			method: "GET",
			success: function (result) {
				vdrAll = result;
				console.log(vdrAll);
				vdrGrid.resetData(result);
				console.log(vdrAll);
			}
		})
	}
	let ordDtlForm;
	$('#addRow').on('click', function () {
		
		orderGrid.uncheckAll();
		$('#ordreg2').prop('disabled',false);
		//orderGrid 수정체크 
		if(pageStatus=='register'){
				Swal.fire({
				icon: "error",
				title: "error",
				text: "주문 등록을 완료해주세요"
			})
			return;
		}	
		pageStatus='register';
		//행추가할 데이터 생성
		let addRow = {}
		let addDtlRow={}
		orderGrid.prependRow(addRow);
		ordDtlGrid.resetData([{}]); //행추가 할 경우 디테일그리드에 행이 기본으로 하나 추가됨 
		const rowCount = orderGrid.getRowCount(); // 전체 행 수
		const newRow = orderGrid.getRow(rowCount - 1); // 마지막 행 데이터
	
		newOrdPlus = newRow.rowKey; //새로추가된 행번호 정의

		orderGrid.refreshLayout();
		orderGrid.check(newOrdPlus); //새로추가된 행에 체크
	
		orderGrid.setValue(newOrdPlus, "createdDate", dateformatyymmdd(new Date()));
		orderGrid.setValue(newOrdPlus, "status", "ost01");
	//	orderGrid.setValue(newOrdPlus,"ordCode",nextordCode); //nextordCode
	})
	$('#deleteRow').on('click', function () {

	const checkedRows = orderGrid.getCheckedRows();
		//console.log('행삭제',checkedRows)
		if(checkedRows.length==0){
			Swal.fire('실패','삭제할 주문건을 선택해주세요','error');
			return;
		}		


	//주문삭제할 경우 출하요청이 완료된 상품일 경우 경고창 띄우기 	
	 if(orderGrid.getData()[orderGrid.getCheckedRowKeys()[0]].status=='ost02'||orderGrid.getData()[orderGrid.getCheckedRowKeys()[0]].status=='ost03' ){
		 Swal.fire('실패','이미 출하요청된 주문건입니다','error');
			return;
		} 
		//체크된행을 가져오는 함수	
	


		checkedRows.forEach(item => {
			//console.log(item.ordCode);
			if (item.status != 'ost03') { //출고완료 된건이 아닌것만 삭제가능  
				orderGrid.removeRow(item.rowKey);
				$.ajax({
					url: "/erp/sales/ord/delete?ordCode=" + item.ordCode, // URL에 ordCode를 파라미터로 추가
					method: "DELETE",
					success: function (result) {
							Swal.fire({
										title: "삭제완료!",
										icon: "success",
										draggable: true
						});
					}
				});
			} 
		})

		ordDtlGrid.resetData([]);
	})
	//주문상세 행추가 반영 
	$('#addRowdtl').on('click', function () {
	//	orderGrid.uncheckAll(); 
		let addDtlrow = {} //		
		ordDtlGrid.appendRow(addDtlrow); //
		ordDtlGrid.refreshLayout(); //
	})
	//새로운행번호 선언
	ordDtlGrid.on('click', (ev) => {
		newNo = ordDtlrowNo(ev.rowKey); //ordDtlrow 
		ev.columnName == 'itemCode' ? openItemmodal() : console.log('아이템모달안열림');
		const checkedRows = ordDtlGrid.getCheckedRowKeys();
	
	})
	$('#ordreg2').on('click', function () {
		let regHeader =orderGrid.getModifiedRows().createdRows[0]; //체크표시 굳이 안해도 주문등록가능  

		if(regHeader==null){
			Swal.fire({
				icon: "error",
				title: "error",
				text: "주문건을 추가하시오"
			});
			return;
		}
		// ❗ 주문 헤더 유효성 검사
		if (!regHeader.vdrCode || !regHeader.payMethod || !regHeader.status) {
			Swal.fire({
				icon: "error",
				title: "error",
				text: "필수항목기입하시오"
			});
			return;
		}
		//여신잔액이 없는경우
		if (regHeader.creditBalPrice <= regHeader.totPrice) {
			Swal.fire({
				icon: "error",
				title: "error",
				text: "여신잔액이 부족합니다"
			});
			return;
		}
		let itemNull; 
		if(ordDtlGrid.getData().length>0){ //ordDtlGrid getData 
				for(let i=0;i<ordDtlGrid.getData().length;i++){
						if(ordDtlGrid.getData()[i].itemCode==null ||ordDtlGrid.getData()[i].name==null||ordDtlGrid.getData()[i].quantity==null){
							 itemNull='y'; 	
						}
				}		
		}
		if(itemNull=='y'){
			Swal.fire({
				icon: "error",
				title: "error",
				text: "주문디테일을 선택해주세요"
			});
			return;
		}

				
		let noItemCode; 
	//console.log('ordDtlGrid 주문등록버튼=>',ordDtlGrid.getData()[0].itemCode); 새로 생성된 행이 있을경우 
	if(ordDtlGrid.getModifiedRows().createdRows){	
			for(let i=0; i<ordDtlGrid.getModifiedRows().createdRows.length;i++){

				if(!ordDtlGrid.getModifiedRows().createdRows[i].itemCode){
					 noItemCode='y'; 
				}

			}
			if(noItemCode=='y'){
			Swal.fire({
					icon: "error",
					title: "error",
					text: "주문할 상품을 선택하시오"
				});
				return;
			}
}

		const dtlObj = ordDtlGrid.getModifiedRows(); 
		let totSup=0; 
		let totVat=0; 
		let totDisc=0;
		let qty=0; 
		for(let i=0; i<dtlObj.createdRows.length;i++ ){
			totSup+=dtlObj.createdRows[i].supPrice; //총 공급가액 
			totVat+=dtlObj.createdRows[i].vatPrice; //총부가세
			totDisc+=dtlObj.createdRows[i].discPrice; // 총할인금액	
			qty+=Number(dtlObj.createdRows[i].quantity); //총수량  
		}

		for(let i=0; i<dtlObj.updatedRows.length;i++ ){
			totSup+=dtlObj.updatedRows[i].supPrice; //총 공급가액 
			totVat+=dtlObj.updatedRows[i].vatPrice; //총부가세
			totDisc+=dtlObj.updatedRows[i].discPrice; // 총할인금액	
			qty+=Number(dtlObj.updatedRows[i].quantity); //총수량  
		}

			regHeader.totSupPrice=totSup;
			regHeader.totVatPrice=totVat; 
			regHeader.totDisc=totDisc; 
			regHeader.totQuantity=qty; 
 
		const dataToSend = {
			ord: regHeader, // 일반 객체 {}
			dtl: dtlObj     // [{},{}]
		};
	
		$.ajax({
			url: '/erp/sales/ord/register',
			type: 'POST',
			contentType: 'application/json',
			data: JSON.stringify(dataToSend),
			success: function (res) {
				console.log('전송 성공', res);
				Swal.fire({
					title: "주문등록성공!",
					icon: "success",
					draggable: true
				});
				mainList();
				ordDtlGrid.resetData([]); 
			}
		})

		pageStatus='search';


	})
	//주문 상세 저장
	$('#saveRowdtl').on('click', function(){
		//validation 체크 
		let test = ordDtlGrid.getData();
		let updHeader = orderGrid.getCheckedRows()[0]; //납기일자,지불방식 {ordCode:"ord-129",payMethod:"opm01"}
		if(updHeader.status=='ost02' ||updHeader.status=='ost03'){
  	Swal.fire({
				icon: "error",
				title: "error",
				text: "출고진행 중이므로 수정이 불가능합니다"
			})
			return; 
}
		//유효성 체크 
		$.each(test, (idx, item) => {
			if (item.itemCode == null || item.quantity == null) {
				Swal.fire({
					title: "필요항목을 모두입력하세요!",
					icon: "error",
					draggable: true
				});
				return false;
			}
		})
		if(orderGrid.getCheckedRows()[0].status=='ost03'){
			Swal.fire({
					title: "이미 출하완료 된 건입니다",
					icon: "error",
					draggable: true
				});
				return false;
		}

		dtlObj=ordDtlGrid.getModifiedRows(); //{createdRows:[{ },{ },{ }],        }
		for(let i=0; i<dtlObj.createdRows.length;i++){
			dtlObj.createdRows[i].ordCode=
			orderGrid.getCheckedRows()[0].ordCode;
		}
		regHeader =orderGrid.getCheckedRows()[0]; 
	
		const dataToSend = {
			ord: regHeader, // 일반 객체
			dtl: dtlObj
		};

		$.ajax({
			url: '/erp/sales/ord/regDtl',
			type: 'POST',
			contentType: 'application/json',
			data: JSON.stringify(dataToSend),
			success: function (res) {
				console.log('전송 성공', res);
				Swal.fire({
					title: "저장성공!",
					icon: "success",
				draggable: true
				});
				mainList();
				ordDtlGrid.resetData([]); 
			}
		})	
		orderList();
		
	})
	//주문 수정
	$('#ordupd').on('click', function () {

	

		//updHeader.updateId = userID; //update
		$.ajax({
			url: '/erp/sales/ord/update',
			type: 'PUT',
			contentType: 'application/json',
			data: JSON.stringify(updHeader),
			success: function (res) {
			
				Swal.fire({
					title: "주문수정성공!",
					icon: "success",
					draggable: true
				});
				orderList();
				orderGrid.uncheckAll();
				ordDtlGrid.resetData();
			}
		})
	})


	$('#delRowdtl').on('click', function () {
			let info = ordDtlGrid.getCheckedRows(); // [ ]
			let header=orderGrid.getCheckedRows()[0]; 
			if(header.status=='ost02' ||header.status=='ost03'){
					Swal.fire({
				icon: "error",
				title: "error",
				text: "출고가 진행중입니다"
			})
			return; 
			}
			const checkedRows = ordDtlGrid.getCheckedRows();
			//행삭제
			checkedRows.forEach(item => {
		    ordDtlGrid.removeRow(item.rowKey)
		  })
			if(pageStatus=='search'){
			$.ajax({
				url: '/erp/sales/ord/delOrdDtl', 
				type: 'DELETE',
				contentType: 'application/json',
				data: JSON.stringify(info),
				success: function (res) {
					
						Swal.fire({
							title: "주문삭제성공!",
							icon: "success",
							draggable: true
						});
						orderList();
					},
				error: function (err) {
						console.error('에러 발생', err);
					}
				})
			}
		})
	//주문dtl 수정하기 
	// $('#modRowdtl').on('click', function () {
	// 	let updDtl = ordDtlGrid.getCheckedRows()[0]; //체크된 행을 수정함 단건수정^^ 
	// 	updDtl.comId = userComId;
	// 	updDtl.quantity = Number(updDtl.quantity);
	// 	updDtl.totPrice = updDtl.totprice;
	
	// 	updDtl.ordCode=orderGrid.getCheckedRows()[0].ordCode; //주문번호 체크 
	// 	updDtl.vatPrice=(ordDtlGrid.getCheckedRows()[0].supPrice)/10; //부가세 설정 
	// 	updDtl.totPrice=ordDtlGrid.getCheckedRows()[0].supPrice+
	// 									ordDtlGrid.getCheckedRows()[0].vatPrice
	// 									-ordDtlGrid.getCheckedRows()[0].discPrice;
		
	
	
	// 	ordDtlGrid.setValue(updDtl.rowkey, "ordCode", orderGrid.getCheckedRows()[0].ordCode);
	// 	console.log('updDtl=>', updDtl);

	// 	$.ajax({
	// 		url: '/erp/sales/ord/updDtl',
	// 		type: 'PUT',
	// 		contentType: 'application/json',
	// 		data: JSON.stringify(updDtl),
	// 		success: function (res) {

	// 			Swal.fire({
	// 				title: "주문수정성공!",
	// 				icon: "success",
	// 				draggable: true
	// 			});
	// 			ordDtlGrid.uncheckAll();
	// 		},
	// 		error: function (err) {
	// 			console.error('에러 발생', err);
	// 		}
	// 	});
	// })
	//[1:{}] 
	//ordDtlRow의 수량 입력시 총금액,공급가액,부가세 계산되어 자동입력됨 
	ordDtlGrid.on('afterChange', ev => {
	
		console.log('ev.changes[0].rowKey',ev.changes[0].rowKey);
		if(pageStatus=='register'){
				vdrdiscount=(orderGrid.getModifiedRows().createdRows[0].discount)/100
		} //0.12
		else if(pageStatus=='search'){
			//
			vdrdiscount=(orderGrid.getCheckedRows()[0].discount)/100;
		}

		let supPrice = (ev.changes[0].value * ordDtlGrid.getRow(ev.changes[0].rowKey).price)*(1-vdrdiscount);  
		let discPrice = (ev.changes[0].value * ordDtlGrid.getRow(ev.changes[0].rowKey).price)*(vdrdiscount); //할인가격 거래처정보 불러온뒤 계산 반영	

		console.log('supPrice,discPrice',supPrice,discPrice);
		if (ev.changes[0].columnName == 'quantity') { //바뀐행의 열이 quantity 일때  
			ordDtlGrid.setValue(ev.changes[0].rowKey, "supPrice", supPrice); //공급가액의 가격을 (수량*가격) 으로 바꿈
			ordDtlGrid.setValue(ev.changes[0].rowKey, "vatPrice", supPrice / 10); //부가세를 넘김
			ordDtlGrid.setValue(ev.changes[0].rowKey, "totPrice",  supPrice+supPrice/10); //총가격  
			ordDtlGrid.setValue(ev.changes[0].rowKey, "discPrice", discPrice); //할인금액
			orderTotprice.set(ev.changes[0].rowKey,supPrice+supPrice/10);
			console.log('ordDtlGrid.getData()', ordDtlGrid.getData());
			let total = Math.floor(ordDtlGrid.getData().reduce((sum, row) => sum + (row.totPrice || 0), 0));
			
			if(pageStatus=='search'){
				orderGrid.setValue(orderGrid.getCheckedRows()[0].rowKey, "totPrice", total);
			}else if(pageStatus=='register'){
				orderGrid.setValue(orderGrid.getModifiedRows().createdRows[0].rowKey,"totPrice",total);
			}	
		}
	})
	//모달 객체 선언 
	var modalToggle = document.getElementById('exampleModalToggle')
	var myModal = new bootstrap.Modal(modalToggle, {
		keyboard: false
	})
	//jquery로 바꿔준후  
	$(modalToggle).on('shown.bs.modal', function (e) {
		itemGrid.refreshLayout();
	})
	var myModalEl = document.getElementById('myModal')
	myModalEl.addEventListener('hidden.bs.modal', function (event) {
		// do something...
	})
	//vdrmodal 객체를 가져옴 
	var vdrmodalToggle = document.getElementById('vdrModal');
	var vdrmymodal = new bootstrap.Modal(vdrmodalToggle, {
		keyboard: false
	});
	$(vdrmodalToggle).on('shown.bs.modal', function (e) {
		vdrGrid.refreshLayout(); //
	})
	var vdrmyModalEl = document.getElementById('vdrmymodal') //여기서  
	vdrmyModalEl.addEventListener('hidden.bs.modal', function (event) {
		// do something...
	})
	//아이템정보를 돌려주는 함수,모달버튼 닫으면 원래 내가 선택한행의 빈칸에  
	function itemInfo(itemCode, name, price) {
		//console.log('itemInfo함수호출',itemCode,name,price); 
		return [itemCode, name, price];
	}
	//행번호 전달하는 함수 
	function ordDtlrowNo(rowNo) {
		newOrdRowNo = rowNo;
		return newOrdRowNo;
	}
	//모달띄우는함수모음 //아이템모달
	function openItemmodal() {
		myModal.show(modalToggle);
	}

	function openVdrmodal() { //거래처모달 띄우는함수 
		vdrmymodal.show(vdrmodalToggle);
	}
	//날짜 포맷바꾸는 함수 Sun May 30 2021 15:47:29 GMT+0900 (대한민국 표준시) => yyyy-MM-dd 
	function dateformatyymmdd(today) {
		var today = today;
		var year = today.getFullYear();
		var month = ('0' + (today.getMonth() + 1)).slice(-2);
		var day = ('0' + today.getDate()).slice(-2);
		var dateString = year + '-' + month + '-' + day;
		return dateString;
	}
	//  
	function hyphenToSlash(dateStr) {
		if (typeof dateStr !== 'string') return '';
		return dateStr.replace(/-/g, '/');
	}

	function getdtlplusInfo(item) { //getdtlplusInfo 
		const info = ordDtlGrid.getRow(item);
		return info;
	}
	function getOrdHeadplusInfo(newNo) {
		const info = orderGrid.getRow(newNo);
		return info;
	}
		const topOptions = {
			  includeHiddenColumns: true,
			  onlySelected: false,
			  fileName: '주문 정보 조회',
			};
	$('#excel').on('click',function(){
		 orderGrid.export('xlsx',topOptions); 
	})
	function formatItemType(status){
			for(let i=0;i<itemType.length;i++){
				if(itemType[i].subCode==status){
					return itemType[i].subName;
				}
			}
	}
  orderGrid.on('editingStart', ev => {

  const readOnlyFields = [ 'creditPrice', 'creditBalPrice'];  //
  const row = orderGrid.getRow(ev.rowKey);
  
    // 구분값이 'vt02'인 경우 특정 컬럼 편집 막기
    if (row.type === 'vt02') {
    
      if (readOnlyFields.includes(ev.columnName)) {
        Swal.fire('실패','여신정보 변경이 불가능합니다','error');
        return;
        ev.stop(); // 편집 막기
      }
    }
 
});


	//주문등록 할때 이거 주석처리 하면 안넘어감;; 

	//  const userID = [[${#authentication.principal != 'anonymousUser' ? #authentication.principal.userId : 'c1005'}]];
	//  const userName = [[${#authentication.principal != 'anonymousUser' ? #authentication.principal.empName : '정은애'	}]];
	//  const userComId = [[${#authentication.principal != 'anonymousUser' ? #authentication.principal.comId : 'com-101'	}]];
//	console.log(userID, userName, userComId);
</script>
</html>
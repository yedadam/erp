<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
    <style>
        .main-table {
            border: 2px solid #0d6efd;
        }
        .main-table th {
            background-color: #e3f2fd;
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            border: 1px solid #ddd;
        }
        .main-table td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid #ddd;
        }
        .detail-table {
            margin-top: 20px;
        }
        .detail-table th {
            background-color: #f8f9fa;
            text-align: center;
            font-size: 14px;
            padding: 8px;
        }
        .detail-table td {
            text-align: center;
            font-size: 14px;
            padding: 8px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .btn-group-custom {
            margin-bottom: 20px;
        }
        .tui-pagination{
        	padding-bottom:10px;
				}  
	   .start-action {
			display: inline-block;
	padding: 3px 8px;
	font-size: 12px;
	border-radius: 12px;
	border: 1px solid #facc15;        /* ì—°í•œ ë…¸ë‘ */
	background-color: #fefce8;        /* ì—°ë…¸ë‘ ë°°ê²½ */
	color: #92400e;                   /* ì§„í•œ ì£¼í™©ê°ˆìƒ‰ */
		}
		.end-action {
	display: inline-block;
	padding: 3px 8px;
	font-size: 12px;
	border-radius: 12px;
	border: 1px solid #22c55e;        /* ì—°ì´ˆë¡ */
	background-color: #ecfdf5;        /* ì•„ì£¼ ì—°í•œ ë¯¼íŠ¸ */
	color: #065f46;                   /* ì§„í•œ ì´ˆë¡ */
		}
	 .del-action {
	display: inline-block;
	padding: 3px 8px;
	font-size: 12px;
	border-radius: 12px;
	border: 1px solid #f87171;        /* ì—°í•œ ë¹¨ê°• */
	background-color: #fef2f2;        /* ì•„ì£¼ ì—°í•œ ë¹¨ê°• */
	color: #991b1b;                   /* ì§„í•œ ë¹¨ê°• */
		}
		 .middle-action {
	display: inline-block;
	padding: 3px 8px;
	font-size: 12px;
	border-radius: 12px;
	border: 1px solid #f87171;        /* ì—°í•œ ë¹¨ê°• */
	background-color: darksalmon;        /* ì•„ì£¼ ì—°í•œ ë¹¨ê°• */
	color: #991b1b;                   /* ì§„í•œ ë¹¨ê°• */
		}	

		
	.require{
		color :red;
		font-weight: bold;
	}
	.require.complete {
	color: #198754; /* Bootstrap success green */
	font-weight: bold;	
	}
	.require.partial {
	color: #fd7e14; /* ì£¼í™©ìƒ‰ */
	font-weight: bold;
}
	.row-selected {
    	background-color: #e6f2ff !important;
  	}


</style>
</head>
<!--ì¶œí•˜ê´€ë¦¬ html ì›ë³¸   -->
<body class="bg-light">
    <div class="container-fluid mt-4">
        <h3 class="mb-4">ì¶œí•˜ì˜ë¢°</h3>
        
        <!-- ê²€ìƒ‰ ë° ë²„íŠ¼ ì˜ì—­ -->
      <!-- ğŸ“¦ ì¶œí•˜ì˜ë¢° ì¡°ê±´ + ë²„íŠ¼ ì¹´ë“œ -->
		<!-- ğŸ” ê²€ìƒ‰ ë°•ìŠ¤ -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      
      <!-- ê²€ìƒ‰ ì¡°ê±´ -->
      <div class="col-md-4">
        <label for="shipReqSelect" class="form-label">ê²€ìƒ‰ ì¡°ê±´</label>
        <div class="input-group">
          <select class="form-select" id="shipReqSelect" style="max-width: 40%;">
            <option value="shipReqCode" selected>ì¶œí•˜ì˜ë¢°ì½”ë“œ</option>
            <option value="vdrName">ê±°ë˜ì²˜ëª…</option>
            <option value="vdrCode">ê±°ë˜ì²˜ì½”ë“œ</option>
            <option value="ordCode">ì£¼ë¬¸ì½”ë“œ</option>
          </select>
          <input type="text" class="form-control" id="shipReqInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
        </div>
        <ul id="autoShipReqList"
          class="list-group position-absolute w-100 shadow-sm"
          style="top: 100%; z-index: 1050; max-height: 200px; overflow-y: auto; display: none;">
        </ul>
      </div>

      <!-- ì¶œê³ ì˜ˆì •ì¼ -->
      <div class="col-md-3">
        <label class="form-label">ì¶œê³ ì˜ˆì •ì¼ì</label>
        <div class="d-flex gap-2">
          <input type="date" id="shipExpStartDate" class="form-control">
          <input type="date" id="shipExpEndDate" class="form-control">
        </div>
      </div>

      <!-- ì§„í–‰ ìƒíƒœ -->
      <div class="col-md-3">
        <label class="form-label d-block">ì§„í–‰ ìƒíƒœ</label>
        <div class="d-flex gap-2 flex-wrap">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="shipReqStatus" id="statusAll" value="" checked>
            <label class="form-check-label" for="statusAll">ì „ì²´</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="shipReqStatus" id="status1" value="srq01">
            <label class="form-check-label" for="status1">ì¶œí•˜ì˜ë¢°</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="shipReqStatus" id="status2" value="srq02">
            <label class="form-check-label" for="status2">ë¶€ë¶„ì¶œê³ </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="shipReqStatus" id="status3" value="srq03">
            <label class="form-check-label" for="status3">ì¶œí•˜ì™„ë£Œ</label>
          </div>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
      <div class="col-md-2 d-flex justify-content-end">
        <button class="btn btn-primary w-100" id="searchButton">
          <i class="fas fa-search"></i> ê²€ìƒ‰
        </button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹ -->
<div class="d-flex justify-content-end gap-2 mb-3">
  <button class="btn btn-dark" id="newBtn">
    <i class="fas fa-pen"></i> ì¶”ê°€
  </button>
  <button class="btn btn-warning" id="searchBtn">
    <i class="fas fa-eye"></i> ì¡°íšŒ
  </button>
  <button class="btn btn-danger" id="delBtn">
    <i class="fas fa-trash"></i> ì‚­ì œ
  </button>
  <button class="btn btn-primary" id="saveBtn">
    <i class="fas fa-save"></i> ì €ì¥
  </button>
</div>
</div>


        <!-- ë©”ì¸ í…Œì´ë¸” -->
     
            <!-- ê·¸ë¦¬ë“œ -->
            <div id="mainGrid"></div>
  

        <!-- ìƒì„¸ ì •ë³´ í…Œì´ë¸” -->

             <!-- <div class="text-end">
                <div class="btn-group-custom">
                	<button class="btn btn-primary me-2" id="rowAddBtn">
                        í–‰ì¶”ê°€
                    </button>
                    <button class="btn btn-danger me-2" id="rowDelBtn">
                       í–‰ì‚­ì œ
                    </button>
                </div>
            </div> -->
                <div id="detailGrid"></div>
    </div>
  <!-- ì£¼ë¬¸ ëª¨ë‹¬ -->
	<div class="modal fade" id="requestModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="exampleModalLabel">ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="container-fluid">
							<!-- ê²€ìƒ‰ ì¡°ê±´ -->
						<div class="position-relative mb-3" style="max-width: 500px;">
						    <div class="input-group">
						        <select class="form-select col-4" id="ordSelect" style="max-width: 30%;">
						            <option value="ordCode" selected>ì£¼ë¬¸ì½”ë“œ</option>
						            <option value="vdrName">ê±°ë˜ì²˜ëª…</option>
									<option value="vdrCode">ê±°ë˜ì²˜ì½”ë“œ</option>
						        </select>
						        <input type="text" class="form-control" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" id="ordInput" autocomplete="off">
						        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
						            <i class="fas fa-search"></i>
						        </button>
						    </div>
						    <!-- ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ -->
						    <ul id="autoOrdList"
						        class="list-group position-absolute w-100 shadow-sm"
						        style="top: 100%; z-index: 1050; max-height: 200px; overflow-y: auto; display: none;">
						    </ul>
						</div>
						<!--ê²€ìƒ‰ì°½ ë-->			
						<div id="requestGrid"></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<!-- ê±°ë˜ì²˜ ëª¨ë‹¬-->
	<div class="modal fade" id="vdrModal" tabindex="-1"
		aria-labelledby="vdrModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="vdrModalLabel">ê±°ë˜ì²˜ ë¦¬ìŠ¤íŠ¸</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="container-fluid">
						<div id="vdrGrid"></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Close</button>

				</div>
			</div>
		</div>
	</div>
	<!--ì°½ê³ ëª¨ë‹¬-->	
	<!--ã„´ã…‡ã„¹ã„´ã…‡ã„¹ã…‡ã„´ã„¹-->
	<div class="modal fade" id="warehouseModal" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="exampleModalLabel">ì°½ê³  ë¦¬ìŠ¤íŠ¸</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="container-fluid">
						<div id="warehouseGrid"></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
<!-- div í•˜ë‚˜ ì—†ìŒ....-->


	<script th:inline="javascript">
	//ì„¸ì…˜
	// let empId = 'emp-101';
	// let empName = 'ì˜ˆë‹´'; 
	let maxShipReqNO; 
	var mainStatus = /*[[${mainStatus}]]*/ [];
	var dtlStatus = /*[[${dtlStatus}]]*/ [];   
	var ordStatus = /*[[${ordStatus}]]*/ [];  	

	//í•„ìˆ˜ê°’ ê°€ì ¸ì˜¤ê¸°
	function getName(name){
		const header = document.createElement('span');
		header.innerHTML=`<span class="require">* </span>${name}`
		return header;
	}

	$('#ordInput').on('keyup',ev => {
		 setupAutocomplete({
			    inputSelector: '#ordInput',                              //ì¸í’‹ì— ê²ìƒ‰ê°’
			    selectSelector: $('#ordSelect  option:selected').val(),  //selected ê²°ê³¼ê°’
			    listSelector: '#autoOrdList',                            //ìë™ì™„ì„± ë˜ëŠ”ê°’ 
			    ajaxUrl: '/erp/sales/orderList'                     //ajaxurl
		 });
	});
	$('#ordInput').on('keyup',ev => {
		if(ev.keyCode ==13){
			let type = $("#ordSelect option:selected").val();
			let value = $("#ordInput").val();
			let url ='/erp/sales/orderList';
			let grid = requestGrid 
			commonSearch(type,value,url,grid);
		}
	})

	//
	$('#shipReqInput').on('keyup',ev => {
		 setupAutocomplete({
			    inputSelector: '#shipReqInput',                              //ì¸í’‹ì— ê²ìƒ‰ê°’
			    selectSelector: $('#shipReqSelect  option:selected').val(),  //selected ê²°ê³¼ê°’
			    listSelector: '#autoShipReqList',                            //ìë™ì™„ì„± ë˜ëŠ”ê°’ 
			    ajaxUrl: '/erp/sales/shipReqList'                     //ajaxurl
		 });
	});
	$('#shipReqInput').on('keyup',ev => {
		if(ev.keyCode ==13){
			let type = $("#shipReqSelect option:selected").val();
			let value = $("#shipReqInput").val();
			let url ='/erp/sales/shipReqList';
			let grid = mainGrid 
			commonSearch(type,value,url,grid);
		}
	})

        // ë©”ì¸ê·¸ë¦¬ë“œ
		 let  mainGrid = new tui.Grid({
            // toastui ì•„ì´ë”” ê°€ì ¸ì˜¤ê¸°
            el: document.getElementById('mainGrid'),
            scrollX: false,
            scrollY: false,
            // checkbox ë¶€ì—¬
            rowHeaders: ['checkbox'],
            // í˜ì´ì§€ë„¤ì´ì…˜
            pageOptions: {
                perPage: 5,
                useClient: true,
            },
            // í•„ë“œê°’ êµ¬ì„±
            columns: [
                {header: 'ì‚¬ì›', name: 'empId', align: 'center', editor: 'text'},
								{header: 'íšŒì‚¬ID', name: 'comId', align: 'center', editor: 'text'},
                {header: 'ì¶œí•˜ì˜ë¢°ì½”ë“œ', name: 'shipReqCode', align: 'center',customHeader:getName('ì¶œí•˜ì˜ë¢°ì½”ë“œ')},
                {header: 'ê±°ë˜ì²˜ì´ë¦„', name: 'vdrName', align: 'center',customHeader:getName('ê±°ë˜ì²˜ì´ë¦„')},
                {header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'vdrCode', align: 'center'},
                {header: 'ì¶œê³ ì˜ˆì •ì¼ì', name: 'shipExpDate', align: 'center', editor: 'datePicker',customHeader:getName('ì¶œê³ ì˜ˆì •ì¼ì')},
                {header: 'ì´ê¸ˆì•¡í•©ê³„', name: 'totPrice', align: 'right', 
                		formatter: function(price){return priceFormat(price.value)+'ì›';},},
                {header: 'ìƒíƒœ', name: 'status', align: 'center',
						formatter:function(status){return headstatus(status.value)}
				},
				{header: 'ì£¼ë¬¸ë²ˆí˜¸', name: 'ordCode', align: 'center'},
				{header: 'ë“±ë¡ì¼ì', name: 'createdDate', align: 'center'}
            ],
        });
        // ìƒì„¸ê·¸ë¦¬ë“œ
        const detailGrid = new tui.Grid({
            // toastui ì•„ì´ë”” ê°€ì ¸ì˜¤ê¸°
            el: document.getElementById('detailGrid'),
            scrollX: false,
            scrollY: false,
            // checkbox ë¶€ì—¬
            rowHeaders: ['checkbox'],  
            // í•„ë“œê°’ êµ¬ì„±
            columns: [
                {header:'ì¶œí•˜ì˜ë¢°ìƒì„¸ì½”ë“œ', name: 'shipReqDtlCode', align: 'center', width: 120},
                {header:'í’ˆëª©ì½”ë“œ', name: 'itemCode', align: 'center', width: 120},
                {header:'í’ˆëª©ì´ë¦„', name: 'name', align: 'center',customHeader:getName('í’ˆëª©ì´ë¦„')},
                {header:'ìˆ˜ëŸ‰', name: 'quantity', align: 'center',customHeader:getName('ìˆ˜ëŸ‰'),
                	formatter: function(quantity){return quantity.value+'ê°œ'; }, },
                {header:'ë‹¨ê°€', name: 'price', align: 'right',
									formatter: function(price){	return priceFormat(price.value)+'ì›';},		
                },
                {header:'ê³µê¸‰ê°€ì•¡', name: 'supPrice', align: 'right', 
									formatter: function(price){return priceFormat(price.value)+'ì›';},},
                {header:'ë¶€ê°€ì„¸', name: 'vatPrice', align: 'right', 
                	formatter: function(price){return priceFormat(price.value)+'ì›';},},
                {header:'í• ì¸ê¸ˆì•¡', name: 'discPrice', align: 'right', 
                	formatter: function(discPrice){  return discPrice.value+'ì›'; },},
								{header:'í•©ê³„ê¸ˆì•¡', name: 'totPrice', align: 'right', 
                	formatter: function(totPrice){ return priceFormat(totPrice.value)+'ì›';},},	
                {header:'ìƒíƒœ', name: 'status', align: 'center',
									formatter:function(status){return detailStatus(status.value)} },
				{header:'íšŒì‚¬ID', name: 'comId', align: 'center'},	
            ]
        });
        
        //ì£¼ë¬¸ì„œ ì˜ë¢° ê·¸ë¦¬ë“œ
        let  requestGrid = new tui.Grid({
            // toastui ì•„ì´ë”” ê°€ì ¸ì˜¤ê¸°
            el: document.getElementById('requestGrid'),
						pageOptions: {
						perPage: 10,
						useClient: true,
						},
            scrollX: false,
            scrollY: false,
            // í•„ë“œê°’ êµ¬ì„±
            columns: [
            {header:'ì£¼ë¬¸ì½”ë“œ', name: 'ordCode', align: 'center'},
						{header:'ê±°ë˜ì²˜ì½”ë“œ', name: 'vdrCode', align: 'center'},
						{header:'ê±°ë˜ì²˜ëª…', name: 'vdrName', align: 'center'},
        		{header:'ë“±ë¡ì¼ì', name: 'createdDate', align: 'center'},
        		{header:'ìƒíƒœ', name: 'status', align: 'center'},
                {header:'ì´ê³µê¸‰ì„¸',	name: 'totSupPrice',	align:'right',
				 		formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + 'ì›'},   
                {header:'ì´ë¶€ê°€ì„¸',	name: 'totVatPrice',	align:'right',
				    	formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + 'ì›'},
                {header:'ì´í• ì¸ê¸ˆì•¡',	name: 'totDisc',	align:'right',
				    	formatter: ({value}) => (value == null || value === 0) ? '' : value.toLocaleString() + 'ì›'},      
                {header:'ì´ê¸ˆì•¡í•©ê³„',	name: 'totPrice',	align:'right',
				     	formatter: ({ value }) => (value == null || value === 0) ? '' : value.toLocaleString() + 'ì›'},
				{header:'ë‚©ê¸°ì¼ì', name: 'reqDlvDate', align: 'center'}		  
            ]
        });
      //vdr ëª¨ë‹¬ì•ˆì—  vdrGrid ìƒì„±  
    	let vdrGrid=new tui.Grid({
    		el:document.getElementById('vdrGrid'),
    		pageOptions:{
    			perPage:10,
    			useClient: true, 
    		},
    		 columns:[
            	{header:'ê±°ë˜ì²˜ì½”ë“œ',name:'vdrCode',align:'center'},
            	{header:'ê±°ë˜ì²˜êµ¬ë¶„',name:'type',align:'center'}, 
            	{header:'ê±°ë˜ì²˜ëª…',name:'vdrName',align:'center'},
            	{header:'í• ì¸ìœ¨',name:'discount',align:'center',
            			formatter: function(discount){return discount.value+'%'; }
            	} 
            ]
    	})

		//ì¶œí•˜ì°½ê³  warehouseGrid
		let warehouseGrid=new tui.Grid({
				el:document.getElementById('warehouseGrid'),
				pageOptions:{
    			perPage:10,
    			useClient: true, 
    		},
			 columns:[
            	{header:'ì°½ê³ ì½”ë“œ',name:'whCode',align:'center'},
            	{header:'ì°½ê³ ì´ë¦„',name:'name',align:'center'}, 
            	{header:'ìœ„ì¹˜ì •ë³´',name:'locCode',align:'center'},
				{header:'ë©”ëª¨',name:'note',align:'center'}]	
		})

		warehouseGrid.on('click',ev=>{
			console.log('ì°½ê³ gridê°€ í´ë¦­ë¨');
			console.log(ev.targetType);
			console.log(ev.columnName); 
			console.log( warehouseGrid.getRow(ev.rowKey));
			console.log( warehouseGrid.getRow(ev.rowKey).locCode); 
			mainGrid.setValue(mainGrid.getCheckedRowKeys()[0]!=null?mainGrid.getCheckedRowKeys()[0]:0,
							  'whCode',
							  warehouseGrid.getRow(ev.rowKey).name); //ì°½ê³ ì´ë¦„ì„ ë„£ì–´ì¤Œ
			$('#warehouseModal').modal('hide');
		})	
      	//ê·¸ë¦¬ë“œ ìˆ¨ê¸°ê¸°
		mainGrid.hideColumn('empId');
		mainGrid.hideColumn('vdrCode');
		mainGrid.hideColumn('comId');  
		detailGrid.hideColumn('itemCode');      
		detailGrid.hideColumn('shipReqDtlCode'); //ì¶œí•˜ìƒì„¸ë²ˆí˜¸ 
		detailGrid.hideColumn('comId'); 
        // ë©”ì¸ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
        function mainList() {
    	  pageStatus= 'search'
    	  let searchBtn =$('#searchBtn');
    	  let newBtn = $('#newBtn'); 
    	  //ì¡°íšŒë²„íŠ¼ ë¹„í™œì„±í™”
    	  searchBtn.prop('disabled', true);
    	  //ì¶”ê°€ë²„íŠ¼ í™œì„±í™”
    	  newBtn.prop('disabled', false);    
            $.ajax({
                url: "/erp/sales/shipReqList",
                method: "GET",
                success: function(result) {
                    console.log('ì¶œí•˜ì˜ë¢°ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°', result);
                    mainGrid.resetData(result);
										maxShipReqNO='sr-'+String(Number(mainGrid.getData()[0].shipReqCode.substr(3))+1); 
										console.log('ì¶œí•˜ë²ˆí˜¸ ê°€ì¥í°ê±°=>',maxShipReqNO);
                    //ë””í…Œì¼ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
                    detailGrid.resetData([]);
                },
                error: function(xhr, status, error) {
                    console.log("ì‹¤íŒ¨:", xhr.status, error);
                }
            });
        }
      //ê¸ˆì•¡ í¬ë§· í•¨ìˆ˜('#,###')
        function priceFormat(price) {
        	if(price == null){
        		return '0';
        	}
        	let result = price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        	return result;
        }
		//ì£¼ë¬¸ì„œ ë¶ˆëŸ¬ì˜¬ë•Œ ìƒì„¸ 
		function ordDtlList(ordcode) {
			$.ajax({
					url: "/erp/sales/ordDtlList",
					method: "GET",
					data: {ordCode: ordcode},
					success: function(result){
							console.log('ì£¼ë¬¸ìƒì„¸=>',result)
							detailGrid.resetData(result);
						
						}
				})
		}
		//ì¶œí•˜ì˜ë¢° ìƒì„¸
		function shipReqDtlList(shipReqCode) {
			$.ajax({
					url: "/erp/sales/shipReqDtlList",
					method: "GET",
					data: {shipReqCode: shipReqCode},
					success: function(result){
							console.log('ì¶œí•˜ì˜ë¢°ìƒì„¸=>',result)
							detailGrid.resetData(result);
						}
			})
		} 
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë©”ì¸ ë¦¬ìŠ¤íŠ¸ í˜¸ì¶œ
        let pageStatus = "search";
        mainList();
        // ì‹ ê·œë²„íŠ¼ ì´ë²¤íŠ¸ ì²˜ë¦¬
        $('#newBtn').on('click', function(ev) {
        	pageStatus="add"
          let searchBtn =$('#searchBtn');
      	  let newBtn = $('#newBtn'); 
      	  //ì¡°íšŒë²„íŠ¼ í™œì„±í™”
      	  searchBtn.prop('disabled', false);
      	  //ì¶”ê°€ë²„íŠ¼ ë¹„í™œì„±í™”
      	  newBtn.prop('disabled', true);    
 	      	let data = mainGrid.getData();
        	//ê·¸ë¦¬ë“œ ì´ˆê¸°í™”ã…£
          mainGrid.resetData([{empId: empId,empName : empName}])
					console.log('í‚¤ë²ˆí˜¸',mainGrid.getData()[0].rowKey); 
					mainGrid.setValue(mainGrid.getData()[0].rowKey,"shipReqCode",maxShipReqNO); 
          detailGrid.resetData([{}]);       		
        });
		//ë©”ì¸ê·¸ë¦¬ë“œ í´ë¦­ RowKey
		let mainRowKey = null;
		let  selectedRowKey;

		mainGrid.on('click',ev => {

			if(pageStatus=='search'){
			 	shipReqDtlList(mainGrid.getData()[ev.rowKey].shipReqCode); //ìƒì„¸ì •ë³´ì¡°íšŒ
			}

			//í´ë¦­í•˜ë©´ ì²´í¬í•œ í–‰ìƒ‰ê¹” ë°”ë€œ 
			mainGrid.removeRowClassName(selectedRowKey,'row-selected'); 
			selectedRowKey=ev.rowKey; 
			mainGrid.addRowClassName(ev.rowKey,'row-selected'); 


			const checkedRows = mainGrid.getCheckedRowKeys();
			if (checkedRows.length > 1 || checkedRows[0] !== ev.rowKey) {
				mainGrid.uncheckAll(); // ì „ì²´ í•´ì œ
				mainGrid.check(ev.rowKey); // í˜„ì¬ í–‰ë§Œ ì²´í¬
				}			
		
			if (!ev.targetType || ev.targetType !== 'cell') {
			    // ì…€ì´ ì•„ë‹Œ ê³³ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ë¬´ì‹œ (ì²´í¬ ìƒíƒœ ë³€ê²½ ì•ˆí•¨)
			    return;
			  }
			if(ev.targetType=='cell' &&ev.columnName=='shipReqCode'&&ev.rowKey==0){
						requestModal(); //ëª¨ë‹¬ì´ì—´ë¦¼
			}
			mainRowKey = ev.rowKey;
			//ì¶œí•˜ì˜ë¢°ì½”ë“œ í´ë¦­ì‹œ
			if(ev.columnName == 'shipReqCode'){
					console.log(pageStatus)
					console.log('shipReqCode ì¹¼ëŸ¼ì´ ëˆŒë¦¼');
				if(pageStatus=='search'){
					return;
				}
			
				//ë¦¬í”Œë˜ì‰¬
			  $(requestModal).on('shown.bs.modal',e => {
        			requestGrid.refreshLayout();
        })
			}
		
		})
		//ì£¼ë¬¸ì˜ë¢° ëª¨ë‹¬ì°½
		function requestModal(){	
			$.ajax({
				url : "/erp/sales/orderList",
				method : "GET",
				success : function(result) {
					requestGrid.resetData(result);
				}
			})
			$('#requestModal').modal('show');
		}

		//ê±°ë˜ì²˜ ì—…ì²´ ëª¨ë‹¬ì°½
		function vdrModal(){
			$('#vdrModal').modal('show');
			$.ajax({
				url:"/erp/standard/venderAll",
				method:"GET",
				success:function(result){
					vdrGrid.resetData(result);
				}
			})
		}
		//ì°½ê³  ì„ íƒ ëª¨ë‹¬ 
		function warehouseModal(){
			$('#warehouseModal').modal('show');
			$.ajax({
				url:"/erp/inventory/warehouseList",
				method:"GET",
				success:function(result){
					warehouseGrid.resetData(result);
				}
			})
		}
		//ëª¨ë‹¬ ê·¸ë¦¬ë“œ í´ë¦­ì‹œ ë°œë™
		requestGrid.on('click', ev => {
			//í–‰í´ë¦­ì‹œ ë°œì£¼ì˜ë¢° ì½”ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
			let get = requestGrid.getRow(ev.rowKey).ordCode;
			//ë©”ì¸ê·¸ë¦¬ë“œ ì „ë‹¬
			//mainGrid.setValue(mainRowKey,'purReqCode',get);
			mainGrid.setValue(mainGrid.getCheckedRowKeys()[0]!=null?mainGrid.getCheckedRowKeys()[0]:0,'totPrice',requestGrid.getRow(ev.rowKey).totPrice);
			mainGrid.setValue(mainGrid.getCheckedRowKeys()[0]!=null?mainGrid.getCheckedRowKeys()[0]:0,'vdrCode',requestGrid.getRow(ev.rowKey).vdrCode);
			mainGrid.setValue(mainGrid.getCheckedRowKeys()[0]!=null?mainGrid.getCheckedRowKeys()[0]:0,'vdrName',requestGrid.getRow(ev.rowKey).vdrName);
			mainGrid.setValue(mainGrid.getCheckedRowKeys()[0]!=null?mainGrid.getCheckedRowKeys()[0]:0,'shipExpDate',requestGrid.getRow(ev.rowKey).reqDlvDate);						  
			mainGrid.setValue(mainGrid.getCheckedRowKeys()[0]!=null?mainGrid.getCheckedRowKeys()[0]:0,'createdDate',dateformatyymmdd(new Date())); //ë“±ë¡ì¼ìë¥¼ ì˜¤ëŠ˜ë‚ ì§œë¡œ ì„¤ì •
			mainGrid.setValue(mainGrid.getCheckedRowKeys()[0]!=null?mainGrid.getCheckedRowKeys()[0]:0,'ordCode',requestGrid.getRow(ev.rowKey).ordCode);//ì£¼ë¬¸ë²ˆí˜¸
			mainGrid.setValue(mainGrid.getCheckedRowKeys()[0]!=null?mainGrid.getCheckedRowKeys()[0]:0,'status',requestGrid.getRow(ev.rowKey).status); //ìƒíƒœ			
								  
			ordDtlList(requestGrid.getRow(ev.rowKey).ordCode); //ì£¼ë¬¸ìƒì„¸ì¡°íšŒí•˜ê³  ë‚œí›„ detailë¦¬ìŠ¤íŠ¸ì— resetdata ì²˜ë¦¬í•´ì¤Œ
			
		
			//ëª¨ë‹¬ ì§€ìš°ê¸°
			$('#requestModal').modal('hide');

		})
			
		//ê±°ë˜ì²˜ì½”ë“œ ì‹¤í–‰
		vdrGrid.on('click', ev => {
			console.log(ev);
			//ì—…ì²´ì½”ë“œ
			let vdrCode = vdrGrid.getRow(ev.rowKey).vdrCode;
			//ì—…ì²´ì´ë¦„
			let vdrName = vdrGrid.getRow(ev.rowKey).vdrName;
			//ë©”ì¸ê·¸ë¦¬ë“œë¡œ ì „ë‹¬
			//	mainGrid.setValue(mainRowKey,'vdrCode',vdrCode)
			//	mainGrid.setValue(mainRowKey,'vdrName',vdrName)
			
			$('#vdrModal').modal('hide');
		})
		
		//ìƒì„¸ê·¸ë¦¬ë“œ í–‰ì¶”ê°€
		$('#rowAddBtn').on('click', ev => {
			let mainRowIndex= mainGrid.getCheckedRowKeys()[0];
			console.log(mainRowIndex)
			if(pageStatus == 'search' && mainRowIndex ==undefined){
				Swal.fire('ì—ëŸ¬','ë©”ì¸ê·¸ë¦¬ë“œì— í•´ë‹¹í–‰ì„ í´ë¦­í•˜ì„¸ìš”','error')
				return;
			}
			if(pageStatus =='search'){
			  detailGrid.appendRow({purOrdCode : mainGrid.getRow(mainRowIndex).purOrdCode});
			}else if(pageStatus =='add'){
				detailGrid.appendRow({});		
			}
		})
		
		//ìƒì„¸ê·¸ë¦¬ë“œ í–‰ì‚­ì œ
		$('#rowDelBtn').on('click', ev => {
			//í´ë¦­ëœ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
			const checkedRows = detailGrid.getCheckedRows();
			console.log('ìƒì„¸ê·¸ë¦¬ë“œ heckedRows',checkedRows);
				let dataToSend = {
	    				head : mainGrid.getCheckedRows()[0], //{}   
	    				dtl : checkedRows    //[{},{}]
	    		};	
					if(head.status=='srq03'){
						 Swal.fire('ì‹¤íŒ¨','ì´ë¯¸ ì¶œí•˜ì™„ë£Œëœ ê±´ì…ë‹ˆë‹¤','error');
							 return; 
					}	
				$.ajax({
				url: '/erp/sales/shipReqDelDtl',
				type:'DELETE',
				contentType: 'application/json',
				data: JSON.stringify(dataToSend),
				success: function(res) {
	    		console.log('ì „ì†¡ ì„±ê³µ', res);
	    		Swal.fire({
	    					title: "ì¶œí•˜ìš”ì²­ì´ ì‚­ì œ ë˜ì—ˆìŠµë‹ˆë‹¤",
	    					icon: "success",
	    					draggable: true
	    				});
	    				mainList();
	    		},
				error: function(xhr, status, error) {
	          console.log("ì‹¤íŒ¨:", xhr.status, error);
	       }
			})				
		})
		$('#delBtn').on('click',ev =>{
			const head=mainGrid.getCheckedRows()[0]; //{}
			const detail=	detailGrid.getData(); //[{},{},{}]
			if(head.status=='srq03'){
			 Swal.fire('ì‹¤íŒ¨','ì´ë¯¸ ì¶œí•˜ì™„ë£Œëœ ê±´ì…ë‹ˆë‹¤','error');
							return; 
			}
			let dataToSend = {
	    			head :head, 		//{}   
	    			dtl : detail    //[{},{}]
	    		};
				$.ajax({
					url: '/erp/sales/shipReqDel',
					type:'DELETE',
					contentType: 'application/json',
					data: JSON.stringify(dataToSend),
					success: function(res) {
						console.log('ì „ì†¡ ì„±ê³µ', res);
						Swal.fire({
									title: "ì¶œí•˜ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",
									icon: "success",
									draggable: true
								});
								mainList();
						},
					error: function(xhr, status, error) {
							console.log("ì‹¤íŒ¨:", xhr.status, error);
					}
				})
		})

	





		//ë¼ë””ì˜¤ë²„íŠ¼ì²˜ëŸ¼ ì‘ë™
		mainGrid.on('click', ev => {		
		  const checkedRows = mainGrid.getCheckedRowKeys();
		  if (checkedRows.length > 1 || checkedRows[0] !== ev.rowKey) {
		    mainGrid.uncheckAll();
		    mainGrid.check(ev.rowKey);  // ì—¬ê¸°ì„œ check ì´ë²¤íŠ¸ëŠ” ë”°ë¡œ ì•ˆ ëœ¸ (ì •ìƒ)
		  }
		  console.log('ì„ íƒëœ row:', ev.rowKey);
		});
		
		//ë””í…Œì¼ í´ë¦­ ì¸ë±ìŠ¤
		let detailRowKey = null;		
		//ë””í…Œì¼ê·¸ë¦¬ë“œ í´ë¦­ì‹œ ë°œë™
		detailGrid.on('click', ev => {
			detailRowKey= ev.rowKey;
		   //ì•„ì´í…œë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° 
		console.log(detailGrid.getCheckedRows()); 
		})
		//ê¸ˆì•¡ ë³€í™˜
		function updateDetailPrice(rowKey) {
			const row = detailGrid.getRow(rowKey);
			//ê¸ˆì•¡
			const price = Number(row.price || 0);
			//ê°¯ìˆ˜
			const quantity = Number(row.quantity || 0);
			//ì´ê¸ˆì•¡ ê¸°ì…
			const totPrice = price * quantity;
			//ë¶€ê°€ì„¸
			const vatPrice = Math.floor(totPrice / 10);
			//ê³µê¸‰ê°€ì•¡
			const supPrice = totPrice - vatPrice;
	
			detailGrid.setValue(rowKey, 'totPrice', totPrice);
			detailGrid.setValue(rowKey, 'vatPrice', vatPrice);
			detailGrid.setValue(rowKey, 'supPrice', supPrice);
	}
    	//ì´ê¸ˆì•¡ê°’ ë°”ê¾¸ê¸°
		detailGrid.on('afterChange',ev => {
			//ìˆ˜ëŸ‰ì´ ë°”ë€”ì‹œ
			if(ev.changes[0].columnName=='quantity' ){
				
				//ê¸ˆì•¡ë Œë”ë§
				updateDetailPrice(ev.changes[0].rowKey);
				
				// ë‹¤ìŒ tickì—ì„œ ì´í•© ê³„ì‚°
				setTimeout(() => {
					const detailData = detailGrid.getData();

					let mainTotPrice = 0;
					let mainVatPrice = 0;
					let mainSupPrice = 0;

					detailData.forEach(item => {
						mainTotPrice += item.totPrice || 0;
						mainVatPrice += item.vatPrice || 0;
						mainSupPrice += item.supPrice || 0;
					});
					let mainKey = null;
					//ë“±ë¡ì¼ë•ŒëŠ” ì²´í¬ì—†ì–´ë„ ê°€ëŠ¥
					if(pageStatus == 'add'){
						mainKey = mainGrid.getCheckedRowKeys()[0] ?? 0;
					//ìˆ˜ì •ë°ì‚­ì œëŠ” ì²´í¬ê°€ ë¬´ì¡°ê±´ì ìˆì–´ì•¼í•¨
					}else if(pageStatus=='search'){
						mainKey = mainGrid.getCheckedRowKeys()[0]
					}
					mainGrid.setValue(mainKey, 'totSupPrice', mainSupPrice);
					mainGrid.setValue(mainKey, 'totVatPrice', mainVatPrice);
					mainGrid.setValue(mainKey, 'totAmtSum', mainTotPrice);
				}, 0);
			}
		})
	     //ë“±ë¡í•¨ìˆ˜
	     function shipReqAdd(){
	    	let mainGridInfo = mainGrid.getData(); //[{},{},{}]
	    	let detailGridInfo = detailGrid.getData(); //[{}]
	    		//ë©”ì¸ ê·¸ë¦¬ë“œ í•´ë‹¹ ê°’ì´ ê¸°ì…í–ˆëŠ”ì§€ ì²´í¬
	    	let mainResult = mainGridInfo.every(item => {
	    				
	    			return item.vdrName &&
	    			       item.shipExpDate &&
						   			item.ordCode	;
	    	})
	    		 //ë””í…Œì¼ ê°’ ìˆëŠ”ì§€ ì²´í¬
		    let detailResult = detailGridInfo.some(item => {
		    	return !item.itemCode || item.quantity ==0 ||
		    			       item.supPrice==0 || item.totPrice==0;
		    	})
		    	console.log(detailResult)
	    		//ê°’ ì²´í¬
	    		if(!mainResult){
	    		   Swal.fire('ì‹¤íŒ¨','ë©”ì¸ ê·¸ë¦¬ë“œì— ì…ë ¥ë€ë“¤ì„ ê¸°ì…í•˜ì„¸ìš”','error');
	    		   return;
	    		}else if(detailResult){
	    			Swal.fire('ì‹¤íŒ¨','ìƒì„¸ ê·¸ë¦¬ë“œì— ì…ë ¥ë€ë“¤ì„ ê¸°ì…í•˜ì„¸ìš”','error');
	    		   return;
	    		}
	    		
	    		//ë“±ë¡ë°ì´í„° ì •ë¦¬
	    		let mainData = mainGrid.getData(); // [{},{},{}]
	    		let detailData = detailGrid.getData(); //[{},{},{}]
	    		console.log(mainData);
	    		console.log(detailData);
	    		let dataToSend = {
	    				head : mainData[0], //{}   
	    				dtl : detailData    //[{},{}]
	    		};
	    		console.log(dataToSend)
					console.log(dataToSend);	
	    		//ë“±ë¡ajax
	    		$.ajax({
	    			url: '/erp/sales/shipReqAdd',
	    			type: 'POST',
	    			contentType: 'application/json',
	    			data: JSON.stringify(dataToSend),
	    			success: function(res) {
	    				console.log('ì „ì†¡ ì„±ê³µ', res);
	    							Swal.fire({
	    					title: "ì¶œí•˜ì˜ë¢°ì„±ê³µ!",
	    					icon: "success",
	    					draggable: true
	    				});
	    				mainList();
	    			},
	    			  error: function(xhr, status, error) {
	                      console.log("ì‹¤íŒ¨:", xhr.status, error);
	                }
	    		})
    	}
	     //ë²„íŠ¼í´ë¦­ì‹œ ë°œë™
	     $('#saveBtn').on('click',ev => {
	    	 //ì¶”ê°€ë²„íŠ¼ í´ë¦­ì‹œ
	    	 if(pageStatus == 'add'){
	    		 //ë“±ë¡í•¨ìˆ˜ë°œë™
	    		 shipReqAdd();
	    	 }
	    	 //ì¡°íšŒë²„íŠ¼í´ë¦­ì‹œ
	    	 if(pageStatus=='search'){
	    		 shipReqModify();
					 mainList();
	    	 }
	     })

			 //ì „ì²´ê²€ìƒ‰ë²„íŠ¼ ëˆŒë¦¼ 
	      $('#searchButton').on('click',ev => {
			// 	//mapìœ¼ë¡œ ë„˜ê¸¸ê°’ 
			 	let shipExpStartDate=document.getElementById('shipExpStartDate').value;
			 	let shipExpEndDate=document.getElementById('shipExpEndDate').value; 
			 	let type=$('#shipReqSelect  option:selected').val();  //type 
			 	let value=$("#shipReqInput").val();
			 	let status=document.querySelector('input[name="shipReqStatus"]:checked').value;
				console.log(shipExpEndDate,shipExpStartDate,type,value,status);	
			 	let url='/erp/sales/shipReqList'; 
			 	commonSearchObject({type,value,shipExpStartDate,shipExpEndDate,status},url,mainGrid);
					
	    })

	     
		 //ì£¼ë¬¸ì„œë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
		 $('#reqBtn').on('click',ev=>{
			requestModal(); 
		 })
		 
	     //ìˆ˜ì • í•¨ìˆ˜
	     async function shipReqModify(){
	    	 let checkedRows = detailGrid.getModifiedRows();
	    	 let mainRowIndex= mainGrid.getCheckedRowKeys()[0];
			 let mainRowData = mainGrid.getRow(mainRowIndex);

	    	 if( mainGrid.getCheckedRowKeys().length<1){
	    		 Swal.fire('ì‹¤íŒ¨','ë©”ì¸ê·¸ë¦¬ë“œì— í•´ë‹¹í•˜ëŠ” ê°’ì„ ì²´í¬í•´ì£¼ì„¸ìš”','error');
	    		 return;
	    	 }	
			if(mainRowData.status=='srq03'){
				Swal.fire('ì‹¤íŒ¨','ì´ë¯¸ ì¶œí•˜ì™„ë£Œëœ ê±´ì…ë‹ˆë‹¤','error');
				return;
			}	
			//ë©”ì¸ê·¸ë¦¬ë“œ í•´ë‹¹ë€ ë‹¤ìˆëŠ”ì§€ ì²´í¬
			if(mainRowData.vdrCode==null){
				Swal.fire('dddd','í•´ë‹¹í•˜ëŠ”ê°’ì„ ì…ë ¥í•´ã…‡ã…‡ã…‡ã…‡ì£¼ì„¸ìš”','error');
				return; 
			}
	    	 //ë©”ì¸ì°½
	    	 console.log('ìˆ˜ì •í•¨ìˆ˜ ì‘ë™ì¤‘',mainRowData)
	    	  await $.ajax({
	    		 url:'/erp/sales/shipReqMainModify',
	    		 method:'PUT',
	    		 contentType: "application/json",
	    		 data:JSON.stringify(mainRowData),
	    		 success :  Swal.fire('ì €ì¥','ì €ì¥ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.','success'),
				        		
			        error: function(xhr, status, error) {
	    			console.log("ì‹¤íŒ¨:", xhr.status, error);
	        		}
	    	   }) 
			}
		function dateformatyymmdd(today) {
		var today = today;
		var year = today.getFullYear();
		var month = ('0' + (today.getMonth() + 1)).slice(-2);
		var day = ('0' + today.getDate()).slice(-2);
		var dateString = year + '-' + month + '-' + day;
		return dateString;
	} 
	function headstatus(status){
		if(status=='srq01'){
				return `<span class="del-action">ì¶œí•˜ìš”ì²­</span>`
		}else if(status=='srq02') {
			return `<span class="middle-action">ë¶€ë¶„ì¶œê³ </span>`; 
		}else if(status=='srq03'){
			return `<span class="end-action">ì¶œí•˜ì™„ë£Œ</span>`
		}else{
			return status;
		} 
	}
	function detailStatus(status){
		if(status=='srd01'){
				return `<span class="del-action">ì¶œí•˜ì˜ë¢°</span>`
		}else if(status=='srd02') {
			return `<span class="middle-action">ë¶€ë¶„ì¶œê³ </span>`; 
		}else if(status=='srd03'){
			return `<span class="end-action">ì¶œí•˜ì™„ë£Œ</span>`
		}else if(status=='srd04'){
			return `<span class="middle-action">í™€ë“œì¤‘</span>`;
		} else{
			return status;
		} 
	}


	
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="Content">
<head>
    <title>ê¸‰ì—¬í•­ëª© ê´€ë¦¬</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.min.css">
    <!-- FontAwesome ì•„ì´ì½˜ CDN ì¶”ê°€ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .grid-action {
            display: inline-block;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 12px;
            border: 1px solid lightgray;
            background-color: aliceblue;
            color: darkslategray;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .grid-action:hover {
            background-color: lightsteelblue;
            border-color: silver;
            color: midnightblue;
        }
        .status-badge {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
  border: 1px solid #e2e8f0;
  letter-spacing: 0.5px;
  min-width: 56px;
  text-align: center;
}
.status-active {
  background: #e6f4ea;
  color: #1a7f37;
  border-color: #b7e4c7;
}
.status-inactive {
  background: #fbeaea;
  color: #c92a2a;
  border-color: #f5c2c7;
}
        #salaryItemGrid {
            width: 100%;
            min-width: 0;
            overflow-x: auto;
            box-sizing: border-box;
        }
        #salaryItemGrid .tui-grid-container {
            border-radius: 8px 8px 0 0 !important;
            overflow: hidden;
        }
    </style>
</head>
<body>
  <div class="container-fluid px-4">
    <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
    <h3 class="mb-3 text-secondary fw-bold border-bottom border-secondary pb-2">ê¸‰ì—¬í•­ëª© ê´€ë¦¬</h3>

    <!-- ê²€ìƒ‰/í•„í„° ì˜ì—­ -->
    <div class="card mb-3 rounded shadow-sm search-area">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <!-- ì¹´í…Œê³ ë¦¬ -->
          <div class="col-md-2">
            <label for="categoryFilter" class="form-label">ì¹´í…Œê³ ë¦¬</label>
            <select class="form-select" id="categoryFilter">
              <option value="">ì „ì²´</option>
              <option value="ê¸°ë³¸ê¸‰">ê¸°ë³¸ê¸‰</option>
              <option value="ìˆ˜ë‹¹">ìˆ˜ë‹¹</option>
              <option value="ë³µë¦¬í›„ìƒ">ë³µë¦¬í›„ìƒ</option>
              <option value="ìƒì—¬">ìƒì—¬</option>
              <option value="ê³µì œ">ê³µì œ</option>
            </select>
          </div>
          <!-- ê³¼ì„¸ì—¬ë¶€ -->
          <div class="col-md-2">
            <label for="taxFilter" class="form-label">ê³¼ì„¸ì—¬ë¶€</label>
            <select class="form-select" id="taxFilter">
              <option value="">ì „ì²´</option>
              <option value="Y">ê³¼ì„¸ëŒ€ìƒ</option>
              <option value="N">ë¹„ê³¼ì„¸</option>
            </select>
          </div>
          <!-- ê²€ìƒ‰ì–´ -->
          <div class="col-md-2">
            <label for="searchInput" class="form-label">ê²€ìƒ‰ì–´</label>
            <input type="text" class="form-control" id="searchInput" placeholder="í•­ëª©ëª… ë˜ëŠ” ì½”ë“œ ì…ë ¥">
          </div>
          <!-- ì§„í–‰ìƒíƒœ -->
          <div class="col-md-3">
            <label class="form-label d-block">ì§„í–‰ ìƒíƒœ</label>
            <div class="d-flex gap-2 flex-wrap">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="salaryStatus" id="statusAll" value="" checked>
                <label class="form-check-label" for="statusAll">ì „ì²´</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="salaryStatus" id="statusActive" value="Y">
                <label class="form-check-label" for="statusActive">í™œì„±</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="salaryStatus" id="statusInactive" value="N">
                <label class="form-check-label" for="statusInactive">ë¹„í™œì„±</label>
              </div>
            </div>
          </div>
          <!-- ê²€ìƒ‰ ë²„íŠ¼: í•­ìƒ ìš°ì¸¡ ë, ë²„íŠ¼ ë„ˆë¹„ col-md-2ë¡œ í†µì¼ -->
          <div class="col-md-2 d-flex align-items-end ms-auto justify-content-end">
            <button class="btn btn-primary w-100" id="searchBtn"><i class="fas fa-search"></i> ê²€ìƒ‰</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ë²„íŠ¼ ì˜ì—­ -->
    <div class="d-flex justify-content-between align-items-center button-area mt-4 mb-2" style="min-height:40px;">
      <div>
        <button class="btn btn-outline-success" id="excelBtn" data-bs-toggle="tooltip" title="ê¸‰ì—¬í•­ëª© ëª©ë¡ ë‹¤ìš´ë¡œë“œ">
          <i class="fas fa-file-excel"></i> ì—‘ì…€
        </button>
      </div>
      <div class="d-flex gap-2 w-auto">
        <button class="btn btn-outline-primary" id="addBtn">
          <i class="fas fa-plus"></i> ì¶”ê°€
        </button>
        <button class="btn btn-danger" id="deleteBtn" disabled>
          <i class="fas fa-trash"></i> ì‚­ì œ
        </button>
        <button class="btn btn-success" id="saveBtn" disabled>
          <i class="fas fa-save"></i> ì €ì¥
        </button>
      </div>
    </div>
    <!-- nav-tabs íƒ­ ì˜ì—­ ìˆ˜ì •: ì‚¬ìš©ìì •ì˜í•­ëª© íƒ­ ì‚­ì œ -->
    <ul class="nav nav-tabs mb-2" id="salaryitemTabNav" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-allow" type="button" role="tab">ìˆ˜ë‹¹í•­ëª©</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-deduct" type="button" role="tab">ê³µì œí•­ëª©</button>
      </li>
    </ul>
    <!-- TOAST UI Grid -->
    <div id="salaryItemGrid" class="grid-area"></div>
    <!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ -->
    <div id="noResultMsg" class="text-center text-muted my-4" style="display:none;">
      ğŸ” ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
  </div>

  <!-- í•­ëª© ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="salaryItemModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="salaryItemForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ê¸‰ì—¬í•­ëª© ë“±ë¡/ìˆ˜ì •</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">í•­ëª©ëª…</label>
            <input type="text" class="form-control" name="allowName" required>
          </div>
          <div class="mb-2">
            <label class="form-label">í•­ëª©ì½”ë“œ</label>
            <input type="text" class="form-control" name="allowCode" required>
          </div>
          <div class="mb-2">
            <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
            <select class="form-select" name="type" required>
              <option value="ê¸°ë³¸ê¸‰">ê¸°ë³¸ê¸‰</option>
              <option value="ìˆ˜ë‹¹">ìˆ˜ë‹¹</option>
              <option value="ë³µë¦¬í›„ìƒ">ë³µë¦¬í›„ìƒ</option>
              <option value="ìƒì—¬">ìƒì—¬</option>
              <option value="ê³µì œ">ê³µì œ</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">ê³„ì‚°ë°©ì‹</label>
            <select class="form-select" name="calcType" required>
              <option value="ê³ ì •ì•¡">ê³ ì •ì•¡</option>
              <option value="ë¹„ìœ¨">ë¹„ìœ¨</option>
              <option value="ê·¼ë¬´ì‹œê°„ ë¹„ë¡€">ê·¼ë¬´ì‹œê°„ ë¹„ë¡€</option>
              <option value="ì„±ê³¼ ì—°ë™">ì„±ê³¼ ì—°ë™</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">ê³¼ì„¸ì—¬ë¶€</label>
            <select class="form-select" name="taxFreeYn" required>
              <option value="Y">ê³¼ì„¸ëŒ€ìƒ</option>
              <option value="N">ë¹„ê³¼ì„¸</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">ì ìš©ëŒ€ìƒ(ì‚¬ì›ìœ í˜•)</label>
            <select class="form-select" name="workTypes" required></select>
            <div class="form-text">ì—¬ëŸ¬ ìœ í˜• ì„ íƒ ê°€ëŠ¥</div>
          </div>
          <div class="mb-2">
            <label class="form-label">ì„¤ëª…</label>
            <input type="text" class="form-control" name="note">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">ì €ì¥</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://uicdn.toast.com/grid/latest/tui-grid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // TOAST UI Grid ì»¬ëŸ¼ ì •ì˜ (sortable, ì„¤ëª… íˆ´íŒ ì ìš©)
    const workTypeColors = {
      'emp01': 'primary',   // ì •ê·œì§
      'emp02': 'success',   // ê³„ì•½ì§
      'emp03': 'warning',   // ì„ì‹œì§
      'emp04': 'info',      // íŒŒê²¬ì§
      'emp05': 'secondary', // ìœ„ì´‰ì§
      'emp06': 'danger'     // ì¼ìš©ì§
    };
    const workTypeLabels = {
      'emp01': 'ì •ê·œì§', 'emp02': 'ê³„ì•½ì§', 'emp03': 'ì„ì‹œì§',
      'emp04': 'íŒŒê²¬ì§', 'emp05': 'ìœ„ì´‰ì§', 'emp06': 'ì¼ìš©ì§'
    };
    // ê³„ì‚°ë°©ì‹ ì½”ë“œ â†’ í•œê¸€ëª… ë§¤í•‘
    const calcTypeMap = {
      'FIXED': 'ê³ ì •ì•¡',
      'RATE_TAX': 'ë¹„ìœ¨',
      'OT_HOUR': 'ì—°ì¥ê·¼ë¬´ìˆ˜ë‹¹(ì‹œê°„ë‹¹)',
      'WEEKEND_PAY': 'ì£¼ë§ê·¼ë¬´ìˆ˜ë‹¹'
    };
    // ì‚¬ì›ìœ í˜• ì½”ë“œ â†’ í•œê¸€ëª… ë§¤í•‘
    const empTypeMap = {
      'emp01': 'ì •ê·œì§',
      'emp02': 'ê³„ì•½ì§',
      'emp03': 'ì„ì‹œì§',
      'emp04': 'íŒŒê²¬ì§',
      'emp05': 'ìœ„ì´‰ì§',
      'emp06': 'ì¼ìš©ì§',
      'ALL': 'ì „ì²´'
    };
    const calcTypeOptions = [
      { text: 'ê³ ì •ì•¡', value: 'ê³ ì •ì•¡' },
      { text: 'ë¹„ìœ¨', value: 'ë¹„ìœ¨' },
      { text: 'ê·¼ë¬´ì‹œê°„ ë¹„ë¡€', value: 'ê·¼ë¬´ì‹œê°„ ë¹„ë¡€' },
      { text: 'ì„±ê³¼ ì—°ë™', value: 'ì„±ê³¼ ì—°ë™' }
    ];
    // ì§€ê¸‰ìƒíƒœ ì½”ë“œ â†’ í…ìŠ¤íŠ¸/ìŠ¤íƒ€ì¼ ë§¤í•‘
    const payStatusMap = {
      'ss01': { text: 'ëŒ€ê¸°', class: 'status-badge status-wait' },
      'ss02': { text: 'ìŠ¹ì¸ ì™„ë£Œ', class: 'status-badge status-approve' },
      'ss03': { text: 'ì§€ê¸‰ ì™„ë£Œ', class: 'status-badge status-done' }
    };
    const columns = [
      { header: 'í•­ëª©ì½”ë“œ', name: 'allowCode', align: 'center', editor: 'text' },
      { header: 'í•­ëª©ëª…', name: 'allowName', editor: 'text' },
      { header: 'ì¹´í…Œê³ ë¦¬', name: 'type', align: 'center', editor: { type: 'select', options: { listItems: [
        { text: 'ê¸°ë³¸ê¸‰', value: 'ê¸°ë³¸ê¸‰' },
        { text: 'ìˆ˜ë‹¹', value: 'ìˆ˜ë‹¹' },
        { text: 'ë³µë¦¬í›„ìƒ', value: 'ë³µë¦¬í›„ìƒ' },
        { text: 'ìƒì—¬', value: 'ìƒì—¬' },
        { text: 'ê³µì œ', value: 'ê³µì œ' }
      ]}}},
      { header: 'ê¸ˆì•¡', name: 'defaultAmount', align: 'right', editor: { type: 'text', options: { inputType: 'number' } },
        formatter: ({value}) => value ? value.toLocaleString() + 'ì›' : '-', sortable: true },
      { header: 'ê³„ì‚°ë°©ì‹', name: 'calcType', align: 'center',
        editor: { type: 'select', options: { listItems: [
          { text: 'ê³ ì •ì•¡', value: 'FIXED' },
          { text: 'ë¹„ìœ¨', value: 'RATE_TAX' },
          { text: 'ì—°ì¥ê·¼ë¬´ìˆ˜ë‹¹(ì‹œê°„ë‹¹)', value: 'OT_HOUR' },
          { text: 'ì£¼ë§ê·¼ë¬´ìˆ˜ë‹¹', value: 'WEEKEND_PAY' }
        ]}},
        formatter: ({value}) => calcTypeMap[value] || value
      },
      { header: 'ê³¼ì„¸ì—¬ë¶€', name: 'taxFreeYn', align: 'center', 
        editor: { type: 'select', options: { listItems: [
          { text: 'ê³¼ì„¸', value: 'Y' },
          { text: 'ë¹„ê³¼ì„¸', value: 'N' }
        ]}},
        formatter: ({value}) => value === 'Y' ? '<span class="start-action">ê³¼ì„¸</span>' : '<span class="end-action">ë¹„ê³¼ì„¸</span>'
      },
      { header: 'ì ìš©ëŒ€ìƒ', name: 'workTypes', align: 'center',
        editor: {
          type: 'select',
          options: {
            listItems: [
              { text: 'ì„ íƒ', value: '' },
              { text: 'ì „ì²´', value: 'ALL' },
              { text: 'ì •ê·œì§', value: 'emp01' },
              { text: 'ê³„ì•½ì§', value: 'emp02' },
              { text: 'ì„ì‹œì§', value: 'emp03' },
              { text: 'íŒŒê²¬ì§', value: 'emp04' },
              { text: 'ìœ„ì´‰ì§', value: 'emp05' },
              { text: 'ì¼ìš©ì§', value: 'emp06' }
            ]
          }
        },
        formatter: ({ value }) => {
          if (!value) return 'ì„ íƒ';
          if (value === 'ALL') return 'ì „ì²´';
          const allCodes = ['emp01','emp02','emp03','emp04','emp05','emp06'];
          const selected = value.split(',').map(v => v.trim()).filter(Boolean);
          if (selected.length === allCodes.length && allCodes.every(code => selected.includes(code))) {
            return 'ì „ì²´';
          }
          return selected.map(code => empTypeMap[code] || code).join(', ');
        }
      },
      { header: 'ìƒíƒœ', name: 'acctYn', align: 'center', editor: { type: 'select', options: { listItems: [
        { text: 'Y', value: 'Y' }, { text: 'N', value: 'N' }
      ]}},
        formatter: ({value}) => {
          if (value === 'Y') {
            return '<span class="del-action">í™œì„±</span>';
          } else {
            return '<span class="end-action">ë¹„í™œì„±</span>';
          }
        },
        sortable: true },
      { header: 'ì„¤ëª…', name: 'note', editor: 'text',
        formatter: ({ value }) => `<span title="${value || ''}">${value || ''}</span>` },
      { header: 'ìƒì„±ì¼', name: 'createdDate', align: 'center', formatter: ({value}) => value || '-', sortable: true },
      // ì§€ê¸‰ìƒíƒœ â†’ ìˆ˜ì •ì¼ë¡œ ë³€ê²½, ë‚ ì§œ íƒ€ì…ìœ¼ë¡œ í‘œì‹œ
      { header: 'ìˆ˜ì •ì¼', name: 'updatedDate', align: 'center', formatter: ({value}) => value || '-', sortable: true }
    ];
    // ìˆ¨ê¹€ ì»¬ëŸ¼ ì˜ˆì‹œ (ì‹¤ì œ DBìš©, í•„ìš”ì‹œ ì¶”ê°€)
    // { name: 'companyId', hidden: true },

    // ê·¸ë¦¬ë“œ ìƒì„± (ì „í‘œê´€ë¦¬ì™€ ë™ì¼í•œ ì˜µì…˜, ì²´í¬ë°•ìŠ¤ rowHeaders ì¶”ê°€)
    const grid = new tui.Grid({
      el: document.getElementById('salaryItemGrid'),
      data: [], // í•˜ë“œì½”ë”© ë°ì´í„° ì™„ì „ ì‚­ì œ, ajaxë¡œë§Œ ë°ì´í„° í‘œì‹œ
      scrollX: false,
      scrollY: true,
      bodyHeight: 410,
      rowHeaders: ['checkbox', 'rowNum'],
      columns: columns
    });
    // ë¶€ëª¨ divì— width:100% ìŠ¤íƒ€ì¼ ì ìš©(í˜¹ì‹œë¼ë„ ëˆ„ë½ ì‹œ)
    document.getElementById('salaryItemGrid').style.width = '100%';

    // SweetAlert2 ê¸°ë³¸ ì„¤ì •
    const swal = Swal.mixin({ confirmButtonColor: '#3085d6', cancelButtonColor: '#d33' });

    // ê³µí†µ ajax í•¨ìˆ˜
    function commonSearchObject(paramObj, url, grid) {
      $.ajax({
        url: '/erp/hr/salaryitem/list', // ê²½ë¡œë¥¼ í•­ìƒ APIë¡œ ê³ ì •
        method: 'GET',
        data: paramObj,
        success: function(result) {
          console.log('API ì‘ë‹µ:', result); // ë””ë²„ê¹…ìš©
          grid.resetData(result);
          $('#noResultMsg').toggle(result.length === 0);
        },
        error: function(xhr, status, error) {
          console.error('API ì˜¤ë¥˜:', xhr, status, error); // ë””ë²„ê¹…ìš©
          swal.fire('âŒ ì˜¤ë¥˜', 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      });
    }

    // íƒ­ í´ë¦­ ì´ë²¤íŠ¸ ë° ë°ì´í„° ë¡œë”© í•¨ìˆ˜ ìˆ˜ì •: ì‚¬ìš©ìì •ì˜í•­ëª© ê´€ë ¨ ì½”ë“œ ì‚­ì œ
    let currentTab = 'allow'; // ê¸°ë³¸ê°’: ìˆ˜ë‹¹í•­ëª©

    function loadSalaryItemsByTab(tab) {
      currentTab = tab;
      // íƒ­ ìŠ¤íƒ€ì¼ ë³€ê²½
      $('#salaryitemTabNav .nav-link').removeClass('active');
      let typeParam = $('#categoryFilter').val();
      let taxFreeYnParam = $('#taxFilter').val();
      if(tab === 'deduct') {
        $('#tab-deduct').addClass('active');
        typeParam = 'ê³µì œ';
      } else if(tab === 'allow') {
        $('#tab-allow').addClass('active');
        // ì „ì²´ ì„ íƒ ì‹œ typeParamì„ 'ê³µì œ'ê°€ ì•„ë‹Œ ê°’ë§Œ ì¡°íšŒí•˜ë„ë¡ ë³„ë„ ì²˜ë¦¬
        if (!typeParam) typeParam = 'notê³µì œ';
      }
      const paramObj = {
        comId: 'com-101',
        type: typeParam,
        taxFreeYn: taxFreeYnParam,
        acctYn: $('input[name="salaryStatus"]:checked').val(),
        keyword: $('#searchInput').val(),
        tab: tab // 'allow', 'deduct'
      };
      $.ajax({
        url: '/erp/hr/salaryitem/list',
        method: 'GET',
        data: paramObj,
        success: function(result) {
          grid.resetData(result);
          $('#noResultMsg').toggle(result.length === 0);
        },
        error: function(xhr, status, error) {
          Swal.fire('âŒ ì˜¤ë¥˜', 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      });
    }

    // íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸: ì‚¬ìš©ìì •ì˜í•­ëª© ê´€ë ¨ ì½”ë“œ ì‚­ì œ
    $('#tab-allow').on('click', function() { loadSalaryItemsByTab('allow'); });
    $('#tab-deduct').on('click', function() { loadSalaryItemsByTab('deduct'); });

    // ê¸°ì¡´ filterSalaryItems í•¨ìˆ˜ë„ íƒ­ ìƒíƒœ ë°˜ì˜í•˜ë„ë¡ ìˆ˜ì •
    function filterSalaryItems() {
      loadSalaryItemsByTab(currentTab);
    }
    // ì¹´í…Œê³ ë¦¬/ì§„í–‰ìƒíƒœëŠ” ì¦‰ì‹œ í•„í„°ë§
    $('#categoryFilter').on('change', filterSalaryItems);
    $('#taxFilter').on('change', filterSalaryItems);
    document.querySelectorAll('input[name="salaryStatus"]').forEach(radio => {
      radio.addEventListener('change', filterSalaryItems);
    });
    // ê²€ìƒ‰ì–´ëŠ” ê²€ìƒ‰ ë²„íŠ¼/ì—”í„°ë¡œë§Œ
    $('#searchBtn').on('click', filterSalaryItems);
    $('#searchInput').on('keydown', function(e) {
      if (e.keyCode === 13) filterSalaryItems();
    });
    // í˜ì´ì§€ ë¡œë”© ì‹œ ì „ì²´ ë¦¬ìŠ¤íŠ¸ ìë™ ì¡°íšŒ
    window.addEventListener('DOMContentLoaded', function() {
      loadSalaryItemsByTab('allow');
    });

    // ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ, í™œì„± ìƒíƒœ ìë™ ì„¸íŒ…
    $('#addBtn').on('click', function() {
      // í˜„ì¬ íƒ­ì— ë”°ë¼ ì½”ë“œ prefix ê²°ì •
      let prefix = (currentTab === 'deduct') ? 'DED' : 'ALLOW';
      // ë§ˆì§€ë§‰ í•­ëª©ì½”ë“œ ì¡°íšŒí•˜ì—¬ ë‹¤ìŒ ë²ˆí˜¸ ìƒì„±
      $.ajax({
        url: '/erp/hr/salaryitem/lastCode',
        method: 'GET',
        data: { comId: 'com-101', prefix: prefix },
        success: function(response) {
          let nextCode = prefix + '01'; // ê¸°ë³¸ê°’
          if (response.lastCode) {
            const lastCode = response.lastCode;
            if (lastCode.startsWith(prefix)) {
              const numStr = lastCode.substring(prefix.length); // "01", "02" ë“±
              const nextNum = parseInt(numStr, 10) + 1;
              nextCode = prefix + String(nextNum).padStart(2, '0');
            }
          }
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth() + 1).padStart(2, '0');
          const dd = String(today.getDate()).padStart(2, '0');
          const todayStr = `${yyyy}-${mm}-${dd}`;
          grid.prependRow({
            allowCode: nextCode,
            allowName: '',
            type: '',
            defaultAmount: '',
            acctYn: 'Y',
            createdDate: todayStr,
            note: '',
            status: 'ss01' // ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
          }, { focus: true });
          setTimeout(() => {
            grid.focusAt(0, 'allowName'); // í•­ëª©ëª… ì…ë ¥ ì…€ë¡œ í¬ì»¤ìŠ¤
            const gridBody = document.querySelector('.tui-grid-body-area');
            if (gridBody) gridBody.scrollTop = 0;
          }, 100);
          $('#saveBtn').prop('disabled', false);
        },
        error: function() {
          // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±
          let prefix = (currentTab === 'deduct') ? 'DED' : 'ALLOW';
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth() + 1).padStart(2, '0');
          const dd = String(today.getDate()).padStart(2, '0');
          const todayStr = `${yyyy}-${mm}-${dd}`;
          grid.prependRow({
            allowCode: prefix + '01',
            allowName: '',
            type: '',
            defaultAmount: '',
            acctYn: 'Y',
            createdDate: todayStr,
            note: '',
            status: 'ss01' // ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
          }, { focus: true });
          setTimeout(() => {
            grid.focusAt(0, 'allowName');
            const gridBody = document.querySelector('.tui-grid-body-area');
            if (gridBody) gridBody.scrollTop = 0;
          }, 100);
          $('#saveBtn').prop('disabled', false);
        }
      });
    });

    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹ ê·œ/ìˆ˜ì • ë¶„ê¸° ë° í•„ìˆ˜ê°’ ì²´í¬ + ì‹¤ì œ DB ì €ì¥ ajax
    $('#saveBtn').on('click', function() {
      const { createdRows, updatedRows } = grid.getModifiedRows();
      if (createdRows.length === 0 && updatedRows.length === 0) {
        swal.fire('ì•Œë¦¼', 'ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
        return;
      }
      // í•„ìˆ˜ê°’ ì²´í¬(ì‹ ê·œ)
      for (const row of createdRows) {
        if (!row.allowCode || !row.allowName || !row.type || !row.defaultAmount || !row.acctYn) {
          swal.fire('âš  í•„ìˆ˜ ì…ë ¥', 'í•­ëª©ì½”ë“œ, í•­ëª©ëª…, ì¹´í…Œê³ ë¦¬, ê¸ˆì•¡, ìƒíƒœëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.', 'warning');
          return;
        }
      }
      // ë¶„ê¸°: ì‹ ê·œ/ìˆ˜ì •
      let msg = '';
      if (createdRows.length > 0 && updatedRows.length === 0) {
        msg = 'ìƒˆ í•­ëª©ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      } else if (createdRows.length === 0 && updatedRows.length > 0) {
        msg = 'ë³€ê²½í•œ ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      } else {
        msg = 'ì‹ ê·œ ì¶”ê°€ ë° ë³€ê²½ ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      }
      swal.fire({
        title: msg,
        text: 'ì €ì¥ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ì €ì¥',
        cancelButtonText: 'ì·¨ì†Œ'
      }).then((result) => {
        if (result.isConfirmed) {
          // ì‹¤ì œ DB ì €ì¥ ajax (ì‹ ê·œ)
          let ajaxCount = 0;
          let ajaxFail = 0;
          if (createdRows.length > 0) {
            createdRows.forEach(row => {
              // undefined/null ê°’ keyëŠ” ì•„ì˜ˆ ì œê±°
              const cleanRow = {};
              Object.keys(row).forEach(k => {
                if (row[k] !== undefined && row[k] !== null && row[k] !== '') {
                  cleanRow[k] = row[k];
                }
              });
              // í•„ìˆ˜ê°’ ëˆ„ë½ ë°©ì§€: allowCode, allowName, type, defaultAmount, acctYn, comId
              if (!cleanRow.comId) cleanRow.comId = 'com-101';
              $.ajax({
                url: '/erp/hr/salaryitem/register',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(cleanRow),
                success: function(res) {
                  ajaxCount++;
                  if (res !== 'ok') ajaxFail++;
                  if (ajaxCount === createdRows.length + updatedRows.length) {
                    if (ajaxFail === 0) {
                      swal.fire('âœ” ì €ì¥ ì™„ë£Œ', 'ì‹ ê·œ/ìˆ˜ì • í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                      filterSalaryItems();
                      setTimeout(() => {
                        const gridBody = document.querySelector('.tui-grid-body-area');
                        if (gridBody) gridBody.scrollTop = 0;
                      }, 200);
                    } else {
                      swal.fire('âŒ ì˜¤ë¥˜', 'ì¼ë¶€ í•­ëª© ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                    $('#saveBtn').prop('disabled', true);
                  }
                },
                error: function() {
                  ajaxCount++;
                  ajaxFail++;
                  if (ajaxCount === createdRows.length + updatedRows.length) {
                    swal.fire('âŒ ì˜¤ë¥˜', 'ì¼ë¶€ í•­ëª© ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    $('#saveBtn').prop('disabled', true);
                  }
                }
              });
            });
          }
          // ìˆ˜ì •(ì—…ë°ì´íŠ¸)ë„ DB ì €ì¥ ajax ì¶”ê°€
          if (updatedRows.length > 0) {
            updatedRows.forEach(row => {
              const cleanRow = {};
              Object.keys(row).forEach(k => {
                if (row[k] !== undefined && row[k] !== null && row[k] !== '') {
                  cleanRow[k] = row[k];
                }
              });
              if (!cleanRow.comId) cleanRow.comId = 'com-101';
              $.ajax({
                url: '/erp/hr/salaryitem/modify', // ì‹¤ì œ ìˆ˜ì • API ê²½ë¡œ
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(cleanRow),
                success: function(res) {
                  ajaxCount++;
                  if (res !== 'ok') ajaxFail++;
                  if (ajaxCount === createdRows.length + updatedRows.length) {
                    if (ajaxFail === 0) {
                      swal.fire('âœ” ì €ì¥ ì™„ë£Œ', 'ì‹ ê·œ/ìˆ˜ì • í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                      filterSalaryItems();
                      setTimeout(() => {
                        const gridBody = document.querySelector('.tui-grid-body-area');
                        if (gridBody) gridBody.scrollTop = 0;
                      }, 200);
                    } else {
                      swal.fire('âŒ ì˜¤ë¥˜', 'ì¼ë¶€ í•­ëª© ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                    $('#saveBtn').prop('disabled', true);
                  }
                },
                error: function() {
                  ajaxCount++;
                  ajaxFail++;
                  if (ajaxCount === createdRows.length + updatedRows.length) {
                    swal.fire('âŒ ì˜¤ë¥˜', 'ì¼ë¶€ í•­ëª© ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    $('#saveBtn').prop('disabled', true);
                  }
                }
              });
            });
          }
        }
      });
    });

    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì›ë˜ëŒ€ë¡œ ë³µì›
    $('#deleteBtn').off('click').on('click', function() {
      const checked = grid.getCheckedRowKeys();
      if (checked.length === 0) {
        swal.fire('âš  ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', '', 'warning');
        return;
      }
      swal.fire({
        title: 'ì„ íƒí•œ ê¸‰ì—¬ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        text: 'ì‚­ì œëœ í•­ëª©ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ì‚­ì œ',
        cancelButtonText: 'ì·¨ì†Œ'
      }).then((result) => {
        if (result.isConfirmed) {
          let ajaxCount = 0, ajaxFail = 0;
          checked.forEach(rowKey => {
            const row = grid.getRow(rowKey);
            // ì‚­ì œ ìš”ì²­ ê°’ ì½˜ì†” ì¶œë ¥
            console.log('ì‚­ì œ ìš”ì²­:', row.comId, row.allowCode);
            $.ajax({
              url: '/erp/hr/delete',
              method: 'DELETE',
              data: { comId: row.comId, allowCode: row.allowCode },
              success: function(res) {
                ajaxCount++;
                if (res !== 'ok') ajaxFail++;
                if (ajaxCount === checked.length) {
                  if (ajaxFail === 0) {
                    swal.fire('âœ” ì‚­ì œ ì™„ë£Œ', 'ì„ íƒí•œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    filterSalaryItems(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                  } else {
                    swal.fire('âŒ ì˜¤ë¥˜', 'ì¼ë¶€ í•­ëª© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                  }
                  $('#deleteBtn').prop('disabled', true);
                }
              },
              error: function() {
                ajaxCount++; ajaxFail++;
                if (ajaxCount === checked.length) {
                  swal.fire('âŒ ì˜¤ë¥˜', 'ì¼ë¶€ í•­ëª© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                  $('#deleteBtn').prop('disabled', true);
                }
              }
            });
          });
        }
      });
    });
    // ì—‘ì…€ ë²„íŠ¼ ì›ë˜ëŒ€ë¡œ ë³µì›
    $('#excelBtn').off('click').on('click', function() {
      swal.fire({
        title: 'ë‹¤ìš´ë¡œë“œ í™•ì¸',
        text: 'í˜„ì¬ í‘œì‹œëœ ë°ì´í„°ë§Œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'ë‹¤ìš´ë¡œë“œ',
        cancelButtonText: 'ì·¨ì†Œ'
      }).then((result) => {
        if (result.isConfirmed) {
          grid.export && grid.export('xlsx', 'ê¸‰ì—¬í•­ëª©ê´€ë¦¬.xlsx');
          swal.fire('âœ” ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'ê¸‰ì—¬ í•­ëª© ëª©ë¡ì´ Excel íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
      });
    });

    // í•„í„° ë²„íŠ¼(ì¶”í›„ í™•ì¥ ê°€ëŠ¥)
    $('#filterBtn').on('click', function() {
      swal.fire('í•„í„°', 'í•„í„° ê¸°ëŠ¥ì€ ì¶”í›„ í™•ì¥ ì˜ˆì •ì…ë‹ˆë‹¤.', 'info');
    });

    // ê·¸ë¦¬ë“œ ë³€ê²½ ê°ì§€ â†’ ì €ì¥/ì‚­ì œ ë²„íŠ¼ í™œì„±í™”
    grid.on('afterChange', function(ev) {
      $('#saveBtn').prop('disabled', false);
    });
    grid.on('check', function(ev) {
      $('#deleteBtn').prop('disabled', grid.getCheckedRowKeys().length === 0);
    });

    // ì´ˆê¸°í™”
    $(function() {
      filterSalaryItems();
      $('[data-bs-toggle="tooltip"]').tooltip();
      // ê³µí†µì½”ë“œ APIë¡œ ì‚¬ì›ìœ í˜• ì˜µì…˜ ë™ì  ìƒì„± ë° ê·¸ë¦¬ë“œì—ë„ ì ìš©
      $.get('/common/codes', { mainCode: 'emp' }, function(data) {
        const $select = $('select[name="workTypes"]');
        $select.empty();
        const gridOptions = [];
        // 'ì „ì²´' ì˜µì…˜ì„ ë§¨ ì•ì— ì¶”ê°€
        $select.append('<option value="ALL">ì „ì²´</option>');
        gridOptions.push({ text: 'ì „ì²´', value: 'ALL' });
        data.forEach(item => {
          $select.append(`<option value="${item.subCode}">${item.subName}</option>`);
          gridOptions.push({ text: item.subName, value: item.subCode });
        });
        // ê·¸ë¦¬ë“œ ì ìš©ëŒ€ìƒ ì»¬ëŸ¼ì—ë„ ì˜µì…˜ ë™ì  ë°˜ì˜
        const workTypesCol = columns.find(col => col.name === 'workTypes');
        if (workTypesCol && workTypesCol.editor) {
          workTypesCol.editor.options.listItems = gridOptions;
        }
        grid.setColumns(columns);
      });
      // ì¹´í…Œê³ ë¦¬(í•­ëª©ìœ í˜•) í•„í„° ì…€ë ‰íŠ¸ë°•ìŠ¤ - í•˜ë“œì½”ë”© ë°©ì‹ (ì•ˆì •ì„± ìš°ì„ )
      $('#categoryFilter').html(`
        <option value="">ì „ì²´</option>
        <option value="ê¸°ë³¸ê¸‰">ê¸°ë³¸ê¸‰</option>
        <option value="ìˆ˜ë‹¹">ìˆ˜ë‹¹</option>
        <option value="ë³µë¦¬í›„ìƒ">ë³µë¦¬í›„ìƒ</option>
        <option value="ìƒì—¬">ìƒì—¬</option>
        <option value="ê³µì œ">ê³µì œ</option>
      `);
      $('#taxFilter').html(`
        <option value="">ì „ì²´</option>
        <option value="Y">ê³¼ì„¸</option>
        <option value="N">ë¹„ê³¼ì„¸</option>
      `);
    });
  </script>
</body>
</html>
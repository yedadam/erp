12<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">

    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부서관리</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Toast UI Grid CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tui-grid/4.21.8/tui-grid.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.28/sweetalert2.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/bootstrap-icons.min.css">
    
    <style>
        body {
            background: #f8f9fa;
        }
        .erp-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5em;
        }
        .erp-btns .btn {
            min-width: 100px;
        }
        .erp-search-bar {
            max-width: 100%;
        }
        .erp-table-wrap {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 24px 24px 8px 24px;
            margin-bottom: 24px;
        }
        .erp-table th {
            background: #f4f6fa;
            font-weight: 600;
        }
        .erp-table td, .erp-table th {
            vertical-align: middle;
        }
        .erp-paging {
            margin-top: 16px;
        }
        .card {
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .form-label {
            font-weight: 500;
        }
        .form-control, .form-select {
            border-radius: 8px;
        }
        .table thead th {
            text-align: center;
        }
        .table tbody td {
            text-align: center;
        }
        @media (max-width: 991px) {
            .col-lg-7, .col-lg-5 { flex: 0 0 100%; max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- 상단 카드 헤더 -->
        <div class="card shadow-sm mb-4">
            <div class="card-body d-flex justify-content-between align-items-center">
                <h2 class="fw-bold mb-0">부서 관리</h2>
                <div>
                    <button class="btn btn-outline-secondary me-2"><i class="bi bi-diagram-3"></i> 조직도</button>
                    <button class="btn btn-outline-success"><i class="bi bi-file-earmark-excel"></i> 엑셀내보내기</button>
                </div>
            </div>
        </div>
        <!-- 하단 본문 7:3 -->
        <div class="row g-4">
            <!-- 좌측: 부서목록(7) -->
            <div class="col-lg-7 col-12">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <!-- 검색/필터 -->
                        <form class="row g-2 align-items-center mb-3" id="searchForm" autocomplete="off">
                            <div class="col">
                                <input type="text" class="form-control" id="searchDeptName" placeholder="부서명 검색">
                            </div>
                            <div class="col">
                                <select class="form-select" id="searchParentDept">
                                    <option value="">상위부서 전체</option>
                                    <!-- JS로 옵션 렌더링 -->
                                </select>
                            </div>
                            <div class="col">
                                <select class="form-select" id="searchUseYn">
                                    <option value="">전체</option>
                                    <option value="Y">사용</option>
                                    <option value="N">미사용</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> 검색</button>
                    </div>
                        </form>
                        <!-- 목록 헤더/새로고침 -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-semibold"><i class="bi bi-list-ul"></i> 부서 목록</span>
                            <button class="btn btn-outline-secondary btn-sm" id="btnRefresh"><i class="bi bi-arrow-clockwise"></i> 새로고침</button>
                        </div>
                        <!-- Toast UI Grid 표시용 div 추가 -->
                        <div id="departmentGrid"></div>
                        <!-- 페이징 -->
                        <nav class="d-flex justify-content-center mt-3" id="deptPaging"></nav>
                    </div>
                </div>
            </div>
            <!-- 우측: 상세정보(3) -->
            <div class="col-lg-5 col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="fw-semibold mb-3"><i class="bi bi-info-circle"></i> 부서 상세정보</div>
                        <form id="deptForm" autocomplete="off">
                            <div class="mb-3">
                                <label for="deptName" class="form-label">부서명</label>
                                <input type="text" class="form-control" id="deptName" name="deptName" required>
                            </div>
                            <div class="mb-3">
                            <label for="parentDept" class="form-label">상위부서</label>
                            <select class="form-select" id="parentDept" name="parentDept">
                                <option value="">최상위 부서</option>
                                    <!-- JS로 옵션 렌더링 -->
                            </select>
                        </div>
                            <div class="mb-3">
                                <label for="useYn" class="form-label">사용 여부</label>
                                <select class="form-select" id="useYn" name="useYn">
                                    <option value="Y">사용</option>
                                    <option value="N">미사용</option>
                                </select>
                            </div>
                            <div class="mb-3">
                            <label for="remark" class="form-label">비고</label>
                                <textarea class="form-control" id="remark" name="remark" rows="3"></textarea>
                        </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" id="btnCancel">취소</button>
                                <button type="button" class="btn btn-primary" id="btnSave">저장</button>
                                <button type="button" class="btn btn-danger" id="btnDelete">삭제</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        </div>
    </div>
    
    <!-- 조직도 모달 -->
    <div class="modal fade" id="orgChartModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-diagram-3"></i> 조직도
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="orgChart"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tui-grid/4.21.8/tui-grid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.28/sweetalert2.min.js"></script>
    
    <script>
        let departmentGrid;
        let currentDeptId = null;
        let isEditMode = false;
        let departmentData = [];

        document.addEventListener('DOMContentLoaded', function() {
            fetchDepartments();
            showEmptyState();
        });

        // DB에서 부서 목록 불러오기
        function fetchDepartments() {
            fetch('/erp/hr/api/dept/list')
                .then(response => response.json())
                .then(data => {
                    departmentData = data.map((d, idx) => ({
                        id: idx + 1,
                        deptCode: d.deptCode,
                        deptName: d.deptName,
                        parentDept: d.parentDeptCode || '',
                        parentDeptName: d.parentDeptCode ? getParentDeptName(d.parentDeptCode, data) : '-',
                        status: d.useYn || 'Y',
                        statusText: (d.useYn === 'N' ? '미사용' : '사용'),
                        employeeCount: d.empCount || 0,
                        createdDate: d.createdDate ? d.createdDate.substr(0, 10) : '',
                        description: d.remark || ''
                    }));
                    initializeGrid();
                    updateDeptCount();
                })
                .catch(err => {
                    Swal.fire('오류', '부서 목록 조회에 실패했습니다.', 'error');
                });
        }

        // 상위부서명 찾기
        function getParentDeptName(parentCode, data) {
            const parent = data.find(d => d.deptCode === parentCode);
            return parent ? parent.deptName : '-';
        }

        // Toast UI Grid 초기화
        function initializeGrid() {
            const Grid = tui.Grid;
            if (departmentGrid) {
                departmentGrid.resetData(departmentData);
                return;
            }
            departmentGrid = new Grid({
                el: document.getElementById('departmentGrid'),
                data: departmentData,
                scrollX: false,
                scrollY: true,
                bodyHeight: 'fitToParent',
                rowHeaders: ['rowNum'],
                columns: [
                    { header: '부서코드', name: 'deptCode', width: 100, sortable: true, align: 'center' },
                    { header: '부서명', name: 'deptName', width: 150, sortable: true },
                    { header: '상위부서', name: 'parentDeptName', width: 120, sortable: true },
                    { header: '사용여부', name: 'statusText', width: 80, align: 'center',
                        formatter: function(value) {
                            const status = value.row.status;
                            const color = status === 'Y' ? '#48bb78' : '#a0aec0';
                            const bgColor = status === 'Y' ? '#c6f6d5' : '#f7fafc';
                            return `<span style="background: ${bgColor}; color: ${color}; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${value.value}</span>`;
                        }
                    },
                    { header: '인원수', name: 'employeeCount', width: 80, align: 'center', sortable: true,
                        formatter: function(value) {
                            return `<span style="color: #667eea; font-weight: 600;">${value.value}명</span>`;
                        }
                    },
                    { header: '등록일', name: 'createdDate', width: 100, align: 'center', sortable: true }
                ]
            });
            departmentGrid.on('click', function(ev) {
                const rowData = departmentGrid.getRow(ev.rowKey);
                if (rowData) {
                    loadDepartmentDetail(rowData);
                }
            });
        }
        
        // 이하 함수들은 기존과 동일하게 유지(샘플데이터 관련 부분은 departmentData로 대체)
        // ... (loadDepartmentDetail, addNewDepartment, showEmptyState, hideEmptyState, saveDepartment, addDepartmentToGrid, updateDepartmentInGrid, deleteDepartment, cancelEdit, searchDepartments, refreshDepartments, updateDeptCount, showOrgChart, exportToExcel 등)
        // 단, sampleData 대신 departmentData 사용

        // 예시: 부서 개수 업데이트
        function updateDeptCount(count = null) {
            const totalCount = count !== null ? count : departmentData.length;
            document.getElementById('deptCount').textContent = `총 ${totalCount}개`;
        }
        
        // 새로고침
        function refreshDepartments() {
            document.getElementById('searchDeptName').value = '';
            document.getElementById('filterParentDept').value = '';
            document.getElementById('filterStatus').value = '';
            fetchDepartments();
            cancelEdit();
                        Swal.fire({
                            icon: 'success',
                title: '새로고침 완료',
                text: '데이터가 새로고침되었습니다.',
                            timer: 1500,
                            showConfirmButton: false
                        });
        }
        
        // 부서 검색
        function searchDepartments() {
            const searchName = document.getElementById('searchDeptName').value.toLowerCase();
            const filterParent = document.getElementById('filterParentDept').value;
            const filterStatus = document.getElementById('filterStatus').value;
            let filteredData = departmentData.filter(dept => {
                const nameMatch = !searchName || dept.deptName.toLowerCase().includes(searchName);
                const parentMatch = !filterParent || dept.parentDept === filterParent;
                const statusMatch = !filterStatus || dept.status === filterStatus;
                return nameMatch && parentMatch && statusMatch;
            });
            departmentGrid.resetData(filteredData);
            updateDeptCount(filteredData.length);
            Swal.fire({
                icon: 'info',
                title: '검색 완료',
                text: `${filteredData.length}개의 부서를 찾았습니다.`,
                timer: 1500,
                showConfirmButton: false
            });
        }

        function showEmptyState() {}
    </script>
</body>
</html>
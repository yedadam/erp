<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="Content">
<head>
    <title>ê¸‰ì—¬ê´€ë¦¬</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .dashboard-card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 24px 18px 18px 18px;
            background: #fff;
            min-width: 180px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            margin-bottom: 12px;
        }
        .dashboard-card .icon {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }
        .dashboard-card .label {
            font-size: 1.1rem;
            color: #888;
        }
        .dashboard-card .value {
            font-size: 1.7rem;
            font-weight: bold;
            color: #222;
        }
        .dashboard-card.blue { border-left: 6px solid #2563eb; }
        .dashboard-card.green { border-left: 6px solid #22c55e; }
        .dashboard-card.orange { border-left: 6px solid #f59e42; }
        .dashboard-card.purple { border-left: 6px solid #a855f7; }
        .dashboard-card .icon.blue { color: #2563eb; }
        .dashboard-card .icon.green { color: #22c55e; }
        .dashboard-card .icon.orange { color: #f59e42; }
        .dashboard-card .icon.purple { color: #a855f7; }
        .search-bar {
            background: #f8fafc;
            border-radius: 8px;
            padding: 18px 16px 10px 16px;
            margin-bottom: 18px;
        }
        .badge-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            color: #fff;
            display: inline-block;
        }
        .badge-paid { background: #22c55e; }
        .badge-wait { background: #f59e42; }
        .badge-calc { background: #2563eb; }
        .inline-action-btn {
            border: none;
            background: none;
            cursor: pointer;
            margin-right: 6px;
            font-size: 1.1rem;
        }
        .inline-action-btn:last-child { margin-right: 0; }
        /* TOAST UI Grid ìƒë‹¨ ë¼ìš´ë“œ - ê¸‰ì—¬í•­ëª©ê´€ë¦¬ì™€ ì™„ì „íˆ ë™ì¼í•˜ê²Œ ì ìš© */
        #salaryGrid .tui-grid-container {
            border-radius: 8px 8px 0 0 !important;
            overflow: hidden;
        }
        .badge {
            display: inline-block;
            padding: 2px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            border: 2px solid;
            margin: 2px 0;
        }
        .badge-outline.badge-yellow {
            color: #b58900;
            border-color: #ffe066;
            background: #fffbe6;
        }
        .badge-outline.badge-green {
            color: #228b22;
            border-color: #b7efc5;
            background: #f6ffed;
        }
        .badge-outline.badge-blue {
            color: #2563eb;
            border-color: #a5b4fc;
            background: #f0f7ff;
        }
        /* ê´€ë¦¬ ì•„ì´ì½˜ ë²„íŠ¼ í¬ê¸°/ê°„ê²© ì¡°ì • */
        #salaryGrid .btn.btn-sm {
            padding: 2px 4px !important;
            margin-right: 2px !important;
            min-width: 28px;
            width: 28px;
            height: 28px;
            box-sizing: border-box;
        }
        #salaryGrid .btn.btn-sm:last-child {
            margin-right: 0 !important;
        }
        #salaryGrid .manage-btn-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2px;
        }
        /* ê¸‰ì—¬ëª…ì„¸ì„œ ì§€ê¸‰ìƒíƒœ ë°°ì§€ salaryitem.htmlê³¼ ë™ì¼í•˜ê²Œ */
        .status-badge {
            display: inline-block;
            padding: 1px 8px; /* ë†’ì´ ì‚´ì§ ì¤„ì„ */
            border-radius: 12px;
            font-size: 13px;
            font-weight: normal;
            border: 1px solid #e2e8f0;
            letter-spacing: 0.5px;
            min-width: 56px;
            text-align: center;
        }
        .status-wait {
            background: #fffbe6;
            color: #b58900;
            border-color: #ffe066;
        }
        .status-approve {
            background: #e6f4ea;
            color: #1a7f37;
            border-color: #b7e4c7;
        }
        .status-done {
            background: #fbeaea;
            color: #c92a2a;
            border-color: #f5c2c7;
        }
        .icon-btn {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            color: #3b82f6;
            cursor: pointer;
            outline: none;
        }
        .icon-btn:focus {
            outline: none;
            box-shadow: none;
        }
        .icon-btn:hover {
            color: #2563eb;
        }
    </style>
</head>
<body>
  <div class="container-fluid px-4">
    <!-- í˜ì´ì§€ íƒ€ì´í‹€ + í—¤ë” ë²„íŠ¼ (ë°‘ì¤„ ìœ„ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ padding ì¡°ì •) -->
    <div class="d-flex justify-content-between align-items-end mb-3 border-bottom border-secondary pb-2" style="padding-bottom: 0.25rem !important;">
      <h3 class="text-secondary fw-bold mb-0" style="padding-right: 16px; padding-bottom: 0.25rem;">ê¸‰ì—¬ê´€ë¦¬</h3>
      <!-- ë²„íŠ¼ ì˜ì—­ ì‚­ì œ -->
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ì˜ì—­ (ì¬ê³  ë©”ì¸ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼) -->
    <div class="row">
      <!-- ì´ ì§ì› ìˆ˜ -->
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary h-100 py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">ì´ ì§ì› ìˆ˜</div>
                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalEmp">0</div>
              </div>
              <div class="col-auto">
                <i class="fas fa-users fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ì´ ì§€ê¸‰ì•¡ -->
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success h-100 py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">ì´ ì§€ê¸‰ì•¡</div>
                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSalary">0ì›</div>
              </div>
              <div class="col-auto">
                <i class="fas fa-wallet fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ì´ ê³µì œì•¡ -->
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info h-100 py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">ì´ ê³µì œì•¡</div>
                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalDeduction">0ì›</div>
              </div>
              <div class="col-auto">
                <i class="fas fa-minus-circle fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ì‹¤ìˆ˜ë ¹ì•¡ -->
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning h-100 py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">ì‹¤ìˆ˜ë ¹ì•¡</div>
                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalNetSalary">0ì›</div>
              </div>
              <div class="col-auto">
                <i class="fas fa-hand-holding-usd fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ê²€ìƒ‰/í•„í„° ì˜ì—­ (ê¸‰ì—¬í•­ëª© ê´€ë¦¬ì™€ ë™ì¼ ë ˆì´ì•„ì›ƒ) -->
    <div class="card mb-3 rounded shadow-sm search-area">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <!-- ê¸‰ì—¬ë…„ì›” -->
          <div class="col-md-2">
            <label for="salaryMonthFilter" class="form-label">ê¸‰ì—¬ë…„ì›”</label>
            <select class="form-select" id="salaryMonthFilter">
              <option value="">ì „ì²´</option>
              <option value="2025-06">2025ë…„ 6ì›”</option>
              <option value="2025-05">2025ë…„ 5ì›”</option>
              <option value="2025-04">2025ë…„ 4ì›”</option>
            </select>
          </div>
          <!-- ë¶€ì„œ -->
          <div class="col-md-2">
            <label for="deptFilter2" class="form-label">ë¶€ì„œ</label>
            <select class="form-select" id="deptFilter2">
              <option value="">ì „ì²´</option>
              <!-- ë™ì  ì˜µì…˜ -->
            </select>
          </div>
          <!-- ê²€ìƒ‰ì–´ -->
          <div class="col-md-2">
            <label for="searchInput2" class="form-label">ê²€ìƒ‰ì–´</label>
            <input type="text" class="form-control" id="searchInput2" placeholder="ì§ì›ëª… ë˜ëŠ” ì‚¬ë²ˆ ì…ë ¥">
          </div>
          <!-- ì§€ê¸‰ ìƒíƒœ -->
          <div class="col-md-3">
            <label class="form-label d-block">ì§€ê¸‰ ìƒíƒœ</label>
            <div class="d-flex gap-2 flex-wrap">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="payStatusRadio" id="payStatusAll" value="" checked>
                <label class="form-check-label" for="payStatusAll">ì „ì²´</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="payStatusRadio" id="payStatusWait" value="WAIT">
                <label class="form-check-label" for="payStatusWait">ëŒ€ê¸°</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="payStatusRadio" id="payStatusApprove" value="APPROVE">
                <label class="form-check-label" for="payStatusApprove">ìŠ¹ì¸</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="payStatusRadio" id="payStatusPaid" value="PAID">
                <label class="form-check-label" for="payStatusPaid">ì§€ê¸‰ì™„ë£Œ</label>
              </div>
            </div>
          </div>
          <!-- ê²€ìƒ‰ ë²„íŠ¼: í•­ìƒ ìš°ì¸¡ ë, col-md-2, w-100 -->
          <div class="col-md-2 d-flex align-items-end ms-auto justify-content-end">
            <button class="btn btn-primary w-100" id="searchBtn2"><i class="fas fa-search"></i> ê²€ìƒ‰</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ê·¸ë¦¬ë“œ ìœ„ ë²„íŠ¼ ì˜ì—­ (ì¢Œ: ê¸‰ì—¬ê³„ì‚°/ì—‘ì…€/ëª…ì„¸ì„œ, ìš°: ì¶”ê°€/ì‚­ì œ/ì €ì¥) -->
    <div class="d-flex justify-content-between align-items-center button-area mt-2 mb-2 flex-wrap" style="min-height:40px;">
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-outline-secondary btn" id="calcBtnHeader"><i class="fas fa-calculator"></i> ê¸‰ì—¬ê³„ì‚°</button>
        <button class="btn btn-outline-info btn" id="approveAllBtnHeader"><i class="fas fa-check-double"></i> ì¼ê´„ìŠ¹ì¸</button>
        <button class="btn btn-outline-success btn" id="payAllBtnHeader"><i class="fas fa-money-bill-wave"></i> ì¼ê´„ì§€ê¸‰</button>
        <button class="btn btn-outline-dark btn" id="exportPayslipBtn"><i class="fas fa-file-pdf"></i> ëª…ì„¸ì„œì¶œë ¥</button>
        <button class="btn btn-outline-warning btn" id="emailPayslipBtn"><i class="fas fa-envelope"></i> ëª…ì„¸ì„œ ì´ë©”ì¼ë°œì†¡</button>
      </div>
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-outline-primary btn" id="addBtn2"><i class="fas fa-plus"></i> ì¶”ê°€</button>
        <button class="btn btn-danger btn" id="deleteBtn2" disabled><i class="fas fa-trash"></i> ì‚­ì œ</button>
        <button class="btn btn-success btn" id="saveBtn2" disabled><i class="fas fa-save"></i> ì €ì¥</button>
      </div>
    </div>

    <!-- TOAST UI Grid: ê¸‰ì—¬ ìƒì„¸ ê²Œì‹œíŒ -->
    <div id="salaryGrid" class="grid-area"></div>
    <div id="noResultMsg" class="text-center text-muted my-4" style="display:none;">
      ğŸ” ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
  </div>

  <!-- ì‚¬ì› ê²€ìƒ‰ ëª¨ë‹¬ -->
  <div class="modal fade" id="empModal" tabindex="-1" aria-labelledby="empModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="empModalLabel">ì‚¬ì› ê²€ìƒ‰</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3" style="max-width: 400px; margin-left: 12px;">
            <select class="form-select" id="empSelect" style="max-width: 30%;">
              <option value="empId" selected>ì‚¬ì›ë²ˆí˜¸</option>
              <option value="empName">ì‚¬ì›ëª…</option>
            </select>
            <input type="text" class="form-control" id="empInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
            <button class="btn btn-outline-secondary" type="button" id="empSearchBtn">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <div class="container-fluid">
            <div id="empGrid"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ê¸‰ì—¬í•­ëª© ê´€ë¦¬ ëª¨ë‹¬ -->
  <div class="modal fade" id="salaryItemModal" tabindex="-1" aria-labelledby="salaryItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="salaryItemModalLabel">ê¸‰ì—¬í•­ëª© ê´€ë¦¬</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered align-middle text-center">
            <thead>
              <tr>
                <th>í•­ëª©ëª…</th>
                <th>ì½”ë“œ</th>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>ê³„ì‚°ë°©ì‹</th>
                <th>ì ìš©ëŒ€ìƒ</th>
                <th>ì‚¬ìš©ì—¬ë¶€</th>
                <th>ë¹„ê³ </th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="salaryItemTableBody">
              <!-- JSë¡œ ë™ì  í–‰ ì¶”ê°€ -->
            </tbody>
          </table>
          <button class="btn btn-outline-primary" id="addSalaryItemBtn">í•­ëª© ì¶”ê°€</button>
          <button class="btn btn-outline-danger" id="deleteSalaryItemBtn">í•­ëª© ì‚­ì œ</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" id="saveSalaryItemBtn">ì €ì¥</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://uicdn.toast.com/grid/latest/tui-grid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // ì‹¤ì‹œê°„ í˜„í™© ì¹´ë“œ ë°ì´í„° ë¡œë”© (ì˜ˆì‹œ)
    function loadDashboard() {
      $.get('/erp/hr/salary/dashboard', function(data) {
        $('#totalEmp').text(data.totalEmp || 0);
        $('#totalSalary').text(data.totalSalary ? data.totalSalary.toLocaleString() + 'ì›' : '0ì›');
        $('#totalDeduction').text(data.totalDeduction ? data.totalDeduction.toLocaleString() + 'ì›' : '0ì›');
        $('#totalNetSalary').text(data.totalNetSalary ? data.totalNetSalary.toLocaleString() + 'ì›' : '0ì›');
      });
    }
    // ë¶€ì„œ ì˜µì…˜ ë™ì  ë¡œë”© (API ê²½ë¡œ ë° í•„ë“œëª… ìˆ˜ì •)
    function loadDeptOptions2() {
      $.get('/erp/hr/dept', function(list) {
        const $dept = $('#deptFilter2');
        $dept.empty().append('<option value="">ì „ì²´</option>');
        list.forEach(d => $dept.append(`<option value="${d.deptCode}">${d.deptName}</option>`));
      });
    }
    // ê´€ë¦¬ì ì„¤ì • ì˜ˆì‹œ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ DBì—ì„œ ê´€ë¦¬)
    const allowanceSettings = [
      { key: 'sal01', enabled: true, label: 'ìê²©ìˆ˜ë‹¹' },
      { key: 'sal02', enabled: true, label: 'ë³µì§€í¬ì¸íŠ¸' },
      { key: 'sal03', enabled: false, label: '' },
      { key: 'sal04', enabled: false, label: '' },
      { key: 'sal05', enabled: false, label: '' },
      { key: 'sal06', enabled: false, label: '' },
      { key: 'sal07', enabled: false, label: '' },
      { key: 'sal08', enabled: false, label: '' },
      { key: 'sal09', enabled: false, label: '' },
      { key: 'sal10', enabled: false, label: '' }
    ];
    // ì»¬ëŸ¼ ì •ì˜ (ìš”êµ¬ì‚¬í•­ ìˆœì„œ, ì‹¤ë¬´ ë§¤í•‘)
    const columns = [
      { header: 'ì‚¬ì›ë²ˆí˜¸', name: 'empId', align: 'center', editor: 'text' },
      { header: 'ì‚¬ì›ëª…', name: 'empName', align: 'center', editor: 'text' },
      { header: 'ë¶€ì„œëª…', name: 'deptName', align: 'center', editor: 'text' },
      { header: 'ê¸°ë³¸ê¸‰', name: 'baseSal', dataType: 'number',align: 'right', editor: 'text', formatter: ({ value }) => value ? Number(value).toLocaleString() + 'ì›' : 0 },
      { header: 'OTìˆ˜ë‹¹', name: 'otAllow', dataType: 'number',align: 'right', editor: 'text', formatter: ({ value }) => value ? Number(value).toLocaleString() + 'ì›' : 0 },
      ...allowanceSettings.filter(s => s.enabled).map((setting, i) => ({
        header: setting.label || `ìˆ˜ë‹¹${i+1}`,
        name: `sal${i+1}`,
        align: 'right',
        editor: 'text',
        formatter: ({ value }) => value ? Number(value).toLocaleString() + 'ì›' : '-'
      })),
      { header: 'ìˆ˜ë‹¹í•©ê³„', name: 'allowanceTotal', dataType: 'number',align: 'right', formatter: ({ value }) => value ? Number(value).toLocaleString() + 'ì›' : 0, editor: false },
      { header: 'ê³µì œí•©ê³„', name: 'deductionTotal', dataType: 'number',align: 'right', formatter: ({ value }) => value ? Number(value).toLocaleString() + 'ì›' : 0, editor: false },
      { header: 'ì‹¤ìˆ˜ë ¹ì•¡', name: 'netSalary', dataType: 'number', align: 'right', formatter: ({ value }) => value ? Number(value).toLocaleString() + 'ì›' : 0, editor: false },
      { header: 'ì§€ê¸‰ìƒíƒœ', name: 'status', align: 'center',
        editor: {
          type: 'select',
          options: {
            listItems: [
              { text: 'ëŒ€ê¸°', value: 'ss01' },
              { text: 'ìŠ¹ì¸', value: 'ss02' },
              { text: 'ì§€ê¸‰ì™„ë£Œ', value: 'ss03' }
            ]
          }
        },
        formatter: ({ value }) => {
          if (!value) return '-';
          if (value === 'ss01' || value === 'ëŒ€ê¸°') return '<span class="status-badge status-wait">ëŒ€ê¸°</span>';
          if (value === 'ss02' || value === 'ìŠ¹ì¸') return '<span class="status-badge status-approve">ìŠ¹ì¸</span>';
          if (value === 'ss03' || value === 'ì§€ê¸‰ì™„ë£Œ') return '<span class="status-badge status-done">ì§€ê¸‰ì™„ë£Œ</span>';
          return value;
        }
      },
      { header: 'ì§€ê¸‰ì¼', name: 'createdDate', align: 'center' },
      {
        header: 'ìƒì„¸', name: 'manage', align: 'center', minWidth: 60, width: 70, maxWidth: 80,
        formatter: ({ row }) => `
          <div class="manage-btn-group">
            <button class="icon-btn" onclick="viewDetail('${row.empId}')" title="ê¸‰ì—¬ëª…ì„¸ì„œ">
              <i class="fas fa-eye fa-sm"></i>
            </button>
          </div>
        `
      }
    ];
    // ê·¸ë¦¬ë“œ ìƒì„±
    const grid = new tui.Grid({
      el: document.getElementById('salaryGrid'),
      data: [],
      scrollX: false,
      scrollY: true,
      bodyHeight: 245,
      rowHeaders: ['checkbox'],
      columns: columns
    });
    // ê³µí†µ Ajax í•¨ìˆ˜ (salaryitem.html ì°¸ê³ )
    function commonSearchObject(paramObj, url, grid) {
      $.ajax({
        url: url,
        method: 'GET',
        data: paramObj,
        success: function(result) {
          grid.resetData(result);
          $('#noResultMsg').toggle(result.length === 0);
        },
        error: function(xhr, status, error) {
          Swal.fire('âŒ ì˜¤ë¥˜', 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      });
    }
    // í•„í„°/ê²€ìƒ‰
    function filterSalaryList() {
      const paramObj = {
        comId: 'com-101', // íšŒì‚¬ID ê¸°ë³¸ê°’ í•­ìƒ í¬í•¨
        keyword: $('#searchInput2').val(),
        dept: $('#deptFilter2').val(),
        calcMonth: $('#salaryMonthFilter').val(),
        status: $('input[name="payStatusRadio"]:checked').val()
      };
      commonSearchObject(paramObj, '/erp/hr/salary/statement/list', grid);
    }
    // í•„í„°/ê²€ìƒ‰ ì´ë²¤íŠ¸ ë°”ì¸ë”© (salaryitem.html ì°¸ê³ )
    $('#searchInput2').on('keydown', function(e) {
      if (e.keyCode === 13) filterSalaryList();
    });
    $('#searchBtn2').on('click', filterSalaryList);
    $('#deptFilter2').on('change', filterSalaryList);
    $('#salaryMonthFilter').on('change', filterSalaryList);
    $('input[name="payStatusRadio"]').on('change', filterSalaryList);
    // ì´ˆê¸°í™” ì‹œ ìë™ ì¡°íšŒ
    $(function() {
      loadDashboard();
      loadDeptOptions2();
      filterSalaryList();
    });
    // TOAST UI Grid ë”ë¸”í´ë¦­ ì‹œ ì…€ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ
    grid.on('dblclick', function(ev) {
      if (ev.rowKey != null && ev.columnName) {
        grid.startEditing(ev.rowKey, ev.columnName);
      }
    });
    // ì¸ë¼ì¸ ì•¡ì…˜ í•¨ìˆ˜ ì˜ˆì‹œ
    window.viewDetail = function(empNo) {
      Swal.fire('ìƒì„¸ë³´ê¸°', 'ì‚¬ë²ˆ: '+empNo, 'info');
    }
    window.editSalary = function(empNo) {
      Swal.fire('ìˆ˜ì •', 'ì‚¬ë²ˆ: '+empNo, 'info');
    }
    window.printPayslip = function(empNo) {
      Swal.fire('ëª…ì„¸ì„œ ì¶œë ¥', 'ì‚¬ë²ˆ: '+empNo, 'info');
    }
    window.paySalary = function(empNo) {
      Swal.fire('ì§€ê¸‰ì²˜ë¦¬', 'ì‚¬ë²ˆ: '+empNo, 'success');
    }
    // ëª…ì„¸ì„œì¶œë ¥ ë²„íŠ¼
    $('#exportPayslipBtn').on('click', function() {
      Swal.fire('ëª…ì„¸ì„œì¶œë ¥', 'ì„ íƒëœ(ë˜ëŠ” ì „ì²´) ì‚¬ì›ì˜ ëª…ì„¸ì„œë¥¼ PDFë¡œ ì¶œë ¥í•©ë‹ˆë‹¤. (ì˜ˆì‹œ)', 'info');
    });
    // ëª…ì„¸ì„œ ì´ë©”ì¼ë°œì†¡ ë²„íŠ¼
    $('#emailPayslipBtn').on('click', function() {
      Swal.fire('ëª…ì„¸ì„œ ì´ë©”ì¼ë°œì†¡', 'ì„ íƒëœ(ë˜ëŠ” ì „ì²´) ì‚¬ì›ì˜ ëª…ì„¸ì„œë¥¼ ì´ë©”ì¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤. (ì˜ˆì‹œ)', 'info');
    });
    // í•­ëª©ì„¤ì • ë²„íŠ¼
    // ê¸‰ì—¬ê³„ì‚° ë²„íŠ¼ (ê³µì œí•©ê³„ ì§ì ‘ í•©ì‚°, NaN ì™„ì „ ë°©ì§€)
    function safeNumber(val) {
      if (val === undefined || val === null || val === '-' || val === '') return 0;
      if (typeof val === 'number') return val;
      if (typeof val === 'string') {
        const num = parseInt(val.replace(/[^0-9\-]/g, ''));
        return isNaN(num) ? 0 : num;
      }
      return 0;
    }
    $('#calcBtnHeader').off('click').on('click', function() {
      const checkedRowKeys = grid.getCheckedRowKeys();
      console.log(grid.getData());
      if (checkedRowKeys.length === 0) {
        Swal.fire('ì•Œë¦¼', 'ê³„ì‚°í•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.', 'info');
        return;
      }
      checkedRowKeys.forEach(rowKey => {
        const row = grid.getRow(rowKey);
        // ìˆ˜ë‹¹í•©ê³„
        const baseSal = safeNumber(row.baseSal);
        const otAllow = safeNumber(row.otAllow);
        const sal1 = safeNumber(row.sal1);
        const sal2 = safeNumber(row.sal2);
        // í•„ìš”ì‹œ sal3~sal10ë„ ì¶”ê°€
        const allowanceTotal = baseSal + otAllow + sal1 + sal2;
        grid.setValue(rowKey, 'allowanceTotal', allowanceTotal > 0 ? allowanceTotal.toLocaleString() + 'ì›' : 0);
        // ê³µì œí•©ê³„: deductionTotalê°€ ì—†ìœ¼ë©´ ê° í•­ëª© ì§ì ‘ í•©ì‚°
        let deductionTotal = safeNumber(row.deductionTotal);
        if (!deductionTotal) {
          deductionTotal =
            safeNumber(row.incTax) +
            safeNumber(row.natPension) +
            safeNumber(row.healthInsur) +
            safeNumber(row.empInsur) +
            safeNumber(row.ltcInsur);
        }
        grid.setValue(rowKey, 'deductionTotal', deductionTotal > 0 ? deductionTotal.toLocaleString() + 'ì›' : 0);
        // ì‹¤ìˆ˜ë ¹ì•¡: netSalary
        const netPay = allowanceTotal - deductionTotal;
        grid.setValue(rowKey, 'netSalary', !isNaN(netPay) ? netPay.toLocaleString() + 'ì›' : 0);
      });
      Swal.fire('âœ” ê³„ì‚° ì™„ë£Œ', 'ì„ íƒëœ í–‰ì˜ ì‹¤ìˆ˜ë ¹ì•¡ì´ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      console.log(grid.getData());
    });
    // ì¼ê´„ìŠ¹ì¸ ë²„íŠ¼
    $('#approveAllBtnHeader').on('click', function() {
      Swal.fire('ì¼ê´„ìŠ¹ì¸', 'ì„ íƒëœ ê¸‰ì—¬ëª…ì„¸ì„œë¥¼ ìŠ¹ì¸ ì²˜ë¦¬í•©ë‹ˆë‹¤. (ì˜ˆì‹œ)', 'info');
    });
    // ì¼ê´„ì§€ê¸‰ ë²„íŠ¼
    $('#payAllBtnHeader').on('click', function() {
      Swal.fire('ì¼ê´„ì§€ê¸‰', 'ì„ íƒëœ ê¸‰ì—¬ëª…ì„¸ì„œë¥¼ ì§€ê¸‰ ì²˜ë¦¬í•©ë‹ˆë‹¤. (ì˜ˆì‹œ)', 'info');
    });
    // --- ê¸‰ì—¬í•­ëª© ê´€ë¦¬ì™€ ë™ì¼í•œ ì¶”ê°€/ì‚­ì œ/ì €ì¥ ê¸°ëŠ¥ êµ¬í˜„ (salaryGrid ëŒ€ìƒ) ---
    // ì¶”ê°€ ë²„íŠ¼: ìƒˆ í–‰ ì¶”ê°€
    $('#addBtn2').off('click').on('click', function() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const todayStr = `${yyyy}-${mm}-${dd}`;
      grid.prependRow({
        empId: '', empName: '', deptName: '', baseSal: '', otAllow: '', netSalary: '', status: 'ss01', createdDate: todayStr
      }, { focus: true });
      setTimeout(() => {
        grid.focusAt(0, 'empId');
        const gridBody = document.querySelector('#salaryGrid .tui-grid-body-area');
        if (gridBody) gridBody.scrollTop = 0;
      }, 100);
      $('#saveBtn2').prop('disabled', false);
    });
    // ì‚­ì œ ë²„íŠ¼: ì²´í¬ëœ í–‰ ì‚­ì œ
    $('#deleteBtn2').off('click').on('click', function() {
      const checked = grid.getCheckedRowKeys();
      if (checked.length === 0) {
        Swal.fire('âš  ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', '', 'warning');
        return;
      }
      Swal.fire({
        title: 'ì„ íƒí•œ ê¸‰ì—¬ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        text: 'ì‚­ì œëœ í•­ëª©ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ì‚­ì œ',
        cancelButtonText: 'ì·¨ì†Œ'
      }).then((result) => {
        if (result.isConfirmed) {
          checked.forEach(rowKey => grid.removeRow(rowKey));
          Swal.fire('âœ” ì‚­ì œ ì™„ë£Œ', 'ì„ íƒí•œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          $('#deleteBtn2').prop('disabled', true);
        }
      });
    });
    // ì €ì¥ ë²„íŠ¼: ì‹ ê·œ/ìˆ˜ì • ë¶„ê¸° ë° í•„ìˆ˜ê°’ ì²´í¬(ìƒ˜í”Œ, ì‹¤ì œ ì €ì¥ì€ API ì—°ë™ í•„ìš”)
    $('#saveBtn2').off('click').on('click', function() {
      const { createdRows, updatedRows } = grid.getModifiedRows();
      if (createdRows.length === 0 && updatedRows.length === 0) {
        Swal.fire('ì•Œë¦¼', 'ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
        return;
      }
      // í•„ìˆ˜ê°’ ì²´í¬(ì‹ ê·œ)
      for (const row of createdRows) {
        if (!row.empId || !row.empName || !row.baseSal) {
          Swal.fire('âš  í•„ìˆ˜ ì…ë ¥', 'ì‚¬ì›ë²ˆí˜¸, ì‚¬ì›ëª…, ê¸°ë³¸ê¸‰ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.', 'warning');
          return;
        }
      }
      Swal.fire({
        title: 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        text: 'ì €ì¥ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ì €ì¥',
        cancelButtonText: 'ì·¨ì†Œ'
      }).then((result) => {
        if (result.isConfirmed) {
          // ì‹ ê·œ í–‰ ì €ì¥ ì „ salId ìë™ ìƒì„± (DB í†µì¼ ê·œì¹™: sal+ìˆ«ìì‚¬ë²ˆ+_+YYYYMM)
          createdRows.forEach(row => {
            if (!row.salId || row.salId === '') {
              let calcMonth = row.calcMonth;
              if (!calcMonth && row.createdDate) {
                const date = row.createdDate.split('T')[0] || row.createdDate;
                const parts = date.split('-');
                if (parts.length >= 2) calcMonth = parts[0] + '-' + parts[1];
              }
              if (row.empId && calcMonth) {
                // ì‚¬ì›ë²ˆí˜¸ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ, ê¸‰ì—¬ì›”ì—ì„œ í•˜ì´í”ˆ ì œê±°
                const empIdNum = row.empId.replace(/[^0-9]/g, '');
                const calcMonthNum = calcMonth.replace(/-/g, '');
                row.salId = 'sal' + empIdNum + '_' + calcMonthNum;
              }
            }
          });
          // --- salId ì¤‘ë³µ ì²´í¬ Ajax ì¶”ê°€ ---
          const salId = createdRows[0].salId;
          $.ajax({
            url: '/erp/hr/check-duplicate', // ê²½ë¡œ ìˆ˜ì •: /erp/hr/salary/check-duplicate â†’ /erp/hr/check-duplicate
            method: 'GET',
            data: { salId },
            success: function(isDuplicate) {
              if (isDuplicate === true || isDuplicate === 'true') {
                Swal.fire('âŒ ì¤‘ë³µ', 'ì´ë¯¸ ë“±ë¡ëœ ê¸‰ì—¬ëª…ì„¸ì…ë‹ˆë‹¤.', 'error');
                return;
              }
              // ì‹ ê·œ í–‰ ì €ì¥
              const saveCreated = createdRows.length > 0 ? $.ajax({
                url: '/erp/hr/add',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(createdRows[0]),
              }) : Promise.resolve();
              Promise.all([saveCreated]).then(() => {
                Swal.fire('âœ” ì €ì¥ ì™„ë£Œ', 'ì‹ ê·œ/ìˆ˜ì • í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // ê²€ìƒ‰ ì¡°ê±´ ì „ì²´ë¡œ ì´ˆê¸°í™” í›„ DBì—ì„œ ë‹¤ì‹œ ì¡°íšŒ
                $('#searchInput2').val('');
                $('#deptFilter2').val('');
                $('#salaryMonthFilter').val('');
                $('input[name="payStatusRadio"][value=""]').prop('checked', true);
                filterSalaryList();
                loadDashboard();
              }).catch(() => {
                Swal.fire('âŒ ì €ì¥ ì‹¤íŒ¨', 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
              });
            },
            error: function() {
              Swal.fire('âŒ ì˜¤ë¥˜', 'ì¤‘ë³µ ì²´í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
          });
        }
      });
    });
    // ê·¸ë¦¬ë“œ ë³€ê²½ ê°ì§€ â†’ ì €ì¥/ì‚­ì œ ë²„íŠ¼ í™œì„±í™”
    grid.on('afterChange', function(ev) {
      $('#saveBtn2').prop('disabled', false);
    });
    grid.on('check', function(ev) {
      $('#deleteBtn2').prop('disabled', grid.getCheckedRowKeys().length === 0);
    });
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜(ì„ì‹œ)
    window.downloadExcel = function(empNo) {
      Swal.fire('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ', 'ì‚¬ë²ˆ: '+empNo, 'success');
    }
    // ToastUI Grid í…Œë§ˆ ì ìš© (ê±°ë˜ì²˜ì™€ ë™ì¼)
    tui.Grid.applyTheme('default', {
      cell: { evenRow: { background: '#fafbfc' }, oddRow: { background: '#fff' } },
      row: { hover: { background: '#f1f3f5' } }
    });
    // ì‚¬ì›ëª©ë¡ ê·¸ë¦¬ë“œ ìƒì„±
    const empGrid = new tui.Grid({
      el: document.getElementById('empGrid'),
      scrollX: false,
      scrollY: true,
      bodyHeight: 350,
      pageOptions: { perPage: 10, useClient: true },
      columns: [
        {header: 'ì‚¬ì›ë²ˆí˜¸', name: 'empId', align: 'center'},
        {header: 'ì‚¬ì›ëª…', name: 'empName', align: 'center'},
        {header: 'ë¶€ì„œëª…', name: 'deptName', align: 'center'}, // editorëŠ” ë™ì ìœ¼ë¡œ ì„¸íŒ…
        {header: 'ì§ìœ„', name: 'positionName', align: 'center'},
        {header: 'ì…ì‚¬ì¼', name: 'hireDate', align: 'center'},
        {header: 'ì¬ì§ìƒíƒœ', name: 'empStatusName', align: 'center'},
        {header: 'ì—°ë½ì²˜', name: 'tel', align: 'center'}
      ]
    });
    // ì‚¬ì›ëª©ë¡ ê·¸ë¦¬ë“œ í´ë¦­ ì‹œ ë©”ì¸ ê·¸ë¦¬ë“œì— ê°’ ë°˜ì˜
    empGrid.on('click', function(ev) {
      if (!ev.targetType || ev.targetType !== 'cell') return;
      const row = empGrid.getRow(ev.rowKey);
      if (window.selectedEmpRowKey != null) {
        grid.setValue(window.selectedEmpRowKey, 'empId', row.empId);
        grid.setValue(window.selectedEmpRowKey, 'empName', row.empName);
        grid.setValue(window.selectedEmpRowKey, 'deptName', row.deptName);
        grid.setValue(window.selectedEmpRowKey, 'baseSal', row.sal); // ê¸°ë³¸ê¸‰ ìë™ ì…ë ¥
        $('#empModal').modal('hide');
      }
    });
    // ë©”ì¸ ê·¸ë¦¬ë“œ ì…€ í´ë¦­ ì‹œ ì‚¬ì› ê²€ìƒ‰ ëª¨ë‹¬ ì˜¤í”ˆ
    grid.on('click', function(ev) {
      if (!ev.targetType || ev.targetType !== 'cell') return;
      if (ev.columnName === 'empId' || ev.columnName === 'empName') {
        empModalOpen(ev.rowKey);
      }
    });
    // ì‚¬ì› ê²€ìƒ‰ ê¸°ëŠ¥
    $('#empSearchBtn').on('click', function() {
      empModalOpen(window.selectedEmpRowKey);
    });
    $('#empInput').on('keydown', function(e) {
      if (e.keyCode === 13) $('#empSearchBtn').click();
    });
    // ì‚¬ì› ê²€ìƒ‰ ëª¨ë‹¬ ì˜¤í”ˆ í•¨ìˆ˜
    async function empModalOpen(rowKey) {
      $('#empModal').modal('show');
      const type = $('#empSelect').val();
      const value = $('#empInput').val();
      let param = {};
      if (value) param.keyword = value;
     await $.ajax({
        url: '/erp/hr/empListAjax',
        method: 'GET',
        data: param,
         success: function(result) {
           empGrid.resetData(result);
        }
      });
      window.selectedEmpRowKey = rowKey;
    }
    $('#empModal').on('shown.bs.modal', function(){
      empGrid.refreshLayout();
    })
    // ë©”ì¸ ê·¸ë¦¬ë“œ ë¶€ì„œëª… ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë™ì  ì„¸íŒ…
    let mainDeptOptions = [];
    function loadDeptOptionsForMainGrid() {
      $.get('/erp/hr/dept', function(list) {
        mainDeptOptions = list.map(d => ({ text: d.deptName, value: d.deptName }));
        grid.setColumns(grid.getColumns().map(col => {
          if (col.name === 'deptName') {
            return {
              ...col,
              editor: { type: 'select', options: { listItems: mainDeptOptions } }
            };
          }
          return col;
        }));
        grid.refreshLayout();
      });
    }
    $(function() {
      loadDeptOptionsForMainGrid();
    });
    // ì§€ê¸‰ìƒíƒœ ë³€ê²½ í•¨ìˆ˜
    window.approveStatus = function(rowKey) {
      grid.setValue(rowKey, 'status', 'ìŠ¹ì¸');
      Swal.fire('ìŠ¹ì¸ ì²˜ë¦¬', 'í•´ë‹¹ ê¸‰ì—¬ëª…ì„¸ì„œê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    };
    window.payStatus = function(rowKey) {
      grid.setValue(rowKey, 'status', 'ì§€ê¸‰ì™„ë£Œ');
      Swal.fire('ì§€ê¸‰ì™„ë£Œ ì²˜ë¦¬', 'í•´ë‹¹ ê¸‰ì—¬ëª…ì„¸ì„œê°€ ì§€ê¸‰ì™„ë£Œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    };
  </script>
</body>
</html> 
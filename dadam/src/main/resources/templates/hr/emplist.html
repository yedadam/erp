<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">

<head>
<meta charset="UTF-8">
<title>사원 관리</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.min.css">
<style>
body {
	font-family: 'Pretendard', sans-serif;
	background-color: #f8fafc;
}

.erp-main {
	display: flex;
	gap: 20px;
	padding-top: 7px;
	/* 상단만 8px로 줄임 */
	padding-right: 24px;
	padding-bottom: 24px;
	padding-left: 24px;
	/* 왼쪽은 기존 24px 유지 */
	height: calc(100vh - 64px);
	/* 헤더, 푸터 고려 */
	box-sizing: border-box;
}

.erp-list {
	flex: 5;
	background: #fff;
	border-radius: 12px;
	padding: 20px;
	box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
	height: 750px;
	overflow-y: visible;
}

.erp-form {
	flex: 5;
	background: #fff;
	border-radius: 12px;
	padding: 20px;
	box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
	height: 750px;
	overflow-y: visible;
}

.form-tab {
	cursor: pointer;
}

.form-section {
	display: none;
}

.form-section.active {
	display: block;
}

#profilePreview {
	width: 48px;
	height: 48px;
	object-fit: cover;
	border-radius: 50%;
}

/* 커스텀 탭 스타일 */
.nav-tabs {
	border-bottom: 1px solid #e5e7eb;
}

.nav-tabs .nav-link {
	color: #2563eb;
	border: 1px solid transparent;
	background: #f8fafc;
	font-weight: 500;
	border-radius: 8px 8px 0 0;
	margin-right: 2px;
	transition: background 0.2s, color 0.2s;
}

.nav-tabs .nav-link.active {
	color: #222;
	background: #fff;
	border: 1px solid #dee2e6;
	border-bottom: 2px solid #fff;
	font-weight: 700;
	z-index: 2;
}

.nav-tabs .nav-link:not(.active):hover {
	color: #1d4ed8;
	background: #f0f6ff;
}

.erp-list .tui-pagination {
	display: flex;
	justify-content: center;
	align-items: center;
	margin-top: 20px !important;
	margin-bottom: 20px !important;
}

#empGrid {
	width: 100%;
}

.btn-group-custom { margin-bottom: 20px; }
.search-container { margin-bottom: 20px; }
.tui-pagination { padding-bottom: 10px; }
</style>
</head>

<body>
	<div layout:fragment="content">
		<div class="erp-main">
			<div class="erp-list">
				<h4 class="mb-3">사원 관리</h4>
				<div class="input-group mb-2">
					<input type="text" id="searchInput" class="form-control"
						placeholder="사원명/부서명/사원번호 검색">
					<button class="btn btn-primary" id="btnSearch">검색</button>
				</div>
				<select id="statusFilter" class="form-select mb-3">
					<option value="">전체</option>
					<option th:each="st : ${empStatuses}" th:value="${st.value}" th:text="${st.text}"></option>
				</select>
				<div id="empGrid" style="height: 650px;"></div>
			</div>
			<form id="empForm" class="erp-form" autocomplete="off">
				<input type="hidden" id="comId" name="comId" value="COM-101">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<h4 class="mb-0">사원 정보</h4>
					<div class="d-flex gap-2">
						<button type="button" id="btnNew" class="btn btn-outline-primary">
							<i class="bi bi-plus"></i> 신규
						</button>
						<button type="button" id="btnSave" class="btn btn-success">
							<i class="bi bi-save"></i> 저장
						</button>
						<button type="button" id="btnDelete" class="btn btn-danger">
							<i class="bi bi-trash"></i> 삭제
						</button>
					</div>
				</div>


				<!-- 탭 네비게이션 -->
				<ul class="nav nav-tabs" id="empTabs">
					<li class="nav-item"><a class="nav-link active form-tab"
						data-target="basicInfo">기본정보</a></li>
					<li class="nav-item"><a class="nav-link form-tab"
						data-target="jobInfo">근무정보</a></li>
					<li class="nav-item"><a class="nav-link form-tab"
						data-target="contractInfo">근로계약</a></li>
					<li class="nav-item"><a class="nav-link form-tab"
						data-target="leaveInfo">연차/휴가</a></li>
					<li class="nav-item"><a class="nav-link form-tab"
						data-target="attendanceInfo">근태관리</a></li>
					<li class="nav-item"><a class="nav-link form-tab"
						data-target="payInfo">급여정보</a></li>
					<li class="nav-item"><a class="nav-link form-tab"
						data-target="resignInfo">퇴직정보</a></li>
				</ul>
				<div class="mt-3">
					<!-- 기본정보 -->
					<div id="basicInfo" class="form-section active">
						<div class="mb-3">
							<label class="form-label">사원번호</label> <input type="text"
								id="empId" name="empId" class="form-control" readonly>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">성명<span class="text-danger">*</span></label>
								<input type="text" id="empName" name="empName"
									class="form-control" required>
							</div>
							<div class="col-md-6">
								<label class="form-label">생년월일</label> <input type="date"
									id="birthDate" name="birthDate" class="form-control">
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">비밀번호<span class="text-danger">*</span></label>
								<input type="password" id="pwd" name="pwd" class="form-control" 
									placeholder="초기 비밀번호 입력" required>
								<small class="form-text text-muted">사원이 로그인 후 변경할 수 있습니다.</small>
							</div>
							<div class="col-md-6">
								<label class="form-label">비밀번호 확인<span class="text-danger">*</span></label>
								<input type="password" id="pwdConfirm" name="pwdConfirm" class="form-control" 
									placeholder="비밀번호 재입력" required>
							</div>
						</div>
						<div class="mb-3">
							<label class="form-label">주소</label>
							<div class="input-group">
								<input type="text" id="addr" name="addr" class="form-control"
									readonly>
								<button type="button" id="btnAddr"
									class="btn btn-outline-secondary">주소검색</button>
							</div>
							<input type="text" id="addrDetail" name="addrDetail"
								class="form-control mt-2" placeholder="상세주소">
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">연락처</label> <input type="text"
									id="tel" name="tel" class="form-control">
							</div>
							<div class="col-md-6">
								<label class="form-label">이메일</label> <input type="email"
									id="email" name="email" class="form-control">
							</div>
						</div>
						<div class="mb-3">
							<label class="form-label">사진</label> <input type="file"
								id="profileImg" name="profileImg" class="form-control">
							<img id="profilePreview" src="/static/img/user-default.png"
								class="mt-2" alt="미리보기">
						</div>
					</div>
					<!-- 근무정보 -->
					<div id="jobInfo" class="form-section">
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">부서<span class="text-danger">*</span></label>
								<select id="deptCode" name="deptCode" class="form-select"
									required>
									<option value="">선택</option>
									<option th:each="dept : ${departments}"
										th:value="${dept.deptCode}" th:text="${dept.deptName}">
									</option>
								</select>
							</div>
							<div class="col-md-6">
								<label class="form-label">직급<span class="text-danger">*</span></label>
								<select id="position" name="position" class="form-select"
									required>
									<option value="">선택</option>
									<option th:each="pos : ${positions}" th:value="${pos.value}" th:text="${pos.text}"></option>
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">입사일자</label> <input type="date"
									id="hireDate" name="hireDate" class="form-control">
							</div>
							<div class="col-md-6">
								<label class="form-label">입사구분</label> <select id="workType"
									name="workType" class="form-select">
									<option value="">선택</option>
									<option th:each="wt : ${workTypes}" th:value="${wt.value}" th:text="${wt.text}"></option>
								</select>
							</div>
						</div>
						<div class="mb-3">
							<label class="form-label">재직상태</label> <select id="empStatus"
								name="empStatus" class="form-select">
								<option value="">선택</option>
								<option th:each="st : ${empStatuses}" th:value="${st.value}" th:text="${st.text}"></option>
							</select>
						</div>
					</div>
					<!-- 근로계약정보 -->
					<div id="contractInfo" class="form-section">
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">계약 유형</label>
								<select id="contractType" name="contractType" class="form-select">
									<option value="">선택</option>
									<option th:each="wt : ${workTypes}" th:value="${wt.value}" th:text="${wt.text}"></option>
								</select>
							</div>
							<div class="col-md-6">
								<label class="form-label">계약 시작일</label>
								<input type="date" id="contractStartDate" name="contractStartDate" class="form-control">
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">계약 종료일</label>
								<input type="date" id="contractEndDate" name="contractEndDate" class="form-control">
							</div>
							<div class="col-md-6">
								<label class="form-label">수습기간(개월)</label>
								<input type="number" id="probationPeriod" name="probationPeriod" class="form-control" min="0" max="12" placeholder="0">
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">연봉(원)</label>
								<input type="number" id="annualSalary" name="annualSalary" class="form-control" min="0" step="1000000" placeholder="예: 30000000">
							</div>
							<div class="col-md-6">
								<label class="form-label">월급(원)</label>
								<input type="number" id="monthlySalary" name="monthlySalary" class="form-control" min="0" step="10000" placeholder="예: 2500000">
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">상여금(원)</label>
								<input type="number" id="bonus" name="bonus" class="form-control" min="0" step="100000" placeholder="예: 3000000">
							</div>
							<div class="col-md-6">
								<label class="form-label">추가수당(원)</label>
								<input type="number" id="additionalAllowance" name="additionalAllowance" class="form-control" min="0" step="10000" placeholder="예: 200000">
							</div>
						</div>
					</div>
					<!-- 연차/휴가정보 -->
					<div id="leaveInfo" class="form-section">
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">연차 총일수</label>
								<input type="number" id="annualLeaveTotal" name="annualLeaveTotal" class="form-control" min="0" max="365" placeholder="15">
							</div>
							<div class="col-md-6">
								<label class="form-label">연차 사용일수</label>
								<input type="number" id="annualLeaveUsed" name="annualLeaveUsed" class="form-control" min="0" max="365" placeholder="0">
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">연차 잔여일수</label>
								<input type="number" id="annualLeaveRemain" name="annualLeaveRemain" class="form-control" min="0" max="365" placeholder="15" readonly>
							</div>
							<div class="col-md-6">
								<label class="form-label">휴가 정책</label>
								<select id="leavePolicy" name="leavePolicy" class="form-select">
									<option value="">선택</option>
									<option value="연차">연차</option>
									<option value="반차">반차</option>
									<option value="병가">병가</option>
									<option value="공가">공가</option>
									<option value="특별휴가">특별휴가</option>
								</select>
							</div>
						</div>
					</div>
					<!-- 근태관리정보 -->
					<div id="attendanceInfo" class="form-section">
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">근무 유형</label>
								<select id="workPattern" name="workPattern" class="form-select">
									<option value="">선택</option>
									<option value="일반">일반</option>
									<option value="야간">야간</option>
									<option value="교대">교대</option>
									<option value="재택">재택</option>
								</select>
							</div>
							<div class="col-md-6">
								<label class="form-label">근무 패턴</label>
								<select id="workSchedule" name="workSchedule" class="form-select">
									<option value="">선택</option>
									<option value="월~금">월~금</option>
									<option value="월~토">월~토</option>
									<option value="화~토">화~토</option>
									<option value="교대근무">교대근무</option>
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">출근 시간</label>
								<input type="time" id="workStartTime" name="workStartTime" class="form-control" value="09:00">
							</div>
							<div class="col-md-6">
								<label class="form-label">퇴근 시간</label>
								<input type="time" id="workEndTime" name="workEndTime" class="form-control" value="18:00">
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">점심시간 시작</label>
								<input type="time" id="lunchStartTime" name="lunchStartTime" class="form-control" value="12:00">
							</div>
							<div class="col-md-6">
								<label class="form-label">점심시간 종료</label>
								<input type="time" id="lunchEndTime" name="lunchEndTime" class="form-control" value="13:00">
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">연장근무 허용</label>
								<select id="overtimeAllowed" name="overtimeAllowed" class="form-select">
									<option value="Y">허용</option>
									<option value="N">불허</option>
								</select>
							</div>
						</div>
					</div>
					<!-- 퇴직정보 -->
					<div id="resignInfo" class="form-section">
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">퇴사일자</label> <input type="date"
									id="resignDate" name="resignDate" class="form-control">
							</div>
							<div class="col-md-6">
								<label class="form-label">퇴사사유</label> <select id="resignReason"
									name="resignReason" class="form-select"></select>
							</div>
						</div>
					</div>
					<!-- 급여정보 -->
					<div id="payInfo" class="form-section">
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">급여통장 은행</label> <input type="text"
									id="bank" name="bank" class="form-control">
							</div>
							<div class="col-md-6">
								<label class="form-label">계좌번호</label> <input type="text"
									id="acctNo" name="acctNo" class="form-control">
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">기본급(원)</label>
								<input type="number" id="sal" name="sal" class="form-control" min="0" step="10000" placeholder="예: 2500000">
							</div>
							<div class="col-md-6">
								<label class="form-label">급여 지급일</label>
								<select id="payDay" name="payDay" class="form-select">
									<option value="25">25일</option>
									<option value="20">20일</option>
									<option value="15">15일</option>
									<option value="10">10일</option>
									<option value="5">5일</option>
								</select>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">세금 계산 방식</label>
								<select id="taxCalculation" name="taxCalculation" class="form-select">
									<option value="종합소득세">종합소득세</option>
									<option value="분리과세">분리과세</option>
									<option value="비과세">비과세</option>
								</select>
							</div>
							<div class="col-md-6">
								<label class="form-label">공제 항목</label>
								<div id="deductionTypeGroup" class="form-check d-flex flex-column flex-wrap" style="gap: 8px 0; min-width: 120px;">
									<div class="form-check mb-1">
										<input class="form-check-input" type="checkbox" name="deductionType" value="4대보험" id="deduct4insur">
										<label class="form-check-label ms-2" for="deduct4insur">4대보험</label>
									</div>
									<div class="form-check mb-1">
										<input class="form-check-input" type="checkbox" name="deductionType" value="소득세" id="deductIncome">
										<label class="form-check-label ms-2" for="deductIncome">소득세</label>
									</div>
									<div class="form-check mb-1">
										<input class="form-check-input" type="checkbox" name="deductionType" value="지방세" id="deductLocal">
										<label class="form-check-label ms-2" for="deductLocal">지방세</label>
									</div>
									<div class="form-check mb-1">
										<input class="form-check-input" type="checkbox" name="deductionType" value="기타공제" id="deductEtc">
										<label class="form-check-label ms-2" for="deductEtc">기타공제</label>
									</div>
								</div>
								<input type="hidden" id="deductionTypeHidden" name="deductionType">
								<script>
								// 체크박스 값 변경 시 hidden에 콤마로 join
								$('#deductionTypeGroup input[type=checkbox]').on('change', function() {
									const vals = $('#deductionTypeGroup input[type=checkbox]:checked').map(function(){return this.value;}).get();
									$('#deductionTypeHidden').val(vals.join(','));
								});
								</script>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-6">
								<label class="form-label">식대 지원(원)</label>
								<input type="number" id="mealAllowance" name="mealAllowance" class="form-control" min="0" step="1000" placeholder="예: 300000">
							</div>
							<div class="col-md-6">
								<label class="form-label">교통비 지원(원)</label>
								<input type="number" id="transportAllowance" name="transportAllowance" class="form-control" min="0" step="1000" placeholder="예: 100000">
							</div>
						</div>
						<div class="mb-3">
							<label class="form-label">적요</label> <input type="text" id="note"
								name="note" class="form-control">
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- Bootstrap JS 추가 (jQuery 다음) -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.min.js"></script>
	<script
		src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script th:inline="javascript">
    // 탭 전환 스크립트 (커스텀)
    $(function () {
      $('.form-tab').click(function (e) {
        e.preventDefault();
        $('.form-tab').removeClass('active');
        $(this).addClass('active');
        $('.form-section').removeClass('active');
        $('#' + $(this).data('target')).addClass('active');
      });
      $('.form-tab').first().click();
    });

    // 재직상태 코드/명칭 매핑
    const EMP_STATUS_CODES = [
      { value: '', label: '전체' },
      { value: 'stt01', label: '재직' },
      { value: 'stt02', label: '퇴사' },
      { value: 'stt03', label: '휴직' }
    ];
    // select 옵션 동적 세팅
    function setSelectOptions(callback) {
      const posPromise = $.get('/api/common/codes?mainCode=pos').then(data => {
        $('#position').empty().append('<option value="">선택</option>');
        data.forEach(item => {
          $('#position').append(`<option value="${item.value}">${item.text}</option>`);
        });
      }).catch(() => {});

      const empPromise = $.get('/api/common/codes?mainCode=emp').then(data => {
        $('#workType').empty().append('<option value="">선택</option>');
        data.forEach(item => {
          $('#workType').append(`<option value="${item.value}">${item.text}</option>`);
        });
      }).catch(() => {});

      // 재직상태, 퇴사사유 등은 동기 처리
      $('#empStatus').empty();
      EMP_STATUS_CODES.forEach(opt => {
        // '재직'이 가장 먼저 오도록
        if(opt.value === 'stt01') $('#empStatus').append(`<option value="${opt.value}">${opt.label}</option>`);
      });
      EMP_STATUS_CODES.forEach(opt => {
        if(opt.value !== '' && opt.value !== 'stt01') $('#empStatus').append(`<option value="${opt.value}">${opt.label}</option>`);
      });
      // '선택' 옵션은 마지막에 추가(원하면 주석처리 가능)
      $('#empStatus').append('<option value="">선택</option>');
      $('#resignReason').empty().append('<option value="">선택</option>');
      RESIGN_REASONS.forEach(v => $('#resignReason').append(`<option value="${v}">${v}</option>`));

      Promise.all([posPromise, empPromise]).then(() => {
        if (typeof callback === 'function') callback();
      });
    }
    // 상태 필터 셀렉트도 코드값 기반으로 동적 생성
    $('#statusFilter').empty();
    EMP_STATUS_CODES.forEach(opt => {
      $('#statusFilter').append(`<option value="${opt.value}">${opt.label}</option>`);
    });

    // Toast UI Grid 생성 및 컬럼 정의 (조회/선택만, 6개 컬럼)
    const empGrid = new tui.Grid({
      el: document.getElementById('empGrid'),
      rowHeaders: ['checkbox'],
      scrollX: true,
      scrollY: true,
      theme: 'clean',
      bodyHeight: 480,
      columns: [
        { header: '사원번호', name: 'empId', align: 'center', minWidth: 80, resizable: true },
        { header: '성명', name: 'empName', align: 'center', minWidth: 100, resizable: true },
        { header: '부서명', name: 'deptName', align: 'center', minWidth: 100, resizable: true },
        { header: '직급', name: 'positionName', align: 'center', minWidth: 80, resizable: true },
        { header: '재직상태', name: 'empStatusName', align: 'center', minWidth: 100, resizable: true },
        { header: '근무유형', name: 'workTypeName', align: 'center', minWidth: 120, resizable: true }
      ]
    });

    // 데이터 불러오기 (검색/필터 반영)
    function loadEmpList() {
      const keyword = $('#searchInput').val();
      let status = $('#statusFilter').val();
      if (status === '') status = undefined; // 전체 선택 시 파라미터 제거
      const comId = $('#comId').val() || 'com-101'; // 회사ID 히든필드에서 가져오기
      $.ajax({
        url: '/erp/hr/empListAjax',
        method: 'GET',
        data: { keyword, status, comId }, // comId도 함께 전송
        success: function (data) { empGrid.resetData(data); }
      });
    }

    // 그리드 row 클릭 시 폼에 데이터 채우기
    empGrid.on('click', ev => {
      const row = empGrid.getRow(ev.rowKey);
      if (row) fillEmpForm(row);
    });

    // 폼 채우기 함수 (select 값도 세팅)
    function fillEmpForm(row) {
      // 디버깅: 실제 조회되는 데이터 확인
      console.log('사원 정보 조회:', row);
      console.log('근태관리 정보:', {
        workPattern: row.workPattern,
        workSchedule: row.workSchedule,
        workStartTime: row.workStartTime,
        workEndTime: row.workEndTime
      });
      
      $('#empId').val(row.empId);
      $('#comId').val(row.comId || 'COM-101');
      $('#empName').val(row.empName);
      $('#birthDate').val(row.birthDate ? row.birthDate.substr(0, 10) : '');
      
      // 비밀번호 필드는 비워둠 (보안상)
      $('#pwd').val('');
      $('#pwdConfirm').val('');
      
      $('#addr').val(row.addr);
      $('#addrDetail').val(row.addrDetail || '');
      $('#tel').val(row.tel);
      $('#email').val(row.email);
      $('#deptCode').val(row.deptCode);
      $('#position').val(row.position);
      $('#hireDate').val(row.hireDate ? row.hireDate.substr(0, 10) : '');
      $('#workType').val(row.workType);
      $('#empStatus').val(row.empStatus);
      
      // 근로계약 정보
      $('#contractType').val(row.contractType || row.workType || '정규직');
      $('#contractStartDate').val(row.contractStartDate ? row.contractStartDate.substr(0, 10) : (row.hireDate ? row.hireDate.substr(0, 10) : ''));
      $('#contractEndDate').val(row.contractEndDate ? row.contractEndDate.substr(0, 10) : '');
      $('#probationPeriod').val(row.probationPeriod || 0);
      $('#annualSalary').val(row.annualSalary || (row.sal ? row.sal * 12 : ''));
      $('#monthlySalary').val(row.monthlySalary || row.sal || '');
      $('#bonus').val(row.bonus || 0);
      $('#additionalAllowance').val(row.additionalAllowance || 0);
      
      // 연차/휴가 정보
      $('#annualLeaveTotal').val(row.annualLeaveTotal || 15);
      $('#annualLeaveUsed').val(row.annualLeaveUsed || 0);
      $('#annualLeaveRemain').val(row.annualLeaveRemain || 15);
      $('#leavePolicy').val(row.leavePolicy || '');
      
      // 근태관리 정보
      // 근무유형에 따른 기본 근태관리 정보 설정
      const workType = row.workType || '정규직';
      let defaultWorkPattern = '8시간';
      let defaultWorkSchedule = '주5일';
      let defaultStartTime = '09:00';
      let defaultEndTime = '18:00';
      
      // 근무유형별 기본값 설정
      if (workType === '정규직') {
        defaultWorkPattern = '8시간';
        defaultWorkSchedule = '주5일';
        defaultStartTime = '09:00';
        defaultEndTime = '18:00';
      } else if (workType === '계약직') {
        defaultWorkPattern = '8시간';
        defaultWorkSchedule = '주5일';
        defaultStartTime = '09:00';
        defaultEndTime = '18:00';
      } else if (workType === '인턴') {
        defaultWorkPattern = '6시간';
        defaultWorkSchedule = '주5일';
        defaultStartTime = '10:00';
        defaultEndTime = '17:00';
      } else if (workType === '파트타임') {
        defaultWorkPattern = '4시간';
        defaultWorkSchedule = '주3일';
        defaultStartTime = '10:00';
        defaultEndTime = '15:00';
      }
      
      $('#workPattern').val(row.workPattern || defaultWorkPattern);
      $('#workSchedule').val(row.workSchedule || defaultWorkSchedule);
      $('#workStartTime').val(row.workStartTime || defaultStartTime);
      $('#workEndTime').val(row.workEndTime || defaultEndTime);
      $('#lunchStartTime').val(row.lunchStartTime || '12:00');
      $('#lunchEndTime').val(row.lunchEndTime || '13:00');
      $('#overtimeAllowed').val(row.overtimeAllowed || 'Y');
      
      // 급여 정보
      $('#bank').val(row.bank);
      $('#acctNo').val(row.acctNo);
      $('#sal').val(row.sal);
      $('#payDay').val(row.payDay || '25');
      $('#taxCalculation').val(row.taxCalculation || '종합소득세');
      $('#deductionTypeHidden').val(row.deductionType || '4대보험,소득세,지방세,기타공제'); // 체크박스 값 설정
      $('#note').val(row.note);
      
      // 사원별 급여항목 정보 가져오기
      if (row.empId) {
        $.get('/erp/hr/empAllowances', { empId: row.empId, comId: row.comId }, function(allowances) {
          // 급여항목 정보 설정 (대소문자 모두 대응)
          allowances.forEach(function(allowance) {
            const code = allowance.ALLOW_CODE || allowance.allowCode;
            const amount = allowance.AMOUNT || allowance.amount || 0;
            if (code === 'MEAL') {
              $('#mealAllowance').val(amount);
            } else if (code === 'TRANSPORT') {
              $('#transportAllowance').val(amount);
            }
          });
        }).fail(function() {
          // 급여항목 조회 실패 시 기본값 설정
          $('#mealAllowance').val(0);
          $('#transportAllowance').val(0);
        });
      } else {
        // 사원번호가 없으면 기본값 설정
        $('#mealAllowance').val(0);
        $('#transportAllowance').val(0);
      }
      
      // 공제항목 체크박스 설정
      const deductionTypes = (row.deductionType || '4대보험,소득세,지방세,기타공제').split(',');
      $('#deductionTypeGroup input[type=checkbox]').each(function() {
        const val = $(this).val();
        $(this).prop('checked', deductionTypes.includes(val));
      });
      
      // 퇴직 정보
      $('#resignDate').val(row.resignDate ? row.resignDate.substr(0, 10) : '');
      $('#resignReason').val(row.resignReason);
      
      $('#profilePreview').attr('src', row.profileImgPath || '');
      
      // 연차 잔여일수 자동 계산
      calculateAnnualLeaveRemain();
    }

    // 검색/필터 이벤트 바인딩
    $('#btnSearch').on('click', loadEmpList);
    $('#searchInput').on('keydown', function (e) { if (e.key === 'Enter') loadEmpList(); });
    $('#statusFilter').on('change', loadEmpList);

    // 연차 잔여일수 자동 계산 함수
    function calculateAnnualLeaveRemain() {
      const total = parseInt($('#annualLeaveTotal').val()) || 0;
      const used = parseInt($('#annualLeaveUsed').val()) || 0;
      const remain = Math.max(0, total - used);
      $('#annualLeaveRemain').val(remain);
    }
    
    // 연차 관련 필드 변경 시 자동 계산
    $('#annualLeaveTotal, #annualLeaveUsed').on('input', calculateAnnualLeaveRemain);
    
    // 사진 미리보기 기능 추가
    $('#profileImg').on('change', function() {
      const input = this;
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          $('#profilePreview').attr('src', e.target.result).show();
        }
        reader.readAsDataURL(input.files[0]);
      } else {
        $('#profilePreview').attr('src', '/static/img/user-default.png');
      }
    });

    // 저장 (신규/수정 통합) - 응답이 문자열일 때도 처리
    $('#btnSave').on('click', function () {
      // 필수값 체크
      const empName = $('#empName').val().trim();
      const deptCode = $('#deptCode').val();
      const position = $('#position').val();
      if (!empName) { alert('성명을 입력하세요.'); $('#empName').focus(); return; }
      if (!deptCode) { alert('부서를 선택하세요.'); $('#deptCode').focus(); return; }
      if (!position) { alert('직급을 선택하세요.'); $('#position').focus(); return; }
      
      // 비밀번호 확인 검증 (신규 등록 시에만)
      const currentEmpId = $('#empId').val();
      if (!currentEmpId) { // 신규 등록인 경우
        const pwd = $('#pwd').val();
        const pwdConfirm = $('#pwdConfirm').val();
        if (!pwd) { alert('비밀번호를 입력하세요.'); $('#pwd').focus(); return; }
        if (!pwdConfirm) { alert('비밀번호 확인을 입력하세요.'); $('#pwdConfirm').focus(); return; }
        if (pwd !== pwdConfirm) { alert('비밀번호가 일치하지 않습니다.'); $('#pwdConfirm').focus(); return; }
      }
      
      // ... 필요시 추가 필수값 체크

      const form = document.getElementById('empForm');
      const formData = new FormData(form);
      const empId = $('#empId').val();
      $.get('/erp/hr/empDetail', { empId }, function(data) {
        const isUpdate = (data && data.empId);
        const url = isUpdate ? '/erp/hr/updateEmp' : '/erp/hr/insertEmp';
        $.ajax({
          url: url,
          method: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function (res) {
            if (typeof res === 'string') {
              if (res === 'ok') {
                alert(isUpdate ? '수정 완료!' : '등록 완료!');
                loadEmpList();
                $('#btnNew').click();
              } else if (res === 'unauthorized') {
                alert('권한이 없습니다.');
              } else {
                alert(isUpdate ? '수정 실패' : '등록 실패');
              }
            } else if (res && res.success) {
              alert(res.message || (isUpdate ? '수정 완료!' : '등록 완료!'));
              loadEmpList();
              $('#btnNew').click();
            } else {
              alert(res && res.message ? res.message : (isUpdate ? '수정 실패' : '등록 실패'));
            }
          },
          error: function (xhr) { alert((isUpdate ? '수정' : '등록') + ' 실패: ' + xhr.responseText); }
        });
      });
    });

    // 삭제 - 응답이 문자열일 때도 처리
    $('#btnDelete').on('click', function () {
      const empId = $('#empId').val();
      const comId = $('#comId').val(); // comId도 같이 전송
      if (!empId) { alert('사원을 선택하세요'); return; }
      if (!confirm('정말 삭제하시겠습니까?')) return;
      $.ajax({
        url: '/erp/hr/deleteEmp',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ empId, comId }),
        success: function (res) {
          if (typeof res === 'string') {
            if (res === 'ok') {
              alert('삭제 완료!');
              loadEmpList();
              $('#empForm')[0].reset();
            } else if (res === 'unauthorized') {
              alert('권한이 없습니다.');
            } else {
              alert('삭제 실패');
            }
          } else if (res && res.success) {
            alert(res.message || '삭제 완료!');
            loadEmpList();
            $('#empForm')[0].reset();
          } else {
            alert(res && res.message ? res.message : '삭제 실패');
          }
        },
        error: function (xhr) { alert('삭제 실패: ' + xhr.responseText); }
      });
    });

    // 최초 로드시 전체 목록 조회
    $(function () {
      loadEmpList(); // 페이지 진입 시 바로 목록 조회
    });

    // 주소 검색 버튼 클릭 시 카카오 주소 API
    $('#btnAddr').on('click', function () {
      new daum.Postcode({
        oncomplete: function (data) {
          $('#addr').val(data.address);
          $('#addrDetail').focus();
        }
      }).open();
    });

    // 신규 버튼 클릭 시 폼을 완전히 초기화하고, 사번 자동생성 (백엔드에서 nextEmpId API 호출)
    $('#btnNew').off('click').on('click', function () {
      $('#empForm')[0].reset();
      $.get('/erp/hr/nextEmpId', function(nextEmpId) {
        $('#empId').val(nextEmpId);
      });
      $('#profilePreview').attr('src', '/static/img/user-default.png');
      
      // 새로운 필드들의 기본값 설정
      $('#annualLeaveTotal').val('15');
      $('#annualLeaveUsed').val('0');
      $('#annualLeaveRemain').val('15');
      
      // 급여 필드 초기화 (부서/직급 선택 전에는 빈 값)
      $('#mealAllowance').val('');
      $('#transportAllowance').val('');
      $('#sal').val('');
      $('#bank').val('');
      $('#acctNo').val('');
      $('#annualSalary').val('');
      $('#monthlySalary').val('');
      $('#bonus').val('');
      $('#allowance').val('');
      $('#basicSalary').val('');
      $('#deductionTypeHidden').val('');
      $('#workStartTime').val('09:00');
      $('#workEndTime').val('18:00');
      $('#lunchStartTime').val('12:00');
      $('#lunchEndTime').val('13:00');
      $('#overtimeAllowed').val('Y');
      $('#payDay').val('25');
      $('#taxCalculation').val('종합소득세');
      $('#deductionTypeHidden').val('4대보험,소득세,지방세,기타공제'); // 체크박스 값 설정
      $('#contractType').val('emp01'); // 정규직
      $('#empStatus').val('stt01'); // 재직상태 기본값을 '재직'으로 설정
      
      // 급여정보 초기화 (부서/직급 선택 전에는 빈 값)
      $('#mealAllowance').val('');
      $('#transportAllowance').val('');
      
      // 근로계약 초기화 (부서/직급 선택 전에는 빈 값)
      $('#annualSalary').val('');
      $('#monthlySalary').val('');
      $('#bonus').val('');
      $('#additionalAllowance').val('');
      
      // 근태관리 기본값 설정
      $('#workPattern').val('일반');
      $('#workSchedule').val('주5일');
      
      setSelectOptions(function() {
        // 옵션 세팅 후 기본값 세팅
        $('#workType').val('emp01'); // 정규직
        $('#contractType').val('emp01'); // 정규직
        $('#empStatus').val('stt01'); // 재직
      });
      $('.form-tab').removeClass('active');
      $('.form-tab[data-target="basicInfo"]').addClass('active');
      $('.form-section').removeClass('active');
      $('#basicInfo').addClass('active');
    });

    // 비밀번호 확인 기능
    $('#pwdConfirm').on('input', function() {
      const pwd = $('#pwd').val();
      const pwdConfirm = $(this).val();
      
      if (pwd && pwdConfirm) {
        if (pwd === pwdConfirm) {
          $(this).removeClass('is-invalid').addClass('is-valid');
          $('#pwd').removeClass('is-invalid').addClass('is-valid');
        } else {
          $(this).removeClass('is-valid').addClass('is-invalid');
          $('#pwd').removeClass('is-valid').addClass('is-invalid');
        }
      } else {
        $(this).removeClass('is-valid is-invalid');
        $('#pwd').removeClass('is-valid is-invalid');
      }
    });
    
    $('#pwd').on('input', function() {
      const pwd = $(this).val();
      const pwdConfirm = $('#pwdConfirm').val();
      
      if (pwdConfirm) {
        if (pwd === pwdConfirm) {
          $(this).removeClass('is-invalid').addClass('is-valid');
          $('#pwdConfirm').removeClass('is-invalid').addClass('is-valid');
        } else {
          $(this).removeClass('is-valid').addClass('is-invalid');
          $('#pwdConfirm').removeClass('is-valid').addClass('is-invalid');
        }
      }
    });

    // 입사일자 입력 시 계약 시작일 자동 입력
    $('#hireDate').on('change', function() {
      const val = $(this).val();
      if (val) $('#contractStartDate').val(val);
    });
    // 계약 시작일 변경 시 입사일자도 동기화(단, hireDate가 비어있으면만)
    $('#contractStartDate').on('change', function() {
      const val = $(this).val();
      if (!$('#hireDate').val()) $('#hireDate').val(val);
    });

    // 월급 입력 시 연봉 자동 계산
    $('#monthlySalary').on('input', function() {
      const monthly = parseInt($(this).val().replace(/[^0-9]/g, '')) || 0;
      if (monthly > 0) {
        $('#annualSalary').val(monthly * 12);
      }
    });
    // 연봉 입력 시 월급 자동 계산
    $('#annualSalary').on('input', function() {
      const annual = parseInt($(this).val().replace(/[^0-9]/g, '')) || 0;
      if (annual > 0) {
        $('#monthlySalary').val(Math.floor(annual / 12));
      }
    });

    // 생년월일 입력 시 8자리(YYYYMMDD)만 자동 변환, 그 외에는 변환하지 않음
    $('#birthDate').on('input', function() {
      let val = $(this).val().replace(/[^0-9]/g, ''); // 숫자만 추출
      if (val.length === 8) {
        val = val.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
        $(this).val(val);
      } else if (val.length > 8) {
        val = val.substring(0, 8).replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
        $(this).val(val);
      }
      // 6자리 등 중간 입력은 변환하지 않음
    });

    // 저장 버튼 클릭 시 숫자 필드가 비어있으면 0으로 자동 세팅
    $('#btnSave').on('click', function () {
      if (!$('#annualLeaveTotal').val()) $('#annualLeaveTotal').val('0');
      if (!$('#annualLeaveUsed').val()) $('#annualLeaveUsed').val('0');
      if (!$('#annualLeaveRemain').val()) $('#annualLeaveRemain').val('0');
      // ... 기존 코드 이어짐 ...
    });

    // 근무유형별 표준시간 매핑
    const WORK_TYPE_TIME = {
      '일반': { start: '09:00', end: '18:00', lunchStart: '12:00', lunchEnd: '13:00' },
      '야간': { start: '22:00', end: '07:00', lunchStart: '01:00', lunchEnd: '02:00' },
      '교대': { start: '06:00', end: '15:00', lunchStart: '12:00', lunchEnd: '13:00' },
      '재택': { start: '09:00', end: '18:00', lunchStart: '12:00', lunchEnd: '13:00' }
    };
    $('#workPattern').on('change', function() {
      const type = $(this).val();
      if (WORK_TYPE_TIME[type]) {
        $('#workStartTime').val(WORK_TYPE_TIME[type].start);
        $('#workEndTime').val(WORK_TYPE_TIME[type].end);
        $('#lunchStartTime').val(WORK_TYPE_TIME[type].lunchStart);
        $('#lunchEndTime').val(WORK_TYPE_TIME[type].lunchEnd);
      }
    });

    // 자동 테스트: 존재하지 않는 empId로 empDetail 호출 후 응답 콘솔 출력
    $(function() {
      $.get('/erp/hr/empDetail', { empId: 'empIdNotExist9999' }, function(data) {
        console.log('empDetail(없는 사번) 응답:', data);
      });
    });

// =============================
// [1] 부서/직급별 급여/수당/공제 자동입력 기준표 (샘플)
// =============================
const SALARY_STANDARD = {
  'de1001': { // 경영지원부
    'pos07': { // 사원
      annualSalary: 30000000,
      monthlySalary: 2500000,
      bonus: 2000000,
      additionalAllowance: 500000,
      sal: 2000000,
      mealAllowance: 100000,
      transportAllowance: 50000,
      deductionType: '4대보험,소득세,지방세'
    }
  },
  'de1005': { // 영업부
    'pos05': { // 대리
      annualSalary: 35000000,
      monthlySalary: 2900000,
      bonus: 2500000,
      additionalAllowance: 600000,
      sal: 2300000,
      mealAllowance: 100000,
      transportAllowance: 50000,
      deductionType: '4대보험,소득세,지방세'
    }
  },
  'de1002': { // 인사부
    'pos04': { // 과장
      annualSalary: 40000000,
      monthlySalary: 3300000,
      bonus: 3000000,
      additionalAllowance: 700000,
      sal: 2600000,
      mealAllowance: 120000,
      transportAllowance: 60000,
      deductionType: '4대보험,소득세,지방세,기타공제'
    }
  }
  // ... 필요시 추가
};

// =============================
// [2] 부서/직급 선택 시 자동입력 이벤트
// =============================
// 부서/직급 select의 value가 코드값으로 세팅되어 있다고 가정
$('#deptCode, #position').on('change', function() {
  const dept = $('#deptCode').val();
  const pos = $('#position').val();
  console.log('자동입력 트리거 - 부서:', dept, '직급:', pos);
  if (SALARY_STANDARD[dept] && SALARY_STANDARD[dept][pos]) {
    const std = SALARY_STANDARD[dept][pos];
    // 근로계약 탭
    $('#annualSalary').val(std.annualSalary);
    $('#monthlySalary').val(std.monthlySalary);
    $('#bonus').val(std.bonus);
    $('#additionalAllowance').val(std.additionalAllowance);
    // 급여정보 탭
    $('#sal').val(std.sal);
    $('#mealAllowance').val(std.mealAllowance);
    $('#transportAllowance').val(std.transportAllowance);
    // 공제항목 체크박스 자동 체크
    $('#deductionTypeGroup input[type=checkbox]').each(function() {
      const val = $(this).val();
      $(this).prop('checked', std.deductionType.split(',').includes(val));
    });
    // 히든필드도 동기화
    $('#deductionTypeHidden').val(std.deductionType);
  }
});
// 신규 버튼 클릭 시에도 자동입력 이벤트 트리거
$('#btnNew').on('click', function() {
  setTimeout(function() {
    $('#deptCode').trigger('change');
    $('#position').trigger('change');
  }, 100); // select 옵션 세팅 후 트리거
});

// =============================
// [3] 입사구분(workType) ↔ 계약유형(contractType) 양방향 연동
// =============================
$('#workType').on('change', function() {
  const val = $(this).val();
  if (val) $('#contractType').val(val);
});
$('#contractType').on('change', function() {
  const val = $(this).val();
  if (val) $('#workType').val(val);
});

// 사원별 급여항목 삭제 함수 예시 (기존에 없으면 추가)
function deleteEmpAllowance(empId, comId, allowCode) {
  if (!confirm('정말 삭제하시겠습니까?')) return;
  $.ajax({
    url: '/erp/hr/deleteEmpAllowance',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ empId, comId, allowCode }),
    success: function (res) {
      if (res === 'ok') {
        alert('급여항목 삭제 완료!');
        // 삭제 후 급여항목 목록/화면 자동 갱신
        if (empId) {
          // 현재 선택된 사원 정보로 다시 채움
          $.get('/erp/hr/empDetail', { empId: empId }, function(row) {
            fillEmpForm(row);
          });
        } else {
          loadEmpList();
        }
      } else {
        alert('삭제 실패');
      }
    },
    error: function (xhr) { alert('삭제 실패: ' + xhr.responseText); }
  });
}
  </script>
</body>

</html>
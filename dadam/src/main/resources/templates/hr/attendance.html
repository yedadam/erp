<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="Content">

<head>
    <meta charset="UTF-8">
    <title>ê·¼íƒœê´€ë¦¬</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f8fafc 60%, #e0e7ff 100%);
        }
        .erp-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 32px 32px 24px 32px;
            min-height: 100vh;
        }
        .greeting-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border-radius: 16px;
            padding: 18px 32px 14px 32px;
            margin-bottom: 0px;
            box-shadow: none;
        }
        .greeting-bar .greeting {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .greeting-bar .date-time {
            font-size: 1rem;
            color: #64748b;
            font-weight: 400;
            text-align: center;
            flex: 1;
        }
        .profile-avatar {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #2563eb;
        }
        .attendance-header {
            background: #fff;
            border-radius: 16px;
            box-shadow: none;
            padding: 32px 32px 24px 32px;
            display: flex;
            gap: 24px;
            justify-content: space-between;
            align-items: center;
        }
        .summary-cards {
            display: flex;
            gap: 24px;
            flex: 1;
        }
        .summary-card {
            flex: 1;
            background: #f8fafc;
            border-radius: 14px;
            box-shadow: none;
            padding: 24px 0 18px 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 160px;
            position: relative;
        }
        .summary-card .icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        .summary-card .label {
            font-size: 1rem;
            color: #64748b;
            margin-bottom: 4px;
        }
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .summary-card.status .value {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 4px 16px;
            border-radius: 8px;
            background: #fef9c3;
            color: #b45309;
            display: inline-block;
        }
        .attendance-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }
        .fab-btn {
            min-width: 120px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 24px;
            box-shadow: none;
            padding: 12px 0;
            margin-bottom: 8px;
            border: none;
            transition: background 0.2s, transform 0.2s;
        }
        .fab-btn.checkin {
            background: linear-gradient(90deg, #34d399 60%, #2563eb 100%);
            color: #fff;
        }
        .fab-btn.checkin:hover {
            background: linear-gradient(90deg, #2563eb 60%, #34d399 100%);
            transform: translateY(-2px) scale(1.04);
        }
        .fab-btn.checkout {
            background: linear-gradient(90deg, #f87171 60%, #fbbf24 100%);
            color: #fff;
        }
        .fab-btn.checkout:hover {
            background: linear-gradient(90deg, #fbbf24 60%, #f87171 100%);
            transform: translateY(-2px) scale(1.04);
        }
        .attendance-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: none;
            padding: 32px 32px 24px 32px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .d-flex.align-items-center.gap-2.flex-wrap.mb-3 {
            margin-bottom: 18px !important;
        }
        .tui-grid-row:hover {
            background: #e0e7ff !important;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }
        .status-normal { background: #dcfce7; color: #166534; }
        .status-late { background: #fef9c3; color: #b45309; }
        .status-early { background: #fef3c7; color: #92400e; }
        .status-absent { background: #fee2e2; color: #991b1b; }
        .tui-grid-cell-content[title] { cursor: pointer; }
        #attendanceGrid { width: 100% !important; min-width: 1000px; }
        .tui-grid-row.selected-row td,
        .tui-grid-row.selected-row .tui-grid-cell {
            background: #e0e7ff !important;
        }
        .tui-grid-cell.tui-grid-cell-current {
            box-shadow: none !important;
            border-color: #2563eb !important;
            background: #e0e7ff !important;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <div class="erp-main">
            <!-- ìƒë‹¨ ì¸ì‚¬/ë‚ ì§œ/ì‹œê°„/í”„ë¡œí•„ -->
            <div class="greeting-bar">
                <div class="greeting">
                    <i class="fa-solid fa-hand-wave"></i> <span id="greetingMsg">ì‹ í˜„ìš±ë‹˜, ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”!</span>
                </div>
                <div class="date-time">
                    <span id="todayDate"></span> | <span id="currentTime"></span>
                </div>
                <img src="/static/img/user-default.png" class="profile-avatar" id="profileAvatar">
            </div>
            <!-- ìš”ì•½ ì¹´ë“œ -->
            <div class="attendance-header">
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="icon"><i class="fa-solid fa-arrow-right-to-city" style="color:#34d399;"></i></div>
                        <div class="label">ì˜¤ëŠ˜ ì¶œê·¼</div>
                        <div class="value" id="todayCheckIn">--:--</div>
                    </div>
                    <div class="summary-card">
                        <div class="icon"><i class="fa-solid fa-arrow-right-from-city" style="color:#f87171;"></i></div>
                        <div class="label">ì˜¤ëŠ˜ í‡´ê·¼</div>
                        <div class="value" id="todayCheckOut">--:--</div>
                    </div>
                    <div class="summary-card">
                        <div class="icon"><i class="fa-solid fa-clock" style="color:#2563eb;"></i></div>
                        <div class="label">ê·¼ë¬´ì‹œê°„</div>
                        <div class="value" id="todayWorkHours">--:--</div>
                    </div>
                    <div class="summary-card status">
                        <div class="icon"><i class="fa-solid fa-circle-exclamation" style="color:#fbbf24;"></i></div>
                        <div class="label">ìƒíƒœ</div>
                        <div class="value" id="todayStatus">ë¯¸ì¶œê·¼</div>
                    </div>
                    <div class="summary-card">
                        <div class="icon"><i class="fa-solid fa-calendar-check" style="color:#2563eb;"></i></div>
                        <div class="label">ì”ì—¬ ì—°ì°¨</div>
                        <div class="value" id="annualLeaveRemain">-- ì¼</div>
                    </div>
                </div>
                <div class="attendance-actions">
                    <button class="fab-btn checkin" id="btnCheckIn"><i class="fa-solid fa-right-to-bracket"></i> ì¶œê·¼</button>
                    <button class="fab-btn checkout" id="btnCheckOut"><i class="fa-solid fa-right-from-bracket"></i> í‡´ê·¼</button>
                </div>
            </div>
            <!-- íƒ­ ë©”ë‰´ -->
            <ul class="nav nav-tabs mb-0" id="attendanceTabs" style="margin-bottom:0;">
                <li class="nav-item">
                    <a class="nav-link active" id="tab-attendance" data-bs-toggle="tab" href="#attendanceTab">ê·¼íƒœ ë‚´ì—­</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="tab-leave" data-bs-toggle="tab" href="#leaveTab">ì—°ì°¨/íœ´ê°€ ë‚´ì—­</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="attendanceTab">
                    <!-- ê¸°ì¡´ ê·¼íƒœ ì¡°íšŒ/ê·¸ë¦¬ë“œ -->
                    <div class="attendance-content">
                        <div class="d-flex align-items-center gap-2 flex-wrap mb-3" style="margin-bottom: 24px;">
                            <label class="form-label mb-0">ì¡°íšŒê¸°ê°„:</label>
                            <input type="date" id="fromDate" class="form-control" style="width: 130px; height:38px;">
                            <span>~</span>
                            <input type="date" id="toDate" class="form-control" style="width: 130px; height:38px;">
                            <button class="btn btn-primary" id="btnSearch" style="height:38px;">ì¡°íšŒ</button>
                            <button class="btn btn-outline-primary" id="btnToday" style="height:38px;">ì˜¤ëŠ˜</button>
                            <button class="btn btn-outline-primary" id="btnThisWeek" style="height:38px;">ì´ë²ˆì£¼</button>
                            <button class="btn btn-outline-primary" id="btnThisMonth" style="height:38px;">ì´ë²ˆë‹¬</button>
                        </div>
                        <div class="loading" id="loading">
                            <i class="fas fa-spinner fa-spin"></i> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                        <div id="attendanceGrid"></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="leaveTab">
                    <div class="attendance-content">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <label class="form-label mb-0">ì¡°íšŒê¸°ê°„:</label>
                                <input type="date" id="leaveFromDate" class="form-control" style="width: 130px; height:38px;">
                                <span>~</span>
                                <input type="date" id="leaveToDate" class="form-control" style="width: 130px; height:38px;">
                                <button class="btn btn-primary" id="btnLeaveSearch" style="height:38px;">ì¡°íšŒ</button>
                            </div>
                            <button class="btn btn-success" id="btnApplyLeave"><i class="fa-solid fa-plus"></i> ì—°ì°¨ ì‹ ì²­</button>
                        </div>
                        <div class="loading" id="leaveLoading" style="display:none;">
                            <i class="fas fa-spinner fa-spin"></i> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                        <div id="leaveGrid"></div>
                    </div>
                </div>
            </div>
            <!-- ì—°ì°¨ ì‹ ì²­ ëª¨ë‹¬ -->
            <div class="modal fade" id="leaveModal" tabindex="-1">
              <div class="modal-dialog">
                <form id="leaveForm">
                  <div class="modal-content">
                    <div class="modal-header"><h5 class="modal-title">ì—°ì°¨ ì‹ ì²­</h5></div>
                    <div class="modal-body">
                      <label>íœ´ê°€ ì¢…ë¥˜</label>
                      <select class="form-control" name="leaveType">
                        <option value="ì—°ì°¨">ì—°ì°¨</option>
                        <option value="ë°˜ì°¨">ë°˜ì°¨</option>
                        <option value="ë³‘ê°€">ë³‘ê°€</option>
                      </select>
                      <label>ì‹œì‘ì¼</label>
                      <input type="date" class="form-control" name="startDate" required>
                      <label>ì¢…ë£Œì¼</label>
                      <input type="date" class="form-control" name="endDate" required>
                      <label>ì‚¬ìœ </label>
                      <input type="text" class="form-control" name="reason">
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">ì‹ ì²­</button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <!-- ì—°ì°¨/íœ´ê°€ ìƒì„¸/ìˆ˜ì •/ì·¨ì†Œ ëª¨ë‹¬ ì¶”ê°€ -->
            <div class="modal fade" id="leaveDetailModal" tabindex="-1">
              <div class="modal-dialog">
                <form id="leaveDetailForm">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">ì—°ì°¨/íœ´ê°€ ì‹ ì²­ ìƒì„¸</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-2">
                        <label class="form-label">ì‹ ì²­ì¼</label>
                        <input type="text" class="form-control" name="requestDate" readonly>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">íœ´ê°€ì¼</label>
                        <input type="date" class="form-control" name="leaveDate">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">ì¢…ë¥˜</label>
                        <select class="form-control" name="leaveType">
                          <option value="ì—°ì°¨">ì—°ì°¨</option>
                          <option value="ë°˜ì°¨">ë°˜ì°¨</option>
                          <option value="ë³‘ê°€">ë³‘ê°€</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">ì¼ìˆ˜</label>
                        <input type="text" class="form-control" name="days" readonly>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">ì‚¬ìœ </label>
                        <textarea class="form-control" name="reason" rows="2"></textarea>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">ìƒíƒœ</label>
                        <span id="leaveDetailStatus" class="badge"></span>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-primary" id="btnLeaveUpdate">ìˆ˜ì •</button>
                      <button type="button" class="btn btn-danger" id="btnLeaveCancel">ì·¨ì†Œ</button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
        </div>
    </div>

    <!-- JavaScript ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let attendanceGrid;
        let currentUser = {
            empId: '',
            comId: 'COM-101',
            deptCode: ''
        };
        let leaveGridInitialized = false;
        let leaveGrid = null;
        let selectedLeaveRowKey = null;

        // ë‚ ì§œ/ì‹œê°„/ì¸ì‚¬ ë©”ì‹œì§€
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' });
            document.getElementById('todayDate').textContent = dateStr;
            const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('currentTime').textContent = timeStr;
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getCurrentUser() {
            // ì‹¤ì œë¡œëŠ” ì„¸ì…˜ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨
            // ì„ì‹œë¡œ í•˜ë“œì½”ë”©
            currentUser.empId = 'EMP001';
            currentUser.comId = 'COM-101';
            currentUser.deptCode = 'DEPT001';
        }

        // Toast UI Grid ì´ˆê¸°í™”
        function initGrid() {
            attendanceGrid = new tui.Grid({
                el: document.getElementById('attendanceGrid'),
                scrollX: true,
                scrollY: true,
                theme: 'clean',
                bodyHeight: 400,
                columns: [
                    { header: 'ë‚ ì§œ', name: 'workDate', align: 'center', width: 130 },
                    { header: 'ìš”ì¼', name: 'dayOfWeek', align: 'center', width: 80 },
                    { header: 'ì¶œê·¼', name: 'actualStartTime', align: 'center', width: 120, formatter: function(value) { if (value.value) { const date = new Date(value.value); return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }); } return ''; } },
                    { header: 'í‡´ê·¼', name: 'actualEndTime', align: 'center', width: 120, formatter: function(value) { if (value.value) { const date = new Date(value.value); return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }); } return ''; } },
                    { header: 'ê·¼ë¬´', name: 'workHours', align: 'center', width: 110 },
                    { header: 'ì´ˆê³¼', name: 'overtimeHours', align: 'center', width: 110 },
                    { header: 'ìƒíƒœ', name: 'status', align: 'center', width: 110, formatter: function(value) { const status = value.value; let className = ''; let text = ''; let emoji = ''; switch(status) { case 'NORMAL': className = 'status-normal'; text = 'ì •ìƒ'; emoji = 'ğŸŸ¢'; break; case 'LATE': className = 'status-late'; text = 'ì§€ê°'; emoji = 'ğŸŸ¡'; break; case 'EARLY': className = 'status-early'; text = 'ì¡°í‡´'; emoji = 'ğŸŸ '; break; case 'ABSENT': className = 'status-absent'; text = 'ê²°ê·¼'; emoji = 'ğŸ”´'; break; default: className = ''; text = status || ''; emoji = ''; } return `<span class="status-badge ${className}">${emoji} ${text}</span>`; } },
                    { header: 'ë¹„ê³ ', name: 'note', align: 'left', width: 150, formatter: function(value) { const v = value.value || ''; if (v.length > 12) { return `<span title="${v}">${v.slice(0, 12)}...<span>`; } return v; } }
                ]
            });
        }

        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
        function initDateRange() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            document.getElementById('fromDate').value = todayStr;
            document.getElementById('toDate').value = todayStr;
        }

        // ê·¼íƒœ ë°ì´í„° ë¡œë“œ
        function loadAttendanceData() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            if (!fromDate || !toDate) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ë‚ ì§œ ì„ íƒ',
                    text: 'ì¡°íšŒí•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'
                });
                return;
            }

            document.getElementById('loading').classList.add('show');
            
            // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš© (ì‹¤ì œ êµ¬í˜„ ì‹œì—ëŠ” ì‹¤ì œ API í˜¸ì¶œ)
            $.ajax({
                url: '/erp/hr/testAttendanceData',
                method: 'GET',
                data: {
                    comId: currentUser.comId,
                    empId: currentUser.empId
                },
                success: function(data) {
                    document.getElementById('loading').classList.remove('show');
                    
                    // ë°ì´í„° í¬ë§·íŒ…
                    const formattedData = data.map(item => ({
                        ...item,
                        workHours: calculateWorkHours(item.actualStartTime, item.actualEndTime),
                        overtimeHours: calculateOvertimeHours(item.actualStartTime, item.actualEndTime),
                        dayOfWeek: getDayOfWeek(item.workDate)
                    }));
                    
                    attendanceGrid.resetData(formattedData);
                    
                    // ì˜¤ëŠ˜ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìƒë‹¨ ì¹´ë“œ ì—…ë°ì´íŠ¸
                    updateTodayCard(formattedData);
                },
                error: function(xhr) {
                    document.getElementById('loading').classList.remove('show');
                    Swal.fire({
                        icon: 'error',
                        title: 'ì¡°íšŒ ì‹¤íŒ¨',
                        text: 'ê·¼íƒœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
                    });
                }
            });
        }

        // ê·¼ë¬´ì‹œê°„ ê³„ì‚°
        function calculateWorkHours(startTime, endTime) {
            if (!startTime || !endTime) return '--:--';
            
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end - start;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${diffHours.toString().padStart(2, '0')}:${diffMinutes.toString().padStart(2, '0')}`;
        }

        // ì´ˆê³¼ì‹œê°„ ê³„ì‚° (8ì‹œê°„ ê¸°ì¤€)
        function calculateOvertimeHours(startTime, endTime) {
            if (!startTime || !endTime) return '--:--';
            
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end - start;
            const totalHours = diffMs / (1000 * 60 * 60);
            
            if (totalHours <= 8) return '00:00';
            
            const overtimeMs = (totalHours - 8) * 60 * 60 * 1000;
            const overtimeHours = Math.floor(overtimeMs / (1000 * 60 * 60));
            const overtimeMinutes = Math.floor((overtimeMs % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${overtimeHours.toString().padStart(2, '0')}:${overtimeMinutes.toString().padStart(2, '0')}`;
        }

        // ìš”ì¼ ê³„ì‚°
        function getDayOfWeek(dateStr) {
            const date = new Date(dateStr);
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return days[date.getDay()];
        }

        // ì˜¤ëŠ˜ ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateTodayCard(data) {
            const today = new Date().toISOString().split('T')[0];
            const todayData = data.find(item => item.workDate === today);
            
            if (todayData) {
                if (todayData.actualStartTime) {
                    const startTime = new Date(todayData.actualStartTime);
                    document.getElementById('todayCheckIn').textContent = 
                        startTime.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                }
                
                if (todayData.actualEndTime) {
                    const endTime = new Date(todayData.actualEndTime);
                    document.getElementById('todayCheckOut').textContent = 
                        endTime.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                }
                
                document.getElementById('todayWorkHours').textContent = 
                    calculateWorkHours(todayData.actualStartTime, todayData.actualEndTime);
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                const statusElement = document.getElementById('todayStatus');
                const status = todayData.status || 'NORMAL';
                let statusText = '';
                let className = '';
                
                switch(status) {
                    case 'NORMAL':
                        statusText = 'ì •ìƒ';
                        className = 'status-normal';
                        break;
                    case 'LATE':
                        statusText = 'ì§€ê°';
                        className = 'status-late';
                        break;
                    case 'EARLY':
                        statusText = 'ì¡°í‡´';
                        className = 'status-early';
                        break;
                    case 'ABSENT':
                        statusText = 'ê²°ê·¼';
                        className = 'status-absent';
                        break;
                    default:
                        statusText = 'ì •ìƒ';
                        className = 'status-normal';
                }
                
                statusElement.textContent = statusText;
                statusElement.className = `status-badge ${className}`;
            }
        }

        // ì¶œê·¼ ì²˜ë¦¬
        function checkIn() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            $.ajax({
                url: '/erp/hr/attendanceCheckIn',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    comId: currentUser.comId,
                    empId: currentUser.empId,
                    workDate: today,
                    actualStartTime: now.toISOString()
                }),
                success: function(response) {
                    if (response === 'ok') {
                        Swal.fire({
                            icon: 'success',
                            title: 'ì¶œê·¼ ê¸°ë¡',
                            text: 'ì˜¤ëŠ˜ ì¶œê·¼ì´ ì •ìƒì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
                            confirmButtonText: 'í™•ì¸'
                        });
                        loadAttendanceData(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    } else if (response === 'duplicate') {
                        Swal.fire({
                            icon: 'warning',
                            title: 'ì¤‘ë³µ ì¶œê·¼',
                            text: 'ì˜¤ëŠ˜ ì´ë¯¸ ì¶œê·¼ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.',
                            confirmButtonText: 'í™•ì¸'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'ì¶œê·¼ ì‹¤íŒ¨',
                            text: 'ì¶œê·¼ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                            confirmButtonText: 'í™•ì¸'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'ì¶œê·¼ ì‹¤íŒ¨',
                        text: 'ì¶œê·¼ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                        confirmButtonText: 'í™•ì¸'
                    });
                }
            });
        }

        // í‡´ê·¼ ì²˜ë¦¬
        function checkOut() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            $.ajax({
                url: '/erp/hr/attendanceCheckOut',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    comId: currentUser.comId,
                    empId: currentUser.empId,
                    workDate: today,
                    actualEndTime: now.toISOString()
                }),
                success: function(response) {
                    if (response === 'ok') {
                        Swal.fire({
                            icon: 'success',
                            title: 'í‡´ê·¼ ê¸°ë¡',
                            text: 'ì˜¤ëŠ˜ í‡´ê·¼ì´ ì •ìƒì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
                            confirmButtonText: 'í™•ì¸'
                        });
                        loadAttendanceData(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    } else if (response === 'duplicate') {
                        Swal.fire({
                            icon: 'warning',
                            title: 'ì¤‘ë³µ í‡´ê·¼',
                            text: 'ì˜¤ëŠ˜ ì´ë¯¸ í‡´ê·¼ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.',
                            confirmButtonText: 'í™•ì¸'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'í‡´ê·¼ ì‹¤íŒ¨',
                            text: 'í‡´ê·¼ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                            confirmButtonText: 'í™•ì¸'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'í‡´ê·¼ ì‹¤íŒ¨',
                        text: 'í‡´ê·¼ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                        confirmButtonText: 'í™•ì¸'
                    });
                }
            });
        }

        // ì—°ì°¨/íœ´ê°€ ë‚´ì—­ ê·¸ë¦¬ë“œ ë° ì‹ ì²­ ê¸°ëŠ¥ ì¶”ê°€
        function initLeaveGrid() {
            if (leaveGrid && typeof leaveGrid.destroy === 'function') {
                leaveGrid.destroy();
            }
            leaveGrid = new tui.Grid({
                el: document.getElementById('leaveGrid'),
                scrollX: true,
                scrollY: true,
                theme: 'clean',
                bodyHeight: 300,
                columns: [
                    { header: 'ì‹ ì²­ì¼', name: 'requestDate', align: 'center', width: 110 },
                    { header: 'íœ´ê°€ì¼', name: 'leaveDate', align: 'center', width: 110 },
                    { header: 'ì¢…ë¥˜', name: 'leaveType', align: 'center', width: 80 },
                    { header: 'ì¼ìˆ˜', name: 'days', align: 'center', width: 60 },
                    { header: 'ìƒíƒœ', name: 'status', align: 'center', width: 90 },
                    { header: 'ë¹„ê³ ', name: 'note', align: 'left', width: 150 }
                ],
                data: []
            });
            selectedLeaveRowKey = null;
            // í´ë¦­: í–‰ë§Œ ê°•ì¡°
            leaveGrid.on('click', ev => {
                if (ev.rowKey != null) {
                    selectedLeaveRowKey = ev.rowKey;
                    highlightSelectedLeaveRow();
                }
            });
            // ë”ë¸”í´ë¦­: ìƒì„¸/ìˆ˜ì •/ì·¨ì†Œ ëª¨ë‹¬ ì˜¤í”ˆ
            leaveGrid.on('dblclick', ev => {
                if (ev.rowKey != null) {
                    const row = leaveGrid.getRow(ev.rowKey);
                    openLeaveDetailModal(row);
                }
            });
        }
        function loadLeaveData() {
            const dummyData = [
                {
                    requestDate: '2025-07-01',
                    leaveDate: '2025-07-10',
                    leaveType: 'ì—°ì°¨',
                    days: 1,
                    status: 'PENDING',
                    reason: 'ì—¬ë¦„íœ´ê°€'
                },
                {
                    requestDate: '2025-06-15',
                    leaveDate: '2025-06-20',
                    leaveType: 'ë°˜ì°¨',
                    days: 0.5,
                    status: 'APPROVED',
                    reason: 'ë³‘ì›'
                }
            ];
            if (leaveGrid) {
                leaveGrid.resetData(dummyData);
            }
        }
        function applyLeave(e) {
            e.preventDefault();
            const form = document.getElementById('leaveForm');
            const formData = $(form).serializeArray();
            const data = {};
            formData.forEach(item => data[item.name] = item.value);
            data.comId = currentUser.comId;
            data.empId = currentUser.empId;
            $.ajax({
                url: '/erp/hr/applyAnnualLeave',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(resp) {
                    if (resp === 'ok') {
                        Swal.fire({ icon: 'success', title: 'ì‹ ì²­ ì™„ë£Œ', text: 'ì—°ì°¨/íœ´ê°€ê°€ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.' });
                        $('#leaveModal').modal('hide');
                        loadLeaveData();
                    } else {
                        Swal.fire({ icon: 'error', title: 'ì‹ ì²­ ì‹¤íŒ¨', text: 'ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
                    }
                },
                error: function() {
                    Swal.fire({ icon: 'error', title: 'ì‹ ì²­ ì‹¤íŒ¨', text: 'ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
                }
            });
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        $(document).ready(function() {
            // ì´ˆê¸°í™”
            getCurrentUser();
            initGrid();
            initDateRange();
            
            // ë²„íŠ¼ ì´ë²¤íŠ¸
            $('#btnCheckIn').on('click', checkIn);
            $('#btnCheckOut').on('click', checkOut);
            $('#btnSearch').on('click', loadAttendanceData);
            
            // ë‚ ì§œ ë²„íŠ¼ ì´ë²¤íŠ¸
            $('#btnToday').on('click', function() {
                const today = new Date().toISOString().split('T')[0];
                $('#fromDate').val(today);
                $('#toDate').val(today);
                loadAttendanceData();
            });
            
            $('#btnThisWeek').on('click', function() {
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                
                $('#fromDate').val(startOfWeek.toISOString().split('T')[0]);
                $('#toDate').val(today.toISOString().split('T')[0]);
                loadAttendanceData();
            });
            
            $('#btnThisMonth').on('click', function() {
                const today = new Date();
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                
                $('#fromDate').val(startOfMonth.toISOString().split('T')[0]);
                $('#toDate').val(today.toISOString().split('T')[0]);
                loadAttendanceData();
            });
            
            // ë‚ ì§œ ë³€ê²½ ì‹œ ìë™ ì¡°íšŒ
            $('#fromDate, #toDate').on('change', function() {
                if ($('#fromDate').val() && $('#toDate').val()) {
                    loadAttendanceData();
                }
            });
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë°ì´í„° ì¡°íšŒ
            loadAttendanceData();

            // ì—°ì°¨/íœ´ê°€ ê·¸ë¦¬ë“œ ë° ì‹ ì²­ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initLeaveGrid();
            // ì—°ì°¨/íœ´ê°€ íƒ­ ì§„ì… ì‹œ ë°ì´í„° ë¡œë“œ
            $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                if (e.target.id === 'tab-leave') {
                    if (!leaveGridInitialized) {
                        initLeaveGrid();
                    }
                    loadLeaveData();
                    if (leaveGrid && typeof leaveGrid.refreshLayout === 'function') {
                        leaveGrid.refreshLayout();
                    }
                }
            });
            // ì—°ì°¨ ì‹ ì²­ ë²„íŠ¼
            $('#btnApplyLeave').on('click', function() {
                $('#leaveModal').modal('show');
            });
            // ì—°ì°¨ ì‹ ì²­ í¼ ì œì¶œ
            $('#leaveForm').on('submit', applyLeave);
            // ì—°ì°¨ ì¡°íšŒ ë²„íŠ¼
            $('#btnLeaveSearch').on('click', loadLeaveData);
            // ì—°ì°¨ ê¸°ê°„ ê¸°ë³¸ê°’(ì˜¬í•´)
            const today = new Date();
            const yearStart = new Date(today.getFullYear(), 0, 1);
            $('#leaveFromDate').val(yearStart.toISOString().split('T')[0]);
            $('#leaveToDate').val(today.toISOString().split('T')[0]);

            // ì—°ì°¨/íœ´ê°€ ë‚´ì—­ ê·¸ë¦¬ë“œ í–‰ í´ë¦­ ì‹œ ìƒì„¸/ìˆ˜ì •/ì·¨ì†Œ ëª¨ë‹¬ ì˜¤í”ˆ
            if (leaveGrid) {
                leaveGrid.on('click', ev => {
                    if (ev.rowKey != null) {
                        selectedLeaveRowKey = ev.rowKey;
                        highlightSelectedLeaveRow();
                        const row = leaveGrid.getRow(ev.rowKey);
                        openLeaveDetailModal(row);
                    }
                });
            }
        });

        // ì—°ì°¨/íœ´ê°€ ë‚´ì—­ ê·¸ë¦¬ë“œ í–‰ í´ë¦­ ì‹œ ìƒì„¸/ìˆ˜ì •/ì·¨ì†Œ ëª¨ë‹¬ ì˜¤í”ˆ
        function openLeaveDetailModal(row) {
            // ë°ì´í„° ë°”ì¸ë”©
            const form = document.getElementById('leaveDetailForm');
            form.requestDate.value = row.requestDate || '';
            form.leaveDate.value = row.leaveDate || '';
            form.leaveType.value = row.leaveType || '';
            form.days.value = row.days || '';
            form.reason.value = row.reason || '';
            // ìƒíƒœ ë±ƒì§€
            const statusEl = document.getElementById('leaveDetailStatus');
            let badgeClass = 'bg-secondary';
            let statusText = row.status || '';
            if (row.status === 'APPROVED') { badgeClass = 'bg-success'; statusText = 'ìŠ¹ì¸'; }
            else if (row.status === 'PENDING') { badgeClass = 'bg-warning text-dark'; statusText = 'ëŒ€ê¸°'; }
            else if (row.status === 'REJECTED') { badgeClass = 'bg-danger'; statusText = 'ë°˜ë ¤'; }
            statusEl.className = 'badge ' + badgeClass;
            statusEl.textContent = statusText;
            // ìƒíƒœì— ë”°ë¼ ì…ë ¥/ë²„íŠ¼ ì œì–´
            const editable = row.status === 'PENDING';
            form.leaveDate.disabled = !editable;
            form.leaveType.disabled = !editable;
            form.reason.disabled = !editable;
            document.getElementById('btnLeaveUpdate').disabled = !editable;
            document.getElementById('btnLeaveCancel').disabled = !editable;
            // ëª¨ë‹¬ ì˜¤í”ˆ
            const modal = new bootstrap.Modal(document.getElementById('leaveDetailModal'));
            modal.show();
        }
        // ìˆ˜ì •/ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸(ì‹¤ì œ ì—°ë™ì€ ì¶”í›„ êµ¬í˜„)
        document.getElementById('btnLeaveUpdate').onclick = function() {
            // TODO: ì…ë ¥ê°’ ê²€ì¦ ë° ì„œë²„ ì—°ë™
            alert('ìˆ˜ì • ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ë©ë‹ˆë‹¤.');
        };
        document.getElementById('btnLeaveCancel').onclick = function() {
            if (confirm('ì •ë§ë¡œ ì´ ì—°ì°¨/íœ´ê°€ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // TODO: ì„œë²„ ì—°ë™
                alert('ì·¨ì†Œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ë©ë‹ˆë‹¤.');
            }
        };

        // ì„ íƒëœ í–‰ ê°•ì¡° ê¸°ëŠ¥
        function highlightSelectedLeaveRow() {
            if (!leaveGrid) return;
            leaveGrid.removeRowClassName('selected-row');
            if (selectedLeaveRowKey !== null) {
                leaveGrid.addRowClassName(selectedLeaveRowKey, 'selected-row');
                leaveGrid.refreshLayout();
            }
        }
    </script>
</body>
</html> 
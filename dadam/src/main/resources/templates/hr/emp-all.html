<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
    <title>ì‚¬ì› í˜„í™©</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
        .dashboard-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 24px;
            margin-bottom: 24px;
	width: 100%;
            overflow-x: auto;
}
        .dashboard-card {
            border-radius: 6px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 24px;
            background: #fff;
            min-width: 0;
            min-height: 140px;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
            margin-bottom: 0;
            text-align: center;
        }
        .dashboard-card .label {
            font-size: 1.1rem;
            color: #888;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .dashboard-card .value {
            font-size: 1.7rem;
	font-weight: bold;
            color: #222;
            margin-bottom: 8px;
}
        .dashboard-card .icon {
            font-size: 1.8rem;
            color: #e5e7eb;
            margin-top: 8px;
        }
        .dashboard-card.red { border-left: 4px solid #ff7b7b; }
        .dashboard-card.blue { border-left: 4px solid #2563eb; }
        .dashboard-card.gray { border-left: 4px solid #6c757d; }
        .dashboard-card.black { border-left: 4px solid #222; }
        .dashboard-card.orange { border-left: 4px solid #f59e42; }
        .search-area { margin-bottom: 18px !important; margin-top: 0 !important; }
        #empTotalGrid .tui-grid-container,
        #empTotalGrid .tui-grid-table,
        #empTotalGrid .tui-grid-header-area {
          border-top-left-radius: 8px !important;
          border-top-right-radius: 8px !important;
}
        #empTotalGrid .tui-grid-table {
          border-radius: 8px 8px 0 0 !important;
        }
        #empTotalGrid .tui-grid-container,
        #empTotalGrid .tui-grid-table,
        #empTotalGrid .tui-grid-header-area {
          border-bottom-left-radius: 0 !important;
          border-bottom-right-radius: 0 !important;
        }
        #empTotalGrid.tui-grid-container {
            border-radius: 8px 8px 0 0 !important;
            overflow: hidden;
        }
        .badge-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
	color: #fff;
            display: inline-block;
}
        .badge-employed { background: #ff7b7b; }
        .badge-leave { background: #6c757d; }
        .badge-total { background: #222; }
</style>
</head>
<body>
  <div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-end mb-3 border-bottom border-secondary pb-2" style="padding-bottom: 0.25rem !important;">
      <h3 class="text-secondary fw-bold mb-0" style="padding-right: 16px; padding-bottom: 0.25rem;">ì‚¬ì› í˜„í™©</h3>
    </div>
    <div class="dashboard-row">
      <div class="dashboard-card red">
        <div class="label">ì¬ì§ì</div>
        <div class="value" id="cntEmployed">0</div>
        <i class="fas fa-user-check fa-2x text-gray-300 icon"></i>
      </div>
      <div class="dashboard-card blue">
        <div class="label">ì •ê·œì§</div>
        <div class="value" id="cntRegular">0</div>
        <i class="fas fa-user-tie fa-2x text-gray-300 icon"></i>
      </div>
      <div class="dashboard-card blue">
        <div class="label">ê³„ì•½ì§</div>
        <div class="value" id="cntContract">0</div>
        <i class="fas fa-file-signature fa-2x text-gray-300 icon"></i>
      </div>
      <div class="dashboard-card orange">
        <div class="label">ì„ì‹œì§</div>
        <div class="value" id="cntTemp">0</div>
        <i class="fas fa-user-clock fa-2x text-gray-300 icon"></i>
      </div>
      <div class="dashboard-card blue">
        <div class="label">ì¼ìš©ì§</div>
        <div class="value" id="cntDaily">0</div>
        <i class="fas fa-user-friends fa-2x text-gray-300 icon"></i>
      </div>
      <div class="dashboard-card gray">
        <div class="label">í‡´ì‚¬ì</div>
        <div class="value" id="cntLeave">0</div>
        <i class="fas fa-user-slash fa-2x text-gray-300 icon"></i>
      </div>
      <div class="dashboard-card black">
        <div class="label">ì „ì²´</div>
        <div class="value" id="cntTotal">0</div>
        <i class="fas fa-users fa-2x text-gray-300 icon"></i>
      </div>
    </div>
    <div class="card mb-3 rounded shadow-sm search-area">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-2">
            <label for="joinTypeFilter" class="form-label">ì…ì‚¬êµ¬ë¶„</label>
            <select class="form-select" id="joinTypeFilter">
              <option value="">ì „ì²´</option>
              <!-- ê³µí†µì½”ë“œ(emp)ë¡œ ë™ì  ìƒì„± -->
            </select>
          </div>
          <div class="col-md-2">
            <label for="deptFilter" class="form-label">ë¶€ì„œ</label>
            <select class="form-select" id="deptFilter">
              <option value="">ì „ì²´</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="searchInput" class="form-label">ê²€ìƒ‰ì–´</label>
            <input type="text" class="form-control" id="searchInput" placeholder="ì‚¬ì›ëª… ë˜ëŠ” ì‚¬ë²ˆ ì…ë ¥">
          </div>
          <div class="col-md-3">
            <label class="form-label d-block">ì¬ì§ìƒíƒœ</label>
            <div class="d-flex gap-2 flex-wrap" id="empStatusRadioGroup">
              <!-- ê³µí†µì½”ë“œ(stt)ë¡œ ë™ì  ìƒì„± -->
            </div>
          </div>
          <div class="col-md-2 d-flex align-items-end ms-auto justify-content-end">
            <button class="btn btn-primary w-100" id="searchBtn"><i class="fas fa-search"></i> ê²€ìƒ‰</button>
				</div>
				</div>
			</div>
		</div>
    <div class="d-flex justify-content-between align-items-center button-area mt-2 mb-2 flex-wrap" style="min-height:40px;">
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-outline-success" id="excelBtn"><i class="fas fa-file-excel"></i> ì—‘ì…€ë‹¤ìš´</button>
        <button class="btn btn-outline-secondary" id="resetBtn"><i class="fas fa-rotate"></i> ì´ˆê¸°í™”</button>
			</div>
      <div class="d-flex gap-2 flex-wrap">
        <!-- í•„ìš”ì‹œ ì¶”ê°€/ì‚­ì œ/ì €ì¥ ë“± ê´€ë¦¬ ë²„íŠ¼ -->
			</div>
		</div>
    <div id="empGrid" class="grid-area"></div>
    <div id="noResultMsg" class="text-center text-muted my-4" style="display:none;">
      ğŸ” ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
	</div>
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
    // ê³µí†µì½”ë“œ ê¸°ë°˜ ë™ì  ì˜µì…˜ ìƒì„±
    function loadCommonCodes(mainCode, $target, type) {
      $.get('/common/codes', { mainCode: mainCode }, function(data) {
        if(type === 'select') {
          $target.empty().append('<option value="">ì „ì²´</option>');
          data.forEach(item => {
            $target.append(`<option value="${item.subCode}">${item.subName}</option>`);
          });
        } else if(type === 'radio') {
          $target.empty();
          $target.append(`
            <div class="form-check">
              <input class="form-check-input" type="radio" name="empStatusRadio" id="empStatusAll" value="" checked>
              <label class="form-check-label" for="empStatusAll">ì „ì²´</label>
            </div>
          `);
          data.forEach(item => {
            $target.append(`
              <div class="form-check">
                <input class="form-check-input" type="radio" name="empStatusRadio" id="empStatus_${item.subCode}" value="${item.subCode}">
                <label class="form-check-label" for="empStatus_${item.subCode}">${item.subName}</label>
              </div>
            `);
          });
        }
      });
    }
    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë”© (API ì—°ë™ í•„ìš”)
    function loadEmpDashboard() {
      $.get('/erp/hr/emp/dashboard', function(data) {
        $('#cntEmployed').text(data.cntEmployed || 0);
        $('#cntRegular').text(data.cntRegular || 0);
        $('#cntContract').text(data.cntContract || 0);
        $('#cntTemp').text(data.cntTemp || 0);
        $('#cntDaily').text(data.cntDaily || 0);
        $('#cntLeave').text(data.cntLeave || 0);
        $('#cntTotal').text(data.cntTotal || 0);
      });
    }
    // ë¶€ì„œ ì˜µì…˜ ë™ì  ë¡œë”©
    function loadDeptOptions() {
      $.get('/erp/hr/dept', function(list) {
        const $dept = $('#deptFilter');
        $dept.empty().append('<option value="">ì „ì²´</option>');
        list.forEach(d => $dept.append(`<option value="${d.deptCode}">${d.deptName}</option>`));
      });
    }
    // TOAST UI Grid ì»¬ëŸ¼ ì •ì˜ (ìµœì¢… ì¶”ì²œ ì»¬ëŸ¼ë§Œ)
    const columns = [
      { name: 'empId', header: 'ì‚¬ì›ë²ˆí˜¸', sortable: true, align: 'center', width: 90 },
      { name: 'empName', header: 'ì„±ëª…', sortable: true, align: 'center' },
      { name: 'deptName', header: 'ë¶€ì„œ', sortable: true, align: 'center' },
      { name: 'positionName', header: 'ì§ê¸‰', formatter: ({row}) => row.positionName || '-', align: 'center' },
      { name: 'empStatusName', header: 'ì¬ì§ìƒíƒœ', formatter: ({ value }) => {
          if (!value) return '-';
          let text = value.trim();
          let cls = '';
          if (text === 'ì¬ì§') { cls = 'badge-status badge-employed'; }
          else if (text === 'íœ´ì§') { cls = 'badge-status badge-leave'; }
          else if (text === 'í‡´ì‚¬') { cls = 'badge-status badge-leave'; }
          else { cls = 'badge-status badge-total'; }
          return `<span class="${cls}">${text}</span>`;
        }, align: 'center', width: 80 },
      { name: 'workTypeName', header: 'ê·¼ë¬´ìœ í˜•', formatter: ({row}) => row.workTypeName || '-', align: 'center', width: 90 },
      { name: 'hireDate', header: 'ì…ì‚¬ì¼', sortable: true, formatter: ({value}) => value ? value.substring(0,10) : '-', align: 'right' },
      { name: 'salaryType', header: 'ê¸‰ì—¬êµ¬ë¶„', formatter: ({row}) => {
          if (row.sal) return row.sal.toLocaleString() + 'ì›(ì›”ê¸‰)';
          if (row.hourlyWage) return row.hourlyWage.toLocaleString() + 'ì›(ì‹œê¸‰)';
          return '-';
        }, align: 'right' },
      { name: 'annualLeave', header: 'ì—°ì°¨(ì´/ì‚¬ìš©/ì”ì—¬)', formatter: ({row}) => {
          if (row.annualLeaveTotal !== undefined)
            return `${row.annualLeaveTotal || 0}/${row.annualLeaveUsed || 0}/${row.annualLeaveRemain || 0}`;
          return '-';
        }, align: 'center' },
    ];
    // ê·¸ë¦¬ë“œ ìƒì„±
    const grid = new tui.Grid({
      el: document.getElementById('empGrid'),
      data: [],
      scrollX: false,
      scrollY: true,
      bodyHeight: 270,
      rowHeaders: ['checkbox'],
      columns: columns
    });
    // [ëŒ€ì‹œë³´ë“œ ì§‘ê³„] ê° ìƒíƒœë³„ ì‚¬ì› ìˆ˜ ì§‘ê³„ ë° í‘œì‹œ (ì‚¬ì› ëª©ë¡ ë°ì´í„°ë¡œ ì§ì ‘ ì§‘ê³„)
    function updateDashboard(data) {
      const cntActive = data.filter(e => e.empStatusName === 'ì¬ì§').length;
      const cntFull = data.filter(e => e.workTypeName === 'ì •ê·œì§').length;
      const cntContract = data.filter(e => e.workTypeName === 'ê³„ì•½ì§').length;
      const cntTemp = data.filter(e => e.workTypeName === 'ì„ì‹œì§').length;
      const cntDaily = data.filter(e => e.workTypeName === 'ì¼ìš©ì§').length;
      const cntLeave = data.filter(e => e.empStatusName === 'íœ´ì§').length;
      const cntRetired = data.filter(e => e.empStatusName === 'í‡´ì‚¬').length;
      const cntTotal = data.length;
      $('#cntEmployed').text(cntActive);
      $('#cntRegular').text(cntFull);
      $('#cntContract').text(cntContract);
      $('#cntTemp').text(cntTemp);
      $('#cntDaily').text(cntDaily);
      $('#cntLeave').text(cntLeave);
      $('#cntTotal').text(cntTotal);
    }

    // Ajax ì„±ê³µ ì‹œ updateDashboard(data) í˜¸ì¶œí•˜ë„ë¡ filterEmpList í•¨ìˆ˜ ë‚´ì— ì¶”ê°€
    function commonSearchObject(paramObj, url, grid) {
      $.ajax({
        url: url,
        method: 'GET',
        data: paramObj,
        success: function(result) {
          grid.resetData(result);
          updateDashboard(result);
          $('#noResultMsg').toggle(result.length === 0);
        },
        error: function(xhr, status, error) {
          Swal.fire('âŒ ì˜¤ë¥˜', 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      });
    }
    // í•„í„°/ê²€ìƒ‰
    function filterEmpList() {
      const paramObj = {
        keyword: $('#searchInput').val(),
        dept: $('#deptFilter').val(),
        status: $('input[name="empStatusRadio"]:checked').val(), // empStatus â†’ status
        workType: $('#joinTypeFilter').val()
      };
      commonSearchObject(paramObj, '/erp/hr/empListAjax', grid);
    }
    // í•„í„°/ê²€ìƒ‰ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    $('#searchInput').on('keydown', function(e) {
      if (e.keyCode === 13) filterEmpList();
    });
    $('#searchBtn').on('click', filterEmpList);
    $('#deptFilter').on('change', filterEmpList);
    $('#joinTypeFilter').on('change', filterEmpList);
    $(document).on('change', 'input[name="empStatusRadio"]', filterEmpList);
    // ì´ˆê¸°í™” ì‹œ ìë™ ì¡°íšŒ ë° ê³µí†µì½”ë“œ ì˜µì…˜ ë™ì  ìƒì„±
    $(function() {
      loadEmpDashboard();
      loadDeptOptions();
      loadCommonCodes('emp', $('#joinTypeFilter'), 'select');
      loadCommonCodes('stt', $('#empStatusRadioGroup'), 'radio');
      filterEmpList();
    });
    // ì—‘ì…€ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
    $('#excelBtn').on('click', function() {
      grid.export('xlsx', { fileName: 'ì‚¬ì›í˜„í™©' });
    });
    // ì „ì²´ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
    $('#resetBtn').on('click', function() {
      $('#searchInput').val('');
      $('#deptFilter').val('');
      $('#joinTypeFilter').val('');
      $('input[name="empStatusRadio"]').prop('checked', false);
      $('#empStatusAll').prop('checked', true);
      filterEmpList();
    });
  </script>
</body>
</html>

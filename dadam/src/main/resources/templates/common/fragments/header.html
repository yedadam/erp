<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="HeaderFragment">

<head>
</head>
<body>
	<!-- Topbar -->
	<nav class="navbar navbar-expand navbar-light bg-light topbar mb-4 static-top shadow">

		<!-- Sidebar Toggle (Topbar) -->
		<button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
			<i class="fa fa-bars"></i>
		</button>

		<!-- Main Menu (Center aligned) -->
		<div class="mx-auto d-flex">
			<ul class="navbar-nav flex-row align-items-center">
				<li class="nav-item mx-2">
					<a class="nav-link text-dark fw-bold" href="/erp/standard">기준정보</a>
				</li>
				<li class="nav-item mx-2">
					<a class="nav-link text-dark fw-bold" href="/erp/sales">영업</a>
				</li>
				<li class="nav-item mx-2">
					<a class="nav-link text-dark fw-bold" href="/erp/inventory">재고</a>
				</li>
				<li class="nav-item mx-2">
					<a class="nav-link text-dark fw-bold" href="/erp/hr">인사</a>
				</li>
				<li class="nav-item mx-2">
					<a class="nav-link text-dark fw-bold" href="/erp/accounting">회계</a>
				</li>
			</ul>
		</div>

		<!-- Topbar Navbar -->
		<ul class="navbar-nav ms-auto">

			<!-- Alerts -->
			<li class="nav-item dropdown no-arrow mx-1">
				<a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"  onclick="loadChatRooms()">
					<i class="fas fa-bell fa-fw"></i>
					<span class="badge badge-danger badge-counter">3+</span>
				</a>
				<div class="dropdown-menu dropdown-menu-end shadow animated--grow-in" aria-labelledby="alertsDropdown">
					<h6 class="dropdown-header">Alerts Center</h6>
					<!-- 예시 알림 -->
					<a class="dropdown-item d-flex align-items-center" href="#">
						<div class="me-3">
							<div class="icon-circle bg-primary">
								<i class="fas fa-file-alt text-white"></i>
							</div>
						</div>
						<div>
							<div class="small text-gray-500">2025-06-16</div>
							새로운 보고서가 준비되었습니다!
						</div>
					</a>
				</div>
			</li>

			<!-- Messages (채팅방 목록) -->
			<li class="nav-item dropdown no-arrow mx-1">
				  <a class="nav-link dropdown-toggle" href="#" id="chatRoomsDropdown" role="button"
				     data-bs-toggle="dropdown" aria-expanded="false" onclick="loadChatRooms()">
				    <i class="fas fa-comments fa-fw"></i>
				    <span class="badge badge-danger badge-counter" id="chatRoomBadge">0</span>
				  </a>
				  <div class="dropdown-menu dropdown-menu-end shadow animated--grow-in"
				       aria-labelledby="chatRoomsDropdown" style="min-width: 300px;">
				       
				    <h6 class="dropdown-header">내 채팅방 목록</h6>
				
				    <!-- 채팅방 목록 영역 -->
				    <div id="chatRoomList">
				      <div class="text-center text-muted small">로딩 중...</div>
				    </div>
				
				    <div class="dropdown-divider"></div>
				
				    <!-- 채팅방 생성 버튼 -->
				    <a class="dropdown-item text-center text-primary fw-bold" href="javascript:void(0)"
				       data-bs-toggle="offcanvas" data-bs-target="#chatRoomCreateDrawer">
				      <i class="fas fa-plus-circle me-2"></i> 채팅방 만들기
				    </a>
				  </div>
			 </li>

			<div class="topbar-divider d-none d-sm-block"></div>

			<!-- 로그인 사용자 -->
			<li class="nav-item dropdown no-arrow" sec:authorize="isAuthenticated()">
				<a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
					<span class="me-2 d-none d-lg-inline text-gray-600 small" th:text="${#authentication.principal.username}"></span>
					<img class="img-profile rounded-circle" src="/img/undraw_profile.svg">
				</a>
				<div class="dropdown-menu dropdown-menu-end shadow animated--grow-in" aria-labelledby="userDropdown">
					<a class="dropdown-item" href="#"><i class="fas fa-user fa-sm fa-fw me-2 text-gray-400"></i> Profile</a>
					<a class="dropdown-item" href="#"><i class="fas fa-cogs fa-sm fa-fw me-2 text-gray-400"></i> Settings</a>
					<a class="dropdown-item" href="#"><i class="fas fa-list fa-sm fa-fw me-2 text-gray-400"></i> Activity Log</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" href="#" onclick="document.getElementById('logout-form').submit();">
						<i class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i> Logout
					</a>
					<form id="logout-form" action="/logoutForm" method="post" style="display: none;">
						 <input type="hidden" name="_csrf" value="YOUR_CSRF_TOKEN_HERE" />
					</form>
				</div>
			</li>
			<!-- 비로그인 사용자 -->
			<li class="nav-item dropdown no-arrow" sec:authorize="!isAuthenticated()">
				<a class="nav-link dropdown-toggle" href="#" id="guestDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
					<span class="me-2 d-none d-lg-inline text-gray-600 small">안녕</span>
					<img class="img-profile rounded-circle" src="/img/undraw_profile.svg">
				</a>
				<div class="dropdown-menu dropdown-menu-end shadow animated--grow-in" aria-labelledby="guestDropdown">
					<a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#logoutModal">
						<i class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i> Login
					</a>
				</div>
			</li>
		</ul>
	</nav>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:inline="javascript">
	let empId = [[${#authentication.principal != 'anonymousUser' ? #authentication.principal.userId : 'e1018'}]];
	let empName = [[${#authentication.principal != 'anonymousUser' ? #authentication.principal.username : '김지현'}]];
	let comId = [[${#authentication.principal != 'anonymousUser' ? #authentication.principal.comId : 'com-101'}]];
	//채팅방 목록 가져오기
	function loadChatRooms() {
		 const $list = $('#chatRoomList');
		  $list.html('<div class="text-center text-muted small">로딩 중...</div>');


		  $.ajax({
		    url: '/erp/chatList',
		    method: 'GET',
		    data: { empId: empId },
		    dataType: 'json',
		    success: function (rooms) {
		      if (!rooms || rooms.length === 0) {
		        $list.html('<div class="text-center text-muted small">채팅방이 없습니다.</div>');
		        $('#chatRoomBadge').text('0');
		        return;
		      }

		      let html = '';
		      rooms.forEach(function (room) {
		    	//렌더링
		        html += `
		        	<a class="dropdown-item d-flex align-items-center" href="javascript:void(0)"
		        	   onclick="openChatRoom('${room.chatId}', '${room.name}')">
		        	  <div class="dropdown-list-image me-3">
		        	    <img class="rounded-circle" src="/img/undraw_profile_1.svg" alt="...">
		        	    <div class="status-indicator ${room.status === 'online' ? 'bg-success' : 'bg-secondary'}"></div>
		        	  </div>
		        	  <div class="fw-bold">
		        	    <div class="text-truncate">${room.name}</div>
		        	    <div class="small text-gray-500">${room.createdDate || ''}</div>
		        	    <div class="small text-primary">참여자 수: ${room.chatQuantity || 0}명</div>
		        	  </div>
		        	</a>`;
		      });

		      $list.html(html);
		      $('#chatRoomBadge').text(rooms.length);
		    },
		    error: function () {
		      $list.html('<div class="text-center text-danger small">불러오기 실패</div>');
		    }
		  });
		}
	let currentSubscription = null;
	//채팅방열기
	function openChatRoom(id, name) {
	    const $chatPopup = $('#chatPopup');
	
	    // 제목 변경
	    $chatPopup.find('.card-header span').text(name);
	
	    // 팝업 보이기
	    $chatPopup.css('display', 'flex');
	
	    // 현재 채팅방 ID 저장
	    $chatPopup.attr('data-room-id', id);
	
	    // 메시지 입력창 포커스
	    $('#chatInput').focus();
	    $.ajax({
	        url: '/erp/history',
	        method: 'GET',
	        data: { roomId: id },
	        success: function(messages) {
	        	$('#chatBox').html('');
	            messages.forEach(function(msg) {
	                showChatMessage(msg);
	            });
	        },
	        error: function() {
	            alert('이전 메시지를 불러오지 못했습니다.');
	        }
	    });

	    // STOMP 구독도 같이 처리
	    if (currentSubscription) currentSubscription.unsubscribe();
	    currentSubscription = stompClient.subscribe(`/topic/chat.${id}`, function(response) {
	        const message = JSON.parse(response.body);
	        showChatMessage(message);
	    });

	    $('#chatInput').focus();
	}
	
	
	   
	   
	</script>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
.grid-action {
	display: inline-block;
	padding: 3px 8px;
	font-size: 12px;
	border-radius: 12px;
	border: 1px solid lightgray; /* #cbd5e1 → lightgray */
	background-color: aliceblue; /* #f8fafc → aliceblue */
	color: darkslategray; /* #334155 → darkslategray */
	cursor: pointer;
	transition: all 0.2s ease-in-out;
}

.grid-action:hover {
	background-color: lightsteelblue; /* #e2e8f0 → lightsteelblue */
	border-color: silver; /* #94a3b8 → silver */
	color: midnightblue; /* #1e293b → midnightblue */
}

.tui-grid-cell.matched {
	background-color: #d4edda !important; /* 연한 초록색 */
}

dialog {
	position: fixed;
	top: 120px;
	left: -15%;
	transform: translateX(-50%);
	z-index: 9999;
	border: 1px solid #ccc;
	border-radius: 8px;
	padding: 10px;
	background: white;
	box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
	width: 180px;
	font-size: 13px;
}

.column-option {
	display: flex;
	align-items: center;
	margin-bottom: 6px;
}
</style>
</head>
<body>
  <h3>전표관리
    <button id="columnToggleBtn" title="컬럼 설정" style="border:none; background:none; font-size:18px; cursor:pointer;">⚙️</button>
  </h3>

  <dialog id="columnDialog">
    <div id="columnOptions"></div>
  </dialog>

  <div>
    <button class="saveBtn" id="saveBtn">등록</button>
  </div>

  <div class="col-14">
    <div id="chitGrid" class="mx-5"></div>
  </div>



</body>

<script>


/** ------------------------- 자동완성 에디터 ------------------------- */
/**
 * ---------------------- 자동완성 에디터 생성 ----------------------
 * - Grid 내 특정 셀(계정과목, 전표유형 등)에 자동완성 기능을 부여하기 위한 공통 함수
 * - 외부 API 요청 기반으로 입력어를 자동완성 리스트로 받아오며,
 *   선택 시 displayField는 보여주고, saveField는 실제 값으로 저장함
 * - deps: 다른 컬럼값에 의존하는 경우(ex. 상위 코드) 조건으로 사용
 * - onSelectClear: 항목 선택 시 초기화할 컬럼 목록
 */
function createChitAutoCompleteEditor({ urlBuilder, deps = [], onSelectClear = [], displayField = 'name', saveField = 'code', displayNameField = null }) {
 function CustomEditor(props) {
   const el = document.createElement('input');
   el.type = 'text';
   el.className = 'form-control';
   el.value = props.value || '';

   // jQuery UI autocomplete 적용 (동적 소스 바인딩)
   $(el).autocomplete({
     source(request, response) {
       // 의존 컬럼 값이 비어있으면 검색 생략
       const depValues = deps.map(dep => props.grid.getValue(props.rowKey, dep));
       if (depValues.includes('') || depValues.includes(undefined)) return response([]);

       const url = urlBuilder({ keyword: request.term, deps: depValues });
       $.getJSON(url, data => {
         const results = data.map(item => ({
           label: `${item[saveField]} ${item[displayField]}`,
           value: item[saveField],
           realValue: item[saveField],
           displayName: item[displayField]
         }));
         response(results);
       });
     },
     minLength: 0,
     select(event, ui) {
       // 실제 저장값 설정
       props.grid.setValue(props.rowKey, props.columnInfo.name, ui.item.realValue);
       // 추가 표시용 필드도 설정
       if (displayNameField) props.grid.setValue(props.rowKey, displayNameField, ui.item.displayName);
       // 선택 시 초기화할 컬럼들 비움
       onSelectClear.forEach(col => props.grid.setValue(props.rowKey, col, ''));
     }
   }).focus(() => $(el).autocomplete("search", ""));

   this.el = el;
 }
 CustomEditor.prototype.getElement = function () { return this.el; };
 CustomEditor.prototype.getValue = function () { return this.el.value; };
 return CustomEditor;
}

/**
 * ---------------------- 자동완성 에디터 인스턴스 정의 ----------------------
 * - acctTypeEditor: 계정과목용
 * - indTypeEditor: 전표구분용
 */
const acctTypeEditor = createChitAutoCompleteEditor({
 urlBuilder: ({ keyword }) => `/erp/chit/acctCodeFind?keyword=${keyword}`,
 displayField: 'ANAME', saveField: 'ACCTCODE', displayNameField: 'ANAME'
});
const indTypeEditor = createChitAutoCompleteEditor({
 urlBuilder: ({ keyword }) => `/erp/chit/indTypeFindByCode?keyword=${keyword}`,
 displayField: 'INAME', saveField: 'ITYPE', displayNameField: 'INAME'
});

/** ------------------------- Grid 구성 ------------------------- */
const chitGrid = new tui.Grid({
 el: document.getElementById('chitGrid'),
 scrollX: false,
 scrollY: true,
 editingEvent: 'click',
 treeColumnOptions: { name: 'chitTitle', useIcon: true },
 columns: [
   { header: '등록일자', name: 'createdDate', align: 'center' },
   { header: '전표명', name: 'chitTitle', align: 'center' },
   { header: '거래처', name: 'vdrCode', align: 'center' },
   { header: '거래유형', name: 'tType', align: 'center' },
   { header: '공급가액', name: 'supplyPrice', align: 'right', formatter: ({ value }) => value ? parseInt(value).toLocaleString() + '원' : '', hidden: true },
   { header: '부가세', name: 'vatPrice', align: 'right', formatter: ({ value }) => value ? parseInt(value).toLocaleString() + '원' : '', hidden: true },
   { header: '총금액', name: 'totPrice', align: 'right', formatter: ({ value }) => value ? parseInt(value).toLocaleString() + '원' : ''},
   { header: '세금계산서', name: 'taxCode', align: 'center', 
	   formatter: ({ value }) => value === 'tay02' ? '<span class="grid-action">계산서 발행</span>' 
			   				   : value === 'tay01' ? '<span class="grid-action">발행 완료</span>' : ''},
   { header: '결제상태', name: 'status', align: 'center', width: 100,
     	formatter: ({ value }) => value === '등록' ? '등록' 
     						    : value === '결제' ? '<button class="btn grid-action pay-btn">결제</button>' : ''},
   { header: '계정과목', name: 'acctCode', align: 'center', editor: { type: acctTypeEditor }, formatter: ({ row }) => row.ANAME || row.aname },
   { header: '전표구분', name: 'iType', align: 'center', editor: { type: indTypeEditor }, formatter: ({ row }) => row.INAME || row.iname },
   { header: '금액', name: 'iPrice', align: 'center', editor 	: { type: 'text', options: { inputType: 'number' } } },
   { name: 'ANAME', hidden: true },
   { name: 'INAME', hidden: true },
   { header: '담당부서', name: 'deptCode', hidden: true },
   { header: '결제자', name: 'phyEmpId', hidden: true },
   { header: '승인자', name: 'apprEmpId', hidden: true },
   { header: '비고', name: 'note', hidden: true },
   {
	   header: '추가/삭제', name: 'origin', align: 'center',
	   formatter: ({ row }) => {
	     const isChild = row._attributes?.tree?.parent !== undefined;
	     const isNewRow = row.origin === true;
	    const isStatus = row._attributes?.tree?.status == '등록' || '결제';
	     if (isChild || isNewRow) {
	       return '<button class="btn btn-sm btn-danger del-btn">삭제</button>';
	     }
	     return '<button class="btn btn-sm btn-primary add-btn">분개</button>';
	   }
	 }
 ]
});

/** ------------------------- 데이터 처리 ------------------------- */
 
function convertToGridTree(data) {
  //map
  const grouped = new Map();

  // chit_code로 그룹핑
  data.forEach(row => {
    const code = row.chitCode;
    grouped.set(code, row);
  });

  const treeList = [];

  grouped.forEach((row, chitCode) => {

    // 부모 전표가 없는 경우 예외 처리
    const first = row;

    const parentIndex = treeList.length;

    const parent = {
      chitCode: chitCode,
      chitTitle: first?.chitTitle ?? '',
      createdDate: first?.createdDate ?? '', 	
      vdrCode: first?.vdrCode ?? '',
      supply_price: first?.supplyPrice ?? '',
      vat_price: first?.vatPrice ?? '',  	  
      totPrice: first?.totPrice ?? '',
      taxCode: first?.taxCode ?? '',
      status: first?.status ?? '',
      tType: first?.tType ?? '',
      deptCode: first?.deptCode ?? '',
      phyEmpId: first?.phyEmpId ?? '',
      apprEmpId: first?.apprEmpId ?? '',
      note: first?.note ?? '',
      origin: 'init',
      _attributes: { expanded: false },
      _children: [] 
    };
   
    if(first.parent == null){
    	
    	treeList.push(parent);
    	grouped.set(chitCode, parent);
    }
    else {
    	 grouped.get(first.parent)._children.push({
             chitCode: row.chitCode,
             acctCode: row.acctCode,
             iType: row.iType,
             iPrice: row.iPrice,
             ANAME: row.ANAME,
             INAME: row.INAME,
             iname: row.iname,
             aname: row.aname,
             note: row.note,
             origin: true,
           });   
    }
  });
  return treeList;
}


/**
 * Grid에서 수정/추가된 행들 중 자식(분개) 행만 추출하는 필터 함수
 * - acctCode가 존재하는 행만 반환
 */
function extractOnlyChildren(list = []) {
 return list.filter(row => !!row.acctCode);
}

/**
 * 부모 전표별로 차변/대변 금액을 합산하여 밸런스 여부 체크
 * - 차변 = 대변이고 둘 다 0 초과일 경우: "결제 가능" 상태로 표시
 * - 부모의 'totPrice' 셀 배경을 연두색으로 변경
 */
function checkBalanceAndMark() {
 const data = chitGrid.getData();      // 현재 그리드의 전체 데이터
 const parentMap = {};                 // 부모 인덱스별 자식 행들을 저장할 맵

 // 모든 행을 순회하면서 부모 인덱스 기준으로 자식 분리
 data.forEach(row => {
   const parentKey = row._attributes?.tree?.parent;
   if (parentKey !== undefined) {
     if (!parentMap[parentKey]) parentMap[parentKey] = [];
     parentMap[parentKey].push(row);
   }
 });

 // 부모별로 차변/대변 합산 및 일치 여부 확인
 Object.entries(parentMap).forEach(([parentKey, children]) => {
   let debit = 0, credit = 0;

   children.forEach(r => {
     const amt = Number(r.iPrice) || 0;
     if (r.iType === 'itp01') debit += amt;   // 차변
     if (r.iType === 'itp02') credit += amt;  // 대변
   });

   const isBalanced = debit > 0 && debit === credit; // 둘 다 0 초과이며 일치

   const el = chitGrid.getElement(Number(parentKey), 'totPrice'); // 해당 부모행의 금액 셀
   if (el) el.style.backgroundColor = isBalanced ? '#e6ffe6' : ''; // 배경색 표시

   chitGrid.setValue(Number(parentKey), 'isBalanced', isBalanced ? 'Y' : 'N'); // 그리드 내 상태 필드 값 설정
 });
}
// 차/대변의 값에 따라 행 표시.
function highlightParentsWithChildren() {
  const data = chitGrid.getData();

  data.forEach((row, idx) => {
    if (Array.isArray(row._children) && row._children.length > 0) {
      let debit = 0, credit = 0;
      let allTyped = true;

      row._children.forEach(child => {
        const amt = parseFloat((child.iPrice + '').replace(/,/g, '')) || 0; // ✅ 명확하게 숫자로 변환
        const type = child.iType;

        if (!type || isNaN(amt)) {
          allTyped = false;
          return;
        }

        if (type === 'itp01') debit += amt;
        if (type === 'itp02') credit += amt;
      });

      const el = chitGrid.getElement(idx, 'chitTitle');
      if (el) {
        if (!allTyped) {
          el.style.backgroundColor = '';
        } else if (debit > 0 && debit === credit) {
          el.style.backgroundColor = '#e0f2fe'; // 연파랑
        } else {
          el.style.backgroundColor = '#fee2e2'; // 연빨강
        }
      }
    }
  });
}

/** ------------------------- 이벤트 바인딩 ------------------------- */
$('#saveBtn').on('click', function () {
 const { createdRows, updatedRows, deletedRows } = chitGrid.getModifiedRows();
 const payload = {
   createdRows: extractOnlyChildren(createdRows),
   updatedRows: extractOnlyChildren(updatedRows),
   deletedRows: extractOnlyChildren(deletedRows)
 };
 for (const row of payload.createdRows) {
   if (!row.acctCode || !row.iType || !row.iPrice) return alert("계정과목, 전표구분, 금액을 모두 입력해야 합니다.");
 }
 $.ajax({
   url: "/erp/chit/saveAll",
   method: "POST",
   contentType: "application/json",
   data: JSON.stringify(payload),
   success(res) {
     if (res.result === "success") {
       alert(res.message);
       chitGrid.resetData([]);
       chitList();
     } else alert("실패: " + res.message);
   },
   error(xhr, status, error) {
     alert("서버 오류 발생: " + error);
   }
 });
});

chitGrid.on('click', (ev) => {

	  const { rowKey, columnName } = ev;
	  if (columnName !== 'origin') return;

	  const target = ev.nativeEvent.target;
	  const button = target.closest('button');
	  if (!button) return;

	  // 여기에서 반드시 정의해줘야 함!!
	  const parentRow = chitGrid.getRow(rowKey);
	  if (!parentRow) return;

	  const isChild = parentRow._attributes?.tree?.parent !== undefined;
	  if (isChild) return alert("분개행에는 분개를 추가할 수 없습니다.");

	  if (button.classList.contains('add-btn')) {
	    const newRow = {
	      chitCode: parentRow.chitCode,
	      acctCode: '',  // 계정코드 자동입력
	      iType: '',	 // 차/대변 자동 입력
	      iPrice: '', 	 // 금액 자동 입력(총 금액 기준)
	      ANAME: '',
	      INAME: '',
	      origin: true,
	      _attributes: {}
	    };

	    chitGrid.appendRow(newRow, {
	      parentRowKey: rowKey,
	      position: 'last',
	      focus: true
	    });
	    chitGrid.expand(rowKey);
	  }

	  if (button.classList.contains('del-btn')) {
	    chitGrid.removeRow(rowKey);
	  }
	});


chitGrid.on('afterChange', ev => {
 const { columnName, value, rowKey } = ev.changes[0];
 if (columnName === 'acctCode' && value) {
   const firstDigit = value.toString()[0];
   if (['1', '5'].includes(firstDigit)) {
     chitGrid.setValue(rowKey, 'iType', 'itp01');
     chitGrid.setValue(rowKey, 'INAME', '차변');
   } else if (['2', '3', '4'].includes(firstDigit)) {
     chitGrid.setValue(rowKey, 'iType', 'itp02');
     chitGrid.setValue(rowKey, 'INAME', '대변');
   } else {
     chitGrid.setValue(rowKey, 'iType', '');
     chitGrid.setValue(rowKey, 'INAME', '');
   }
 }
});

chitGrid.on('editingFinish', ({ columnName }) => {
 if (['iPrice', 'iType'].includes(columnName)) checkBalanceAndMark();
});

function chitList() {
    $.get("/erp/chit/chitFindAll", result => {
      console.log('서버에서 내려온 원본 데이터:', result);
      const gridData = convertToGridTree(result);
      console.log('트리 변환 후 데이터:', gridData);
      chitGrid.resetData(gridData);
//      chitGrid.resetData(result);
      highlightParentsWithChildren();
      checkBalanceAndMark();
    });
  }
// 첫 데이터 로딩
chitList();



// 다이어로그
    const dialog = document.getElementById('columnDialog');
    const openButton = document.getElementById('columnToggleBtn');

    openButton.addEventListener('click', (e) => {
      const optionsDiv = document.getElementById('columnOptions');
      optionsDiv.innerHTML = '';
      const ignoreColumns = ['ANAME', 'INAME'];

      chitGrid.getColumns().forEach(col => {
        if (ignoreColumns.includes(col.name)) return;

        const isVisible = chitGrid.getColumn(col.name).hidden !== true;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = col.name;
        checkbox.checked = isVisible;

        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            chitGrid.showColumn(e.target.value);
          } else {
            chitGrid.hideColumn(e.target.value);
          }
        });

        const label = document.createElement('label');
        label.className = 'column-option';
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + col.header));

        optionsDiv.appendChild(label);
      });

      e.stopPropagation();
      dialog.show();
    });
 // 다이얼로그 외부 클릭 시 닫기
    document.addEventListener('click', (event) => {
      if (!dialog.open) return;
      if (dialog.contains(event.target)) return;
      dialog.close();
    });


</script>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<style>
.row-selected {
	background-color: #e6f2ff !important;
}

.grid-action {
	display: inline-block;
	padding: 3px 8px;
	font-size: 12px;
	border-radius: 12px;
	border: 1px solid lightgray; /* #cbd5e1 â†’ lightgray */
	background-color: aliceblue; /* #f8fafc â†’ aliceblue */
	color: darkslategray; /* #334155 â†’ darkslategray */
	cursor: pointer;
	transition: all 0.2s ease-in-out;
}

.grid-action:hover {
	background-color: lightsteelblue; /* #e2e8f0 â†’ lightsteelblue */
	border-color: silver; /* #94a3b8 â†’ silver */
	color: midnightblue; /* #1e293b â†’ midnightblue */
}

.tui-grid-cell.matched {
	background-color: #d4edda !important; /* ì—°í•œ ì´ˆë¡ìƒ‰ */
}

#autoRuleModal {
	position: fixed;
	top: 150px;
	left: 50%;
	transform: translateX(-50%);
	width: 800px;
	max-width: 90vw;
	background-color: white;
	border-radius: 8px;
	padding: 20px;
	box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
	z-index: 1000;
	display: none;
}

#autoRuleGrid {
	width: 100%;
	height: 300px; /* âœ… ê³ ì • height */
	min-height: 300px;
	max-height: 300px; /* âœ… ëŠ˜ì–´ë‚˜ì§€ ì•Šê²Œ ì œí•œ */
	overflow: auto;
}

dialog {
	position: fixed;
	top: 150px;
	left: 90%;
	transform: translateX(-50%);
	z-index: 9999;
	border: 1px solid #ccc;
	border-radius: 8px;
	padding: 10px;
	background: white;
	box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
	width: 180px;
	font-size: 13px;
}

.column-option {
	display: flex;
	align-items: center;
	margin-bottom: 6px;
}

.ui-autocomplete {
	z-index: 99999 !important;
}
</style>
</head>
<body class="bg-light">
	<div class="container-fluid mt-4">
		<!-- í—¤ë” ì˜ì—­ -->
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h3 class="fw-bold">ì „í‘œê´€ë¦¬</h3>
			<div>
				<button id="" class="btn btn-light border"
					onclick="openAutoRuleModal()">ìë™ë¶„ê°œ ì„¤ì • âš™ï¸</button>
				<button id="columnToggleBtn" title="ì»¬ëŸ¼ ì„¤ì •"
					class="btn btn-light border">ì»¬ëŸ¼ì„¤ì •âš™ï¸</button>
			</div>
		</div>

		<!-- ë²„íŠ¼ ì˜ì—­ -->
		<div class="d-flex justify-content-end flex-wrap gap-2 mb-3">
			<button class="btn btn-primary" id="saveBtn">
				<i class="fas fa-save"></i> ë“±ë¡
			</button>
			<button class="btn btn-success" id="patBtn">
				<i class="fas fa-credit-card"></i> ê²°ì œ
			</button>
		</div>

		<!-- ì „í‘œ ê·¸ë¦¬ë“œ -->
		<div class="col-12">
			<div id="chitGrid" class="mx-2"></div>
		</div>
	</div>

	<!-- ì»¬ëŸ¼ ì„¤ì • ë‹¤ì´ì–¼ë¡œê·¸ -->
	<dialog id="columnDialog">
	<div id="columnOptions"></div>


	</dialog>


	<div id="autoRuleModal">
		<h4 class="mb-3">ìë™ë¶„ê°œ ì„¤ì •</h4>
		<div class="d-flex justify-content-end mb-2">
			<button class="btn btn-outline-primary btn-sm"
				onclick="addAutoRuleRow()">í–‰ì¶”ê°€</button>
		</div>

		<!-- ê³ ì • í¬ê¸° ì˜ì—­ -->
		<div id="autoRuleGrid"></div>

		<div class="d-flex justify-content-end gap-2 mt-3">
			<button class="btn btn-primary btn-sm" onclick="saveAutoRules()">ì €ì¥</button>
			<button class="btn btn-secondary btn-sm"
				onclick="hideAutoRuleModal()">ë‹«ê¸°</button>
		</div>
	</div>

</body>
<script>
let autoRuleGrid;

/** ------------------------- ìë™ì™„ì„± ì—ë””í„° ------------------------- */
/**
 * ---------------------- ìë™ì™„ì„± ì—ë””í„° ìƒì„± ----------------------
 * - Grid ë‚´ íŠ¹ì • ì…€(ê³„ì •ê³¼ëª©, ì „í‘œìœ í˜• ë“±)ì— ìë™ì™„ì„± ê¸°ëŠ¥ì„ ë¶€ì—¬í•˜ê¸° ìœ„í•œ ê³µí†µ í•¨ìˆ˜
 * - ì™¸ë¶€ API ìš”ì²­ ê¸°ë°˜ìœ¼ë¡œ ì…ë ¥ì–´ë¥¼ ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ì•„ì˜¤ë©°,
 *   ì„ íƒ ì‹œ displayFieldëŠ” ë³´ì—¬ì£¼ê³ , saveFieldëŠ” ì‹¤ì œ ê°’ìœ¼ë¡œ ì €ì¥í•¨
 * - deps: ë‹¤ë¥¸ ì»¬ëŸ¼ê°’ì— ì˜ì¡´í•˜ëŠ” ê²½ìš°(ex. ìƒìœ„ ì½”ë“œ) ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©
 * - onSelectClear: í•­ëª© ì„ íƒ ì‹œ ì´ˆê¸°í™”í•  ì»¬ëŸ¼ ëª©ë¡
 */
function createChitAutoCompleteEditor({ urlBuilder, deps = [], onSelectClear = [], displayField = 'name', saveField = 'code', displayNameField = null }) {
 function CustomEditor(props) {
   const el = document.createElement('input');
   el.type = 'text';
   el.className = 'form-control';
   el.value = props.value || '';

   // jQuery UI autocomplete ì ìš© (ë™ì  ì†ŒìŠ¤ ë°”ì¸ë”©)
   $(el).autocomplete({
     source(request, response) {
       // ì˜ì¡´ ì»¬ëŸ¼ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ê²€ìƒ‰ ìƒëµ
       const depValues = deps.map(dep => props.grid.getValue(props.rowKey, dep));
       if (depValues.includes('') || depValues.includes(undefined)) return response([]);

       const url = urlBuilder({ keyword: request.term, deps: depValues });
       $.getJSON(url, data => {
         const results = data.map(item => ({
           label: `${item[saveField]} ${item[displayField]}`,
           value: item[saveField],
           realValue: item[saveField],
           displayName: item[displayField]
         }));
         response(results);
       });
     },
     minLength: 0,
     select(event, ui) {
       // ì‹¤ì œ ì €ì¥ê°’ ì„¤ì •
       props.grid.setValue(props.rowKey, props.columnInfo.name, ui.item.realValue);
       // ì¶”ê°€ í‘œì‹œìš© í•„ë“œë„ ì„¤ì •
       if (displayNameField) props.grid.setValue(props.rowKey, displayNameField, ui.item.displayName);
       // ì„ íƒ ì‹œ ì´ˆê¸°í™”í•  ì»¬ëŸ¼ë“¤ ë¹„ì›€
       onSelectClear.forEach(col => props.grid.setValue(props.rowKey, col, ''));
     },
     appendTo: 'body'
   }).focus(() => $(el).autocomplete("search", ""));

   // ì…€ í´ë¦­ ì‹œ ë°”ë¡œ inputì— í¬ì»¤ìŠ¤
   setTimeout(() => el.focus(), 0);

   this.el = el;
 }
 CustomEditor.prototype.getElement = function () { return this.el; };
 CustomEditor.prototype.getValue = function () { return this.el.value; };
 return CustomEditor;
}

/**
 * ---------------------- ìë™ì™„ì„± ì—ë””í„° ì¸ìŠ¤í„´ìŠ¤ ì •ì˜ ----------------------
 * - acctTypeEditor: ê³„ì •ê³¼ëª©ìš©
 * - indTypeEditor: ì „í‘œêµ¬ë¶„ìš©
 */
const acctTypeEditor = createChitAutoCompleteEditor({
 urlBuilder: ({ keyword }) => `/erp/accounting/acctCodeFind?keyword=${keyword}`,
 displayField: 'ANAME', saveField: 'ACCTCODE', displayNameField: 'ANAME'
});

const indTypeEditor = createChitAutoCompleteEditor({
 urlBuilder: ({ keyword }) => `/erp/accounting/indTypeFindByCode?keyword=${keyword}`,
 displayField: 'INAME', saveField: 'ITYPE', displayNameField: 'INAME'
});

const chtTypeEditor = createChitAutoCompleteEditor({
 urlBuilder: ({ keyword }) => `/erp/accounting/chtTypeFindByCode?keyword=${keyword}`,
 displayField: 'TNAME', saveField: 'TTYPE', displayNameField: 'TNAME'
});


/** ------------------------- Grid êµ¬ì„± -------------------------  */
const chitGrid = new tui.Grid({
 el: document.getElementById('chitGrid'),
 scrollX: false,
 scrollY: true,
 editingEvent: 'click',
 treeColumnOptions: { name: 'chitTitle', useIcon: true },
 columns: [
   { header: 'ë“±ë¡ì¼ì', name: 'createdDate', align: 'center' },
   { header: 'ì „í‘œëª…', name: 'chitTitle', align: 'center' },
   { header: 'ê±°ë˜ì²˜', name: 'vdrCode', align: 'center' },
   { header: 'ê±°ë˜ìœ í˜•', name: 'tType', align: 'center' },
   { header: 'ê³µê¸‰ê°€ì•¡', name: 'supplyPrice', align: 'right', formatter: ({ value }) => value ? parseInt(value).toLocaleString() + 'ì›' : '', hidden: true },
   { header: 'ë¶€ê°€ì„¸', name: 'vatPrice', align: 'right', formatter: ({ value }) => value ? parseInt(value).toLocaleString() + 'ì›' : '', hidden: true },
   { header: 'ì´ê¸ˆì•¡', name: 'totPrice', align: 'right', formatter: ({ value }) => value ? parseInt(value).toLocaleString() + 'ì›' : ''},
   { header: 'ì„¸ê¸ˆê³„ì‚°ì„œ', name: 'taxCode', align: 'center', 
	   formatter: ({ value }) => value === 'tay02' ? '<span class="grid-action">ê³„ì‚°ì„œ ë°œí–‰</span>' 
			   				   : value === 'tay01' ? '<span class="grid-action">ë°œí–‰ ì™„ë£Œ</span>' : ''},
   { header: 'ê²°ì œìƒíƒœ', name: 'status', align: 'center', width: 100,
     	formatter: ({ value }) => value === 'ë“±ë¡' ? '<span class="grid-action">ë“±ë¡</span>' 
     						    : value === 'ê²°ì œ' ? '<button class="btn grid-action payCheck">ê²°ì œ</button>' 
     						    : value === 'ê²°ì œì™„ë£Œ' ? '<span class="grid-acction">ê²°ì œì™„ë£Œ</span>' 
     						    : value === 'ë³€ë ¤' ? '<button class="btn grid-action reject-btn">ë°˜ë ¤</button>' 
     						    :''},			    
   { header: 'ê³„ì •ê³¼ëª©', name: 'acctCode', align: 'center', editor: { type: acctTypeEditor }, formatter: ({ row }) => row.aname || row.ANAME },
   { header: 'ì „í‘œêµ¬ë¶„', name: 'iType', align: 'center', editor: { type: indTypeEditor }, formatter: ({ row }) =>  row.iname || row.INAME },
   { header: 'ê¸ˆì•¡', name: 'iPrice', align: 'center', editor 	: { type: 'text', options: { inputType: 'number' } } },
   { name: 'ANAME' },
   { name: 'INAME' },
   { header: 'ë‹´ë‹¹ë¶€ì„œ', name: 'deptCode', hidden: true },
   { header: 'ê²°ì œì', name: 'phyEmpId', hidden: true },
   { header: 'ìŠ¹ì¸ì', name: 'apprEmpId', hidden: true },
   { header: 'ë¹„ê³ ', name: 'note', hidden: true },
   {
	   header: 'ë¶„ê°œ', name: 'origin', align: 'center',
	   formatter: ({ row }) => {
	     const isChild = row._attributes?.tree?.parent !== undefined;
	     const isNewRow = row.origin === true;
	    const isStatus = row._attributes?.tree?.status == 'ë“±ë¡' || 'ê²°ì œ';
	     if (isChild || isNewRow) {
	       return `<button class="btn btn-sm btn-primary add-btn">ì¶”ê°€</button>
	               <button class="btn btn-sm btn-danger del-btn">ì‚­ì œ</button>`;
	     }
	     return '<button class="btn btn-sm btn-primary auto-btn">ë¶„ê°œ</button>';
	   }
	 }
 ]
});

/** ------------------------- ë°ì´í„° ì²˜ë¦¬ ------------------------- */
 
function convertToGridTree(data) {
  //map
  const grouped = new Map();

  // chit_codeë¡œ ê·¸ë£¹í•‘
  data.forEach(row => {
    const code = row.chitCode;
    grouped.set(code, row);
  });

  const treeList = [];

  grouped.forEach((row, chitCode) => {

    // ë¶€ëª¨ ì „í‘œê°€ ì—†ëŠ” ê²½ìš° ì˜ˆì™¸ ì²˜ë¦¬
    const first = row;

    const parentIndex = treeList.length;

    const parent = {
      chitCode: chitCode,
      chitTitle: first?.chitTitle ?? '',
      createdDate: first?.createdDate ?? '', 	
      vdrCode: first?.vdrCode ?? '',
      articleCode: first?.articleCode ?? '',
      supplyPrice: first?.supplyPrice ?? '',
      vatPrice: first?.vatPrice ?? '',  	  
      totPrice: first?.totPrice ?? '',
      taxCode: first?.taxCode ?? '',
      status: first?.status ?? '',
      tType: first?.tType ?? '',
      deptCode: first?.deptCode ?? '',
      phyEmpId: first?.phyEmpId ?? '',
      apprEmpId: first?.apprEmpId ?? '',
      note: first?.note ?? '',
      origin: 'init',
      _attributes: { expanded: false },
      _children: [] 
    };
   
    if(first.parent == null){
    	
    	treeList.push(parent);
    	grouped.set(chitCode, parent);
    }
    else {
    	 grouped.get(first.parent)._children.push({
             chitCode: row.chitCode,
             acctCode: row.acctCode,
             iType: row.iType,
             iPrice: row.iPrice,
             ANAME: row.ANAME,
             INAME: row.INAME,
             iname: row.iname,
             aname: row.aname,
             note: row.note,
             origin: true,
           });   
    }
  });
  return treeList;
}


/**
 * Gridì—ì„œ ìˆ˜ì •/ì¶”ê°€ëœ í–‰ë“¤ ì¤‘ ìì‹(ë¶„ê°œ) í–‰ë§Œ ì¶”ì¶œí•˜ëŠ” í•„í„° í•¨ìˆ˜
 * - acctCodeê°€ ì¡´ì¬í•˜ëŠ” í–‰ë§Œ ë°˜í™˜
 */
function extractOnlyChildren(list = []) {
 return list.filter(row => !!row.acctCode);
}

/**
 * ë¶€ëª¨ ì „í‘œë³„ë¡œ ì°¨ë³€/ëŒ€ë³€ ê¸ˆì•¡ì„ í•©ì‚°í•˜ì—¬ ë°¸ëŸ°ìŠ¤ ì—¬ë¶€ ì²´í¬
 * - ì°¨ë³€ = ëŒ€ë³€ì´ê³  ë‘˜ ë‹¤ 0 ì´ˆê³¼ì¼ ê²½ìš°: "ê²°ì œ ê°€ëŠ¥" ìƒíƒœë¡œ í‘œì‹œ
 * - ë¶€ëª¨ì˜ 'totPrice' ì…€ ë°°ê²½ì„ ì—°ë‘ìƒ‰ìœ¼ë¡œ ë³€ê²½
 */
function checkBalanceAndMark() {
 const data = chitGrid.getData();      // í˜„ì¬ ê·¸ë¦¬ë“œì˜ ì „ì²´ ë°ì´í„°
 const parentMap = {};                 // ë¶€ëª¨ ì¸ë±ìŠ¤ë³„ ìì‹ í–‰ë“¤ì„ ì €ì¥í•  ë§µ

 // ëª¨ë“  í–‰ì„ ìˆœíšŒí•˜ë©´ì„œ ë¶€ëª¨ ì¸ë±ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ ìì‹ ë¶„ë¦¬
 data.forEach(row => {
   const parentKey = row._attributes?.tree?.parent;
   if (parentKey !== undefined) {
     if (!parentMap[parentKey]) parentMap[parentKey] = [];
     parentMap[parentKey].push(row);
   }
 });

 // ë¶€ëª¨ë³„ë¡œ ì°¨ë³€/ëŒ€ë³€ í•©ì‚° ë° ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
 Object.entries(parentMap).forEach(([parentKey, children]) => {
   let debit = 0, credit = 0;

   children.forEach(r => {
     const amt = Number(r.iPrice) || 0;
     if (r.iType === 'itp01') debit += amt;   // ì°¨ë³€
     if (r.iType === 'itp02') credit += amt;  // ëŒ€ë³€
   });

   const isBalanced = debit > 0 && debit === credit; // ë‘˜ ë‹¤ 0 ì´ˆê³¼ì´ë©° ì¼ì¹˜

   const el = chitGrid.getElement(Number(parentKey), 'totPrice'); // í•´ë‹¹ ë¶€ëª¨í–‰ì˜ ê¸ˆì•¡ ì…€
   if (el) el.style.backgroundColor = isBalanced ? '#e6ffe6' : ''; // ë°°ê²½ìƒ‰ í‘œì‹œ

   chitGrid.setValue(Number(parentKey), 'isBalanced', isBalanced ? 'Y' : 'N'); // ê·¸ë¦¬ë“œ ë‚´ ìƒíƒœ í•„ë“œ ê°’ ì„¤ì •
 });
}
// ì°¨/ëŒ€ë³€ì˜ ê°’ì— ë”°ë¼ í–‰ í‘œì‹œ.
function highlightParentsWithChildren() {
  const data = chitGrid.getData();

  data.forEach((row, idx) => {
    if (Array.isArray(row._children) && row._children.length > 0) {
      let debit = 0, credit = 0;
      let allTyped = true;

      row._children.forEach(child => {
        const amt = parseFloat((child.iPrice + '').replace(/,/g, '')) || 0; // âœ… ëª…í™•í•˜ê²Œ ìˆ«ìë¡œ ë³€í™˜
        const type = child.iType;

        if (!type || isNaN(amt)) {
          allTyped = false;
          return;
        }

        if (type === 'itp01') debit += amt;
        if (type === 'itp02') credit += amt;
      });

      const el = chitGrid.getElement(idx, 'chitTitle');
      if (el) {
        if (!allTyped) {
          el.style.backgroundColor = '';
        } else if (debit > 0 && debit === credit) {
          el.style.backgroundColor = '#e0f2fe'; // ì—°íŒŒë‘
        } else {
          el.style.backgroundColor = '#fee2e2'; // ì—°ë¹¨ê°•
        }
      }
    }
  });
}

/** ------------------------- ì´ë²¤íŠ¸ ë°”ì¸ë”© ------------------------- */
$('#saveBtn').on('click', function () {
 const { createdRows, updatedRows, deletedRows } = chitGrid.getModifiedRows();
 const payload = {
   createdRows: extractOnlyChildren(createdRows),
   updatedRows: extractOnlyChildren(updatedRows),
   deletedRows: extractOnlyChildren(deletedRows)
 };
 for (const row of payload.createdRows) {
   if (!row.acctCode || !row.iType || !row.iPrice) return alert("ê³„ì •ê³¼ëª©, ì „í‘œêµ¬ë¶„, ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
 }
 $.ajax({
   url: "/erp/accounting/chitSaveAll",
   method: "POST",
   contentType: "application/json",
   data: JSON.stringify(payload),
   success(res) {
     if (res.result === "success") {
       alert(res.message);
       chitGrid.resetData([]);
       chitList();
     } else alert("ì‹¤íŒ¨: " + res.message);
   },
   error(xhr, status, error) {
     alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ: " + error);
   }
 });
});


$('#patBtn').on('click', function () {
	  const selectedRowKeys = chitGrid.getCheckedRowKeys();
	  if (selectedRowKeys.length === 0) {
	    return alert("ì„ íƒëœ ì „í‘œê°€ ì—†ìŠµë‹ˆë‹¤.");
	  }

	  const rows = selectedRowKeys
	    .map(rowKey => chitGrid.getRow(rowKey))
	    .filter(row => row.status === 'ê²°ì œ'); // 'ê²°ì œ' ìƒíƒœë§Œ ì²˜ë¦¬

	  if (rows.length === 0) return alert("ê²°ì œ ê°€ëŠ¥í•œ ìƒíƒœì˜ ì „í‘œê°€ ì—†ìŠµë‹ˆë‹¤.");

	  if (!confirm(`${rows.length}ê±´ì˜ ì „í‘œë¥¼ ê²°ì œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

	  const payload = rows.map(row => ({
	    chitCode: row.chitCode,
	    articleCode: row.articleCode,
	    totPrice: row.totPrice
	  }));

	  $.ajax({
	    url: "/erp/accounting/modifyChitPay",
	    method: "POST",
	    data: {comId},
	    contentType: "application/json",
	    data: JSON.stringify(payload),
	    success(res) {
	      if (res.result === "success") {
	        alert("ê²°ì œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
	        chitList(); // ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
	      } else {
	        alert("ê²°ì œ ì‹¤íŒ¨: " + res.message);
	      }
	    },
	    error(xhr, status, error) {
	      alert("ì„œë²„ ì˜¤ë¥˜: " + error);
	    }
	  });
	});





chitGrid.on('click', (ev) => {
  const { rowKey, columnName } = ev;
  const target = ev.nativeEvent.target;
  const button = target.closest('button');
  if (!button) return;

  /**status ì—´ì˜ .pay-check ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ/í•´ì œ **/
  if (columnName === 'status' && button.classList.contains('payCheck')) {
    const isSelected = chitGrid.getRow(rowKey)?._attributes?.checked;

    if (isSelected) {
      chitGrid.uncheck(rowKey);
      chitGrid.removeRowClassName(rowKey, 'row-selected');
    } else {
      chitGrid.check(rowKey);
      chitGrid.addRowClassName(rowKey, 'row-selected');
    }
    return; // ë‹¤ë¥¸ ë™ì‘ ë§‰ê¸° ìœ„í•´ return
  }

  if (columnName !== 'origin') return;

  if (button.classList.contains('add-btn')) {
	  
	  const parentRow = chitGrid.getRow(rowKey);
	  if (!parentRow) return;

	  const isChild = parentRow._attributes?.tree?.parent !== undefined;
	  if (isChild) return alert("ë¶„ê°œí–‰ì—ëŠ” ë¶„ê°œë¥¼ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	  
    const newRow = {
      chitCode: parentRow.chitCode,
      acctCode: '',
      iType: '',
      iPrice: '',
      ANAME: '',
      INAME: '',
      origin: true,
      _attributes: {}
    };

    chitGrid.appendRow(newRow, {
      parentRowKey: rowKey,
      position: 'last',
      focus: true
    });
    chitGrid.expand(rowKey);
  }

  if (button.classList.contains('del-btn')) {
    chitGrid.removeRow(rowKey);
  }
  
  if (button.classList.contains('auto-btn')) {
	  const parentRow = chitGrid.getRow(rowKey);
	  if (!parentRow || !parentRow.tType) {
	    return alert("ê±°ë˜ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤.");
	  }

	  const chitType = parentRow.tType;
	  console.log("ğŸ“¦ ê³µê¸‰ê°€ì•¡:", parentRow.supplyPrice);
	  
	  function getAutoPriceByVatYn(parentRow, rule) {
		  const vatYn = rule.vatYn?.toLowerCase() || rule.VAT_YN?.toLowerCase();
		  const priceMap = {
		    v: parseFloat(parentRow?.vatPrice) || 0,
		    s: parseFloat(parentRow?.supplyPrice) || 0,
		    t: parseFloat(parentRow?.totPrice) || 0
		  };
			console.log(priceMap[vatYn])
			console.log("rule ê°ì²´ ì „ì²´:", rule);
		  return (priceMap[vatYn] ?? parseFloat(parentRow?.supplyPrice)) || 0;
		}

	  fetch(`/erp/accounting/ruleByChitType?chitType=${chitType}&comId=${comId}`)
	    .then(res => res.json())
	    .then(rules => {
	      console.log("rules ì‘ë‹µ", rules);
	      if (!Array.isArray(rules) || rules.length === 0) {
	        return alert("í•´ë‹¹ ê±°ë˜ìœ í˜•ì— ëŒ€í•œ ìë™ë¶„ê°œ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.");
	      }

	      rules.forEach(rule => {
	        const iPrice = getAutoPriceByVatYn(parentRow, rule);

	        chitGrid.appendRow({
	        	  chitCode: parentRow.chitCode,
	        	  acctCode: rule.ACCT_CODE,    // ëŒ€ì†Œë¬¸ì ì •í™•íˆ!
	        	  iType: rule.ITP_TYPE,        // âœ… ë°˜ë“œì‹œ editorì—ì„œ ê¸°ëŒ€í•˜ëŠ” ê°’
	        	  iPrice: iPrice,
	        	  aname: rule.ANAME,           // formatterìš© (ê³„ì •ëª…)
	        	  iname: rule.INAME,           // formatterìš© (ì°¨/ëŒ€ë³€ëª…)
	        	  vatYn: rule.VAT_YN,          // ë¶€ê°€ì„¸ êµ¬ë¶„ê°’ (ìˆë‹¤ë©´)
	        	  origin: true,
	        	  _attributes: {}
	        }, {
	          parentRowKey: rowKey,
	          position: 'last'
	        });
	      });

	      chitGrid.expand(rowKey);
	    })
	    .catch(err => {
	      console.error("ìë™ë¶„ê°œ ê·œì¹™ ì¡°íšŒ ì‹¤íŒ¨", err);
	      alert("ìë™ë¶„ê°œ ê·œì¹™ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
	    });
	}


});

chitGrid.on('afterChange', ev => {
 const { columnName, value, rowKey } = ev.changes[0];
 if (columnName === 'acctCode' && value) {
   const firstDigit = value.toString()[0];
   if (['1', '5'].includes(firstDigit)) {
     chitGrid.setValue(rowKey, 'iType', 'itp01');
     chitGrid.setValue(rowKey, 'INAME', 'ì°¨ë³€');
   } else if (['2', '3', '4'].includes(firstDigit)) {
     chitGrid.setValue(rowKey, 'iType', 'itp02');
     chitGrid.setValue(rowKey, 'INAME', 'ëŒ€ë³€');
   } else {
     chitGrid.setValue(rowKey, 'iType', '');
     chitGrid.setValue(rowKey, 'INAME', '');
   }
 }
});

chitGrid.on('editingFinish', ({ columnName }) => {
 if (['iPrice', 'iType'].includes(columnName)) checkBalanceAndMark();
});

function chitList() {
	  $.ajax({
	    url: "/erp/accounting/chitFindAll",
	    method: "GET",
	    data: {comId},
	    dataType: "json",
	    success: function (result) {
	      console.log("ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¨ ì›ë³¸ ë°ì´í„°:", result);
	      const gridData = convertToGridTree(result);
	      console.log("íŠ¸ë¦¬ ë³€í™˜ í›„ ë°ì´í„°:", gridData);
	      chitGrid.resetData(gridData);
	      highlightParentsWithChildren();
	      checkBalanceAndMark();
	    },
	    error: function (xhr, status, error) {
	      console.error("ì „í‘œ ì¡°íšŒ ì‹¤íŒ¨:", error);
	      alert("ì „í‘œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	    }
	  });
	}
// ì²« ë°ì´í„° ë¡œë”©
chitList();



// ë‹¤ì´ì–´ë¡œê·¸
    const dialog = document.getElementById('columnDialog');
    const openButton = document.getElementById('columnToggleBtn');

    openButton.addEventListener('click', (e) => {
      const optionsDiv = document.getElementById('columnOptions');
      optionsDiv.innerHTML = '';
      const ignoreColumns = ['ANAME', 'INAME'];

      chitGrid.getColumns().forEach(col => {
        if (ignoreColumns.includes(col.name)) return;

        const isVisible = chitGrid.getColumn(col.name).hidden !== true;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = col.name;
        checkbox.checked = isVisible;

        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            chitGrid.showColumn(e.target.value);
          } else {
            chitGrid.hideColumn(e.target.value);
          }
        });

        const label = document.createElement('label');
        label.className = 'column-option';
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + col.header));

        optionsDiv.appendChild(label);
      });

      e.stopPropagation();
      dialog.show();
    });
 // ë‹¤ì´ì–¼ë¡œê·¸ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', (event) => {
      if (!dialog.open) return;
      if (dialog.contains(event.target)) return;
      dialog.close();
    });

 
 
  initAutoRuleGrid() 


function openAutoRuleModal() {
  const modal = document.getElementById("autoRuleModal");
  modal.style.display = "block"; // ë¨¼ì € ëª¨ë‹¬ ë³´ì—¬ì£¼ê³ 

  setTimeout(() => {
    if (autoRuleGrid) autoRuleGrid.refreshLayout(); // ë Œë”ë§ ì˜¤ë¥˜ ë°©ì§€

    $.ajax({
      url: `/erp/accounting/ruleList`,
      method: 'GET',
      data: { comId },
      dataType: 'json',
      success: function (data) {
        autoRuleGrid.resetData(data || []);
      },
      error: function () {
        alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ìë™ë¶„ê°œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        autoRuleGrid.resetData([]);
      }
    });
  }, 100); // ì•½ê°„ì˜ ë”œë ˆì´ë¡œ display ë°˜ì˜ ê¸°ë‹¤ë¦¼
}

  
    function initAutoRuleGrid() {
    	  autoRuleGrid = new tui.Grid({
    	    el: document.getElementById('autoRuleGrid'),
    	    bodyHeight: 300,
    	    scrollX: false,
    	    scrollY: true,
    	    editingEvent: 'click',
    	    rowHeaders: ['rowNum'],
    	    columns: [
    	      { header: 'ê±°ë˜ìœ í˜•', name: 'chitType', editor: { type: chtTypeEditor }, formatter: ({ row }) => row.TNAME ||row.chitType },
    	      { header: 'ì°¨/ëŒ€', name: 'itpType', editor: { type: indTypeEditor }, formatter: ({ row }) => row.INAME || row.itpType },
    	      { header: 'ê³„ì •ì½”ë“œ', name: 'acctCode', editor: { type: acctTypeEditor }, formatter: ({ row }) => row.ANAME || row.acctCode},
    	      { header: 'ë¹„ê³ ', name: 'note', editor: 'text' },
    	      { name: 'ANAME', hidden: true },
    	      { name: 'INAME', hidden: true },
    	      { name: 'TNAME', hidden: true },
    	      {
    	        header: 'í–‰ì¶”ê°€/ì‚­ì œ',
    	        name: 'actions',
    	        formatter: () => `<button class="delete-rule">ğŸ—‘</button>`
    	      }
    	    ],
    	    data: []
    	  });
    	}
    autoRuleGrid.on('click', (ev) => {
    	  const { rowKey, columnName } = ev;
    	  const target = ev.nativeEvent.target;

    	  if (target.classList.contains('delete-rule')) {
    	    autoRuleGrid.removeRow(rowKey);
    	  }
    	});
    
    function addAutoRuleRow() {
      autoRuleGrid.appendRow({
        chitType: '',
        itpType: '',	
        acctCode: '',
        note: ''
      }, { focus: true });
    }


    function getAutoRulePayload() {
    	  const rows = autoRuleGrid.getData();
    	  return rows
    	    .filter(row => row.chitType && row.itpType && row.acctCode) // í•„ìˆ˜ê°’ë§Œ
    	    .map(row => ({
    	      chitType: row.chitType,
    	      itpType: row.itpType,
    	      acctCode: row.acctCode,
    	      note: row.note
    	    }));
    	}

    function saveAutoRules() {
    	  const rules = getAutoRulePayload();

    	  if (rules.length === 0) {
    	    alert("ì…ë ¥ëœ ìë™ë¶„ê°œ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.");
    	    return;
    	  }

    	  const hasEmpty = rules.some(rule => !rule.chitType || !rule.itpType || !rule.acctCode);
    	  if (hasEmpty) {
    	    alert("ê±°ë˜ìœ í˜•, ì°¨/ëŒ€, ê³„ì •ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
    	    return;
    	  }

    	  fetch("/erp/accounting/ruleSave", {
    	    method: "POST",
    	    headers: { "Content-Type": "application/json" },
    	    body: JSON.stringify(rules)
    	  }).then(() => {
    	    alert("ìë™ë¶„ê°œ ì €ì¥ ì™„ë£Œ");
    	    hideAutoRuleModal();
    	  });
    	}


    function hideAutoRuleModal() {
    	  document.getElementById('autoRuleModal').style.display = 'none';
    	}
// ë¶„ê°œ ì˜¤í†  ë²„íŠ¼
    const vatAcctCodeList = ['210101', 'ë¶€ê°€ì„¸ê³„ì •ì½”ë“œì˜ˆì‹œ']; // ì‹¤ì œ DB ê³„ì •ì½”ë“œë¡œ
    
/*
    function addDetailRow(parentRowKey) {
      const parentRow = autoRuleGrid.getRow(parentRowKey);
      if (!parentRow || !parentRow.chitType) {
        alert("ê±°ë˜ìœ í˜•ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      autoRuleGrid.appendRow({
        chitType: '',
        indType: '',
        acctCode: '',
        note: '',
        _attributes: { parentRowKey }
      }, { parentRowKey, position: 'after' });
    }
    
        // ë£°(ë¶€ëª¨+í•˜ìœ„ ì „ì²´) ì‚­ì œ
    function deleteRuleRow(parentRowKey) {
      const rows = autoRuleGrid.getData();
      // ë¶€ëª¨í–‰ê³¼ ê·¸ ìì‹í–‰ë“¤ rowKey ìˆ˜ì§‘
      const toDelete = [parentRowKey];
      rows.forEach((row, idx) => {
        if (row._attributes?.parentRowKey === parentRowKey) {
          toDelete.push(idx);
        }
      });
      // ì—­ìˆœìœ¼ë¡œ ì‚­ì œ(ì¸ë±ìŠ¤ ê¼¬ì„ ë°©ì§€)
      toDelete.sort((a, b) => b - a).forEach(idx => autoRuleGrid.removeRow(idx));
    }

    // ë¶„ê°œë¼ì¸(ìì‹í–‰)ë§Œ ì‚­ì œ
    function deleteDetailRow(rowKey) {
      autoRuleGrid.removeRow(rowKey);
    }

    autoRuleGrid.on('click', ev => {
    	  const { rowKey, columnName } = ev;
    	  const target = ev.nativeEvent.target;

    	  if (columnName !== 'actions') return;

    	  if (target.textContent.includes('ï¼‹')) {
    	    addDetailRow(rowKey); // ë¶€ëª¨ ì•„ë˜ ê·œì¹™ ì¶”ê°€
    	  }

    	  if (target.textContent.includes('-')) {
    	    const row = autoRuleGrid.getRow(rowKey);
    	    if (row._attributes?.parentRowKey !== undefined) {
    	      deleteDetailRow(rowKey); // ìì‹ ì‚­ì œ
    	    } else {
    	      deleteRuleRow(rowKey); // ë¶€ëª¨ ë° ìì‹ ì‚­ì œ
    	    }
    	  }
    	});
*/
</script>
</html>
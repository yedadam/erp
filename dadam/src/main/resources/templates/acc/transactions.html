<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<body class="bg-light">
	<div class="container-fluid mt-4 p-4 rounded shadow-sm">

		<!-- âœ… í—¤ë” + ë¶€ê°€ê¸°ëŠ¥ -->
		<div class="d-flex justify-content-between align-items-center mb-2">
			<div>
				<h3 class="mb-1 text-secondary fw-bold border-bottom pb-2">ì…ì¶œê¸ˆë‚´ì—­
					ê´€ë¦¬</h3>
			</div>
			<!-- ìš°ì¸¡ì— ë²„íŠ¼ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— -->
		</div>

		<!-- âœ… ì£¼ìš” ê¸°ëŠ¥ ë²„íŠ¼ ì˜ì—­ -->
		<div class="d-flex justify-content-end flex-wrap gap-2 mb-3">
			<button id="btn-add" class="btn btn-outline-primary btn-sm">
				<i class="fas fa-plus"></i> í–‰ì¶”ê°€
			</button>
			<button id="btn-save" class="btn btn-primary btn-sm">
				<i class="fas fa-save"></i> ì €ì¥
			</button>
		</div>

		<!-- âœ… ê·¸ë¦¬ë“œ ì˜ì—­ -->
		<div id="mainGridWrapper"
			class="position-relative border rounded p-3 bg-white shadow-sm">
			<div id="tranGrid" class="position-relative"></div>
			<div id="gridSpinner"
				class="position-absolute top-0 start-0 w-100 h-100 bg-white d-flex align-items-center justify-content-center"
				style="top: 50px; display: none; z-index: 50;">
				<dotlottie-player
					src="https://lottie.host/e8b36d4d-46d8-429f-98b8-d8c1c4dde598/p6hfbX0nTd.lottie"
					background="transparent" speed="1"
					style="width: 200px; height: 100px;" loop autoplay>
				</dotlottie-player>
			</div>
		</div>
	</div>
	<!-- ê±°ë˜ì²˜ ëª¨ë‹¬ ì¶”ê°€ -->
	<div class="modal fade" id="vdrModal" tabindex="-1"
		aria-labelledby="vdrModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="vdrModalLabel">ê±°ë˜ì²˜ ì„ íƒ</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<!-- ê²€ìƒ‰ì°½ -->
					<div class="position-relative mb-3" style="max-width: 500px;">
						<div class="input-group">
							<select class="form-select" id="vdrSearchSelect"
								style="max-width: 30%;">
								<option value="vdrCode">ê±°ë˜ì²˜ì½”ë“œ</option>
								<option value="vdrName">ê±°ë˜ì²˜ëª…</option>
								<option value="addr">ì£¼ì†Œ</option>
							</select> <input type="text" class="form-control" id="vdrSearchInput"
								placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
							<button class="btn btn-outline-secondary" type="button"
								id="vdrSearchBtn">
								<i class="fas fa-search"></i>
							</button>
						</div>
					</div>
					<!-- ê·¸ë¦¬ë“œ -->
						<div id="vdrGrid"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
</body>

<script>
const tranGrid = new tui.Grid({
	  el: document.getElementById('tranGrid'),
	  scrollX: false,
	  scrollY: false,
	  bodyHeight: 400,
	  pageOptions: { perPage: 10, useClient: true },
	  rowKey: 'txnHistCode', // rowKey í•„ë“œ ì§€ì •
	  columns: [
	    { header: 'ì½”ë“œ', name: 'txnHistCode', editor: 'text', hidden: true },
	    { header: 'ê±°ë˜ì¼ì', name: 'txnDate' },
	    { header: 'ì…ì¶œê¸ˆêµ¬ë¶„', name: 'txnType', editor: 'text', hidden: true },
	    { header: 'ì´ë¦„', name: 'txnName', width: 220, editor: 'text',
	      formatter: ({ value }) => `
	        <div style="display:flex; align-items:center;">
	          <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${value || ''}</span>
	          <button class="btn btn-xs btn-light border vdr-btn" style="margin-left:4px; padding:2px 6px; font-size:12px;">
	            <i class="fas fa-search"></i>
	          </button>
	        </div>
	      `
	    },
	    { header: '', name: 'selectVdr', width: 40, hidden: true ,
	      formatter: () => `
	        <button class="btn btn-xs btn-light border vdr-btn" style="padding:2px 6px; font-size:12px;">
	          <i class="fas fa-search"></i>
	        </button>
	      `
	    },
	    { header: 'ì…ê¸ˆ', name: 'deposit', editor: 'text', align: 'right', formatter: ({ value }) => value ? parseInt(value).toLocaleString() + 'ì›' : '' },
	    { header: 'ì¶œê¸ˆ', name: 'withdraw', editor: 'text', align: 'right', formatter: ({ value }) => value ? parseInt(value).toLocaleString() + 'ì›' : '' },
	    { header: 'ì”ì•¡', name: 'balance', align: 'right', formatter: ({ value }) => value ? parseInt(value).toLocaleString() + 'ì›' : '' },
	    { header: 'ì€í–‰', name: 'bank', editor: 'text' },
	    { header: 'ê³„ì¢Œë²ˆí˜¸', name: 'acctNo', editor: 'text' },
	    { header: 'ë©”ëª¨', name: 'txnMemo', editor: 'text' },
	    { header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'vdrCode', hidden: true }
	  ],
	  data: []
	});
	
// ë³„ë„ ë²„íŠ¼ ì»¬ëŸ¼ í´ë¦­ ì´ë²¤íŠ¸
tranGrid.on('click', ev => {
  if (ev.columnName === 'txnName' && $(ev.nativeEvent.target).closest('.vdr-btn').length) {
    openVdrModal(ev.rowKey);
  }
});

// ì…ì¶œê¸ˆë‚´ì—­ ëª©ë¡ ì•„ì‘ìŠ¤
function fetchData() {
  $.ajax({
    url: '/erp/accounting/transactions',
    method: 'GET',
    dataType: 'json',
    data: { comId },
    success: function (data) {
      // txnType ê°’ì— ë”°ë¼ ì…ê¸ˆ/ì¶œê¸ˆ ê°’ ì„¤ì •
      const displayData = data.map(row => {
        if (row.txnType === 'tt01') {
          row.deposit = row.price;
        } else if (row.txnType === 'tt02') {
          row.withdraw = row.price;
        }
        return row;
      });
      tranGrid.resetData(displayData);
    },
    error: function () {
    }
  }).always(function() {
		 setTimeout(function() {
			 $('#gridSpinner').removeClass('d-flex').hide();
		    }, 750);
	});
}
        
        
        
fetchData();
	
        //í–‰ì¶”ê°€
$('#btn-add').on('click', function () {
  // ê¸°ì¡´ ë°ì´í„°ì—ì„œ txnHistCode ìµœëŒ€ê°’ + 1ë¡œ ì„ì‹œ ë¶€ì—¬ (ìˆ«ìí˜•ì¼ ë•Œ)
  const data = tranGrid.getData();
  const maxTxnHistCode = data.length > 0
    ? Math.max(...data.map(r => Number(r.txnHistCode) || 0))
    : 0;
  const newTxnHistCode = maxTxnHistCode + 1;

  tranGrid.appendRow({
    txnHistCode: newTxnHistCode, // ì„ì‹œ rowKey ë¶€ì—¬
    deposit: '',
    withdraw: '',
    balance: '',
    txnName: '',
    bank: '',
    acctNo: '',
    txnMemo: ''
  }, { at: 0, rowKey: newTxnHistCode }); // rowKeyë¥¼ ë‘ ë²ˆì§¸ ì¸ìì— ëª…ì‹œ
});
        
     // ì €ì¥ ë²„íŠ¼
        $('#btn-save').on('click', function () {
  const changes = tranGrid.getModifiedRows();
  const payload = {
    createdRows: changes.createdRows.map(row => {
      let txnType = '';
      let price = 0;

      // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì— ë”°ë¼ txnType ê²°ì •
      if (row.deposit && !row.withdraw) {
        txnType = 'tt01';
        price = parseInt(row.deposit);
      } else if (!row.deposit && row.withdraw) {
        txnType = 'tt02';
        price = parseInt(row.withdraw);
      } else {
        alert("ì…ê¸ˆ ë˜ëŠ” ì¶œê¸ˆ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥í•˜ì„¸ìš”.");
        return null;
      }

      return {
        txnName: row.txnName,
        vdrCode: row.vdrCode,
        txnType,
        price,
        balance: row.balance,
        bank: row.bank,
        acctNo: row.acctNo,
        txnMemo: row.txnMemo
      };
    }).filter(row => row !== null)
  };

  if (payload.createdRows.length === 0) return;

  $.ajax({
    url: '/erp/accounting/transactionsData',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(payload),
    success: function (res) {
      alert('ì €ì¥ ì™„ë£Œ');
      fetchData();
    },
    error: function () {
      alert('ì €ì¥ ì‹¤íŒ¨');
    }
  });
});

// ê±°ë˜ì²˜ ê·¸ë¦¬ë“œ ë° ëª¨ë‹¬ ì—°ë™
let vdrGrid;
let vdrAll = [];
let selectedTranRowKey = null;

// ê±°ë˜ì²˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ê²€ìƒ‰ì¡°ê±´ ë°˜ì˜)
function fetchVdrList() {
  const type = $('#vdrSearchSelect').val();
  const keyword = $('#vdrSearchInput').val().trim();
  const params = { comId };

  if (keyword) {
    params['type'] = type;
    params['value'] = keyword;
  }

  $.ajax({
    url: '/erp/accounting/venderAll',
    method: 'GET',
    data: params,
    success: function (result) {
      vdrAll = result;
      vdrGrid.resetData(vdrAll);
      vdrGrid.refreshLayout();
    }
  })
}

// ê²€ìƒ‰ ë²„íŠ¼/ì—”í„° ì´ë²¤íŠ¸
$(document).on('click', '#vdrSearchBtn', fetchVdrList);
$(document).on('keydown', '#vdrSearchInput', function(e) {
  if (e.key === 'Enter') fetchVdrList();
});

function openVdrModal(rowKey) {
  selectedTranRowKey = Number(rowKey); // numberë¡œ ì €ì¥

  const vdrModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('vdrModal'));
  vdrModal.show();

  // 1. ëª¨ë‹¬ show ì´í›„ grid ìƒì„± ë˜ëŠ” ë°ì´í„° ì„¸íŒ…
  setTimeout(() => {
    if (!vdrGrid) {
      vdrGrid = new tui.Grid({
        el: document.getElementById('vdrGrid'),
        scrollX: true,
        scrollY: true,
        rowHeaders: ['checkbox'],
        pageOptions: { perPage: 5, useClient: true },
        columns: [
          { header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'vdrCode', align: 'center' },
          { header: 'ê±°ë˜ì²˜ëª…', name: 'vdrName', align: 'center' },
          { header: 'ì£¼ì†Œ', name: 'addr', align: 'center' },
          { header: 'ì€í–‰', name: 'bank', align: 'center' },
          { header: 'ê³„ì¢Œë²ˆí˜¸', name: 'acctNo', align: 'center' }
        ]
      });
    }

    // ğŸ” í•­ìƒ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bindVdrGridEvent();
    fetchVdrList();
  }, 200);
}

	
	
function bindVdrGridEvent() {
	  vdrGrid.off('click');
	  vdrGrid.on('click', (ev) => {
	    const rowData = vdrGrid.getRow(ev.rowKey);
	    console.log('[ì„ íƒí•œ ê±°ë˜ì²˜]', rowData);
	    console.log('[ì ìš© ëŒ€ìƒ rowKey]', selectedTranRowKey);

	    if (!rowData || selectedTranRowKey == null) return;

	    // âœ… í¸ì§‘ ì¢…ë£Œ í›„ ê°’ ì…ë ¥
	    tranGrid.finishEditing();

	    tranGrid.setValue(selectedTranRowKey, 'txnName', rowData.vdrName);
	    tranGrid.setValue(selectedTranRowKey, 'acctNo', rowData.acctNo);
	    tranGrid.setValue(selectedTranRowKey, 'bank', rowData.bank);	    
	    tranGrid.setValue(selectedTranRowKey, 'vdrCode', rowData.vdrCode);

	    const vdrModalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('vdrModal'));
	    vdrModalInstance.hide();
	    vdrGrid.uncheckAll();
	  });
	}





// openVdrModalì—ì„œ fetchVdrList í˜¸ì¶œë¡œ ë³€ê²½
/* function openVdrModal(rowKey) {
  selectedTranRowKey = rowKey;

  if (!vdrGrid) {
    vdrGrid = new tui.Grid({
      el: document.getElementById('vdrGrid'),
      scrollX: true,
      scrollY: true,
      rowHeaders: ['checkbox'],
      pageOptions: { perPage: 5, useClient: true },
      columns: [
        { header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'vdrCode', align: 'center' },
        { header: 'ê±°ë˜ì²˜ëª…', name: 'vdrName', align: 'center' },
        { header: 'ì£¼ì†Œ', name: 'addr', align: 'center' },
        { header: 'ì€í–‰', name: 'bank', align: 'center' },
        { header: 'ê³„ì¢Œë²ˆí˜¸', name: 'acctNo', align: 'center' }
      ]
    });

    vdrGrid.on('click', (ev) => {
      const rowData = vdrGrid.getRow(ev.rowKey);
      if (!rowData) return;
      tranGrid.setValue(selectedTranRowKey, 'txnName', rowData.vdrName);
      tranGrid.setValue(selectedTranRowKey, 'acctNo', rowData.acctNo);

      const vdrModalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('vdrModal'));
      vdrModalInstance.hide();
      vdrGrid.uncheckAll();
    });
  }

  // ëª¨ë‹¬ ë¨¼ì € ì—´ê³  â†’ ë Œë”ë§ ì´í›„ â†’ ë°ì´í„°ë¥¼ ì„¸íŒ…
  const vdrModal = new bootstrap.Modal(document.getElementById('vdrModal'));
  vdrModal.show();

  setTimeout(() => {
    fetchVdrList(); // â† ì´ íƒ€ì´ë°ì— resetData()ê°€ ì‹¤í–‰ë˜ì–´ì•¼ ì •ìƒ ë Œë”ë§ ë¨
  }, 200);
} */

/* tranGrid.on('dblclick', (ev) => {
	  if (ev.columnName === 'txnName') {
	    openVdrModal(ev.rowKey);
	  }
	}); */
	
// ì´ë¦„ ì…€ í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ
/* tranGrid.on('click', (ev) => {
  if (ev.columnName === 'txnName') {
    openVdrModal(ev.rowKey);
  }
}); */

// tranGrid ì»¬ëŸ¼ì— vdrCode ì¶”ê°€ (ìˆ¨ê¹€)
tranGrid.setColumns([
  ...tranGrid.getColumns(),
  { header: 'ê±°ë˜ì²˜ì½”ë“œ', name: 'vdrCode', hidden: true }
]);

$(document).on('click', '#vdrModal .btn-secondary', function () {
	  const vdrModalInstance = bootstrap.Modal.getOrCreateInstance(document.getElementById('vdrModal'));
	  vdrModalInstance.hide();
	});
    </script>
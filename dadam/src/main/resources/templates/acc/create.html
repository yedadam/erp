<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<style>
  .row-selected {
    background-color: #e6f2ff !important;
  }
</style>
</head>
<body class="bg-light">
  <div class="container-fluid mt-4" style="max-width: 1200px;">
    
    <!-- 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold mb-0">여신 관리</h3>
      <small class="text-muted ms-2">
        ※ 조회 / 여신금액 초과 / 여신기간 초과 시 표시 예정 · 공통코드 처리 예정
      </small>
    </div>

    <!-- 메인 여신 그리드 -->
    <div class="col-12">
      <div id="creGrid" class="mx-3"></div>
    </div>

    <!-- 상세 거래 내역 -->
    <div id="detailContainer" class="mt-4" style="display: none;">
      <hr>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">상세 거래 내역</h5>
      </div>
      <div class="col-12">
        <div id="detailGrid" class="mx-3"></div>
      </div>
    </div>

  </div>
</body>


<script>
let creGrid, detailGrid;



creGrid = new tui.Grid({
	el : document.getElementById('creGrid'),
	
	rowHeaders : ['checkbox'],
	
	scrollX : false,
	scrollY : false,
	
	pagination: true,
	pageOptions:{
		useClient:true,
		perPage:10
	},
	
	columns:[
		{header: '거래처',name:'vdrName',align:'center'},
		{header: '거래처코드',name:'vdrCode',align:'center'},
		{header: '사업자번호',name:'bizNo',align:'center'},
		{header: '담당자',name:'empId',align:'center'},
		{header: '미수총금액',name:'creditPrice',align:'right', 
			formatter: ({value}) => value.toLocaleString()+ '원'},
		{header: '미수잔액',name:'creditBalPrice',align:'right',
			formatter: ({value}) => value.toLocaleString()+ '원'},
		{header: '미수개월',name:'creditPeriod',align:'center', 
			formatter: ({value}) => value + '개월'},
		{header: '상태',name:'status',align:'center'},
		{header: '최근거래일자',name:'createdDate',align:'center'},
	]
})

// 여신 헤더 아작스
function creditList(){
	$.ajax({
		url: "/erp/accounting/creditFindAll",
		method:"GET",
		success: function(result){
			console.log(result)
		creGrid.resetData(result);
		}
	});
}

creditList()

let selectedRowKey = null;

// 여신 헤더 클릭 이벤트
creGrid.on('click', (ev)=> {
	if(typeof ev.rowKey !== 'number') return;
	
	const checkedRowKeys = creGrid.getCheckedRowKeys();
	console.log(checkedRowKeys)
	
	// 클릭한 행의 row 선택/ 추가선택시 row 해제/ 다른행 클릭시 row 변경
	if(checkedRowKeys.includes(ev.rowKey)){
		creGrid.uncheck(ev.rowKey)
		detailGrid.resetData([]);
		$('#detailContainer').hide();
		
		creGrid.removeRowClassName(ev.rowKey, 'row-selected');
		selectedRowKey = null;
	}else{
		creGrid.uncheckAll();
		creGrid.check(ev.rowKey);
		
		if (selectedRowKey !== null) {
			creGrid.removeRowClassName(selectedRowKey, 'row-selected');
		}
		
		selectedRowKey = ev.rowKey;
		creGrid.addRowClassName(ev.rowKey, 'row-selected');
	
	const rowData = creGrid.getRow(ev.rowKey);
	const vdrCode = rowData.vdrCode;
	
	getCreditDetail(vdrCode);
	}
})

function getCreditDetail(vdrCode){
	$.ajax({
		url: "/erp/accounting/creditFindByCode",
		method:"GET",
		data : { vdrCode : vdrCode },
		success: function(result){
			console.log('상세내역 : ', result)
			detailGrid.resetData(result);
			
			$('#detailContainer').show();
			setTimeout(() => {
				detailGrid.refreshLayout();
				detailGrid.resetData(result);
			}, 1); // 짧은 지연 시간
		}
	});
}



detailGrid = new tui.Grid({
	el:document.getElementById('detailGrid'),
	rowHeaders:['checkbox'],
	scrollX : false,
	scrollY : false,
	
	pagination: true,
	pageOptions:{
		useClient:true,
		perPage:5
	},
	
	columns:[
		{header: '주문번호',name:'articleCode',align:'center'},
		{header: '여신내역',name:'creditPrice',align:'center',
			formatter: ({value}) => value?.toLocaleString() + '원' || ''},
		{header: '총금액', name: 'totPrice', align: 'right',
			formatter: ({value}) => value?.toLocaleString() + '원' || ''},
		{header: '잔액', name: 'creditBalPrice', align: 'right',
			formatter: ({value}) => value?.toLocaleString() + '원' || ''},
		{header: '입금은행', name: 'bank', align: 'center'},
		{header: '계좌번호', name: 'acctNo', align: 'center'},
		{header: '유형', name: 'type', align: 'center'},
		{header: '담당자', name: 'empId', align: 'center'},
		{header: '처리자', name: 'phyEmpId', align: 'center'},
		{header: '거래일자', name: 'createdDate', align: 'center'},
		{header: '전표번호', name: 'chitCode', align: 'center'}
	]	
})


</script>

</html>
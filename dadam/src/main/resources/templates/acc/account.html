<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">

<body>
<h6>대,중,소 분류 추가 기능 만들어야함!!!!! (후순위로 배정)</h6> 
	<h2 class="mt-4 mb-3">계정과목 관리</h2>

	<div class="container" style="max-width: 1200px; margin: 0 auto;">
		<!-- 상단 버튼: 좌측 (조회/수정/등록), 우측 (동적 버튼들) -->
		<div class="d-flex justify-content-between align-items-center mb-3">
			<!-- 왼쪽: 모드 버튼 -->
			<div class="btn-group" role="group">
				<button class="btn btn-dark" onclick="changeMode('read')">조회</button>
				<button class="btn btn-warning" onclick="changeMode('edit')">수정</button>
				<button class="btn btn-success" onclick="changeMode('create')">등록</button>
			</div>

			<!-- 오른쪽: 모드별 동적 버튼 -->
			<div class="btn-group" role="group">
				<button id="addRow" class="btn btn-info" style="display: none;">행
					추가</button>
				<button id="saveBtn" class="btn btn-primary" style="display: none;">저장</button>
				<button id="excel" class="btn btn-outline-dark"
					style="display: none;">엑셀다운</button>
				<button id="excelTemplate" class="btn btn-outline-dark"
					style="display: none;">양식다운</button>
				<input type="file" id="excelUpload" accept=".xlsx, .xls"
					style="display: none;" />
			</div>
		</div>

		<!-- 필터 버튼: 대분류별 구분 -->
		<div class="btn-group mb-4" role="group" aria-label="계정 분류 필터">
			<button class="btn btn-outline-secondary typeBtn" data-type="">모두</button>
			<button class="btn btn-outline-primary typeBtn" data-type="1">자산</button>
			<button class="btn btn-outline-primary typeBtn" data-type="2">부채</button>
			<button class="btn btn-outline-primary typeBtn" data-type="3">자본</button>
			<button class="btn btn-outline-primary typeBtn" data-type="4">수익</button>
			<button class="btn btn-outline-primary typeBtn" data-type="5">비용</button>
		</div>

		<hr />

		<!-- Toast UI Grid 영역 -->
		<div class="col-14">
			<div id="accGrid" class="mx-4"></div>
		</div>
	</div>
</body>
<script>
//텍스트 자동 완성
function createAutoCompleteEditor({ urlBuilder, deps = [], onSelectClear = [] }) {
  function CustomEditor(props) {
	//인풋 기능 활성화(행 클릭으로 활성화시 편집기 오픈)  
    const el = document.createElement('input'); 
    el.type = 'text';
    el.className = 'form-control';

    el.value = props.value || '';
  	// 자동완성 기능 : source로 자동완성으 Ajax로 받아옴.
    $(el).autocomplete({ 
      // 코어기능 : 활성화된 행(row) deps에 해당하는 값을 가져옴.	
      source: function (request, response) { 
        const depValues = deps.map(dep => props.grid.getValue(props.rowKey, dep));
        // if문은 예외 처리 : 
        // 상위 필드가 비어있을때 비활성화 // 상위 값을 먼저 입력하도록 ux 추가 
        if (depValues.includes('') || depValues.includes(undefined)) { 
          return response([]);
        } //if문 종료
        
        // url생성-Ajax 요청
        // urlBuilder를 실행하여 API 주소생성
        // 조회된 결과를 JSON 으로 받음.
        const url = urlBuilder(...depValues); 
        $.getJSON(url, function (data) {
          const results = data.filter(v => v.startsWith(request.term));
          response(results);
        }); // $.getJSON(url, function 종료
      }, // source: function  종료
      minLength: 0,
      
      // 항목 선택 : 항목 선택시 지정된 onSelectClear에 등록된 셀들을 비우기.
      select: function () {
        onSelectClear.forEach(col => props.grid.setValue(props.rowKey, col, ''));
      } // select: function 종료
      
      //셀 클릭시 자동으로 목록 출력
    }).focus(function () {
      $(this).autocomplete("search", "");
    }); // focus(function () 종료
    this.el = el;
  }// function CustomEditor(props) 종료
  // getElement 메서드 추가
  CustomEditor.prototype.getElement = function () {
    return this.el;
  };
  // getValue 메서드 추가
  CustomEditor.prototype.getValue = function () {
    return this.el.value;
  };
  return CustomEditor;
} // function createAutoCompleteEditor 종료

	// 대분류 조회 
	const TypeEditor = createAutoCompleteEditor({
	  urlBuilder: () => "/erp/accounting/api/account/type",  // API URL 만드는 함수
	  deps: [],												 // 의존 필드 (상위 값들) -> 필드 명으로 적기
	  onSelectClear: ['acctClass', 'acctSubclass']			 // 값 선택 시 초기화할 필드들 -> 필드 명으로 적기
	});

	// 중분류 조회 
	const ClassEditor = createAutoCompleteEditor({
	  urlBuilder: (acctType) => `/erp/accounting/api/account/class?typeCode=${acctType}`,
	  deps: ['acctType'], 
	  onSelectClear: ['acctSubclass']
	});

	// 소분류 조회 
	const SubclassEditor = createAutoCompleteEditor({
	  urlBuilder: (acctClass) => `/erp/accounting/api/account/subclass?&classCode=${acctClass}`,
	  deps: ['acctClass']
	});
	
	
  let accGrid;
  let currentMode = 'read';

  const columnsBase = [
    { header: '계정코드', name: 'acctCode', align: 'center', width: 100 },
    { header: '대분류',name:'acctType',align:'center', editor: { type: TypeEditor }, width:100 },
    { header: '중분류',name:'acctClass',align:'center',editor: { type: ClassEditor }, width:100 },
    { header: '소분류',name:'acctSubclass',align:'center',editor: { type: SubclassEditor }, width:100 },
    { header: '계정명', name: 'name', align: 'center', width: 200 },
    {
      header: '사용유무',
      name: 'acctYn',
      align: 'center',
      width: 100,
      formatter: ({ value }) => value === 'Y' ? '사용' : '무사용',
      renderer: {
        type: ToggleRenderer
      }
    },
    { header: '비고', name: 'note', align: 'center', width: 450 }
  ];

  function ToggleRenderer(props) {
    const el = document.createElement('input');
    el.type = 'checkbox';
    el.checked = props.value === 'Y';
    el.disabled = currentMode === 'read';

    el.addEventListener('change', () => {
      const newValue = el.checked ? 'Y' : 'N';
      props.grid.setValue(props.rowKey, props.columnInfo.name, newValue);
    });

    this.el = el;
  }
  ToggleRenderer.prototype.getElement = function () {
    return this.el;
  };

// 텝효과로 그리드 상태 변경
  function initGrid(mode) {
    const isEditable = mode !== 'read';
    const isCreate = mode === 'create';

    const columns = columnsBase.map(col => {
      if (['name', 'note'].includes(col.name)) {
        return { ...col, editor: isEditable ? 'text' : undefined };
      }
      if (['acctType', 'acctClass', 'acctSubclass'].includes(col.name)) {
    	  return { ...col, editor: isEditable ? col.editor : undefined };
    	}
      return col;
    });

    if (accGrid) accGrid.destroy();

    accGrid = new tui.Grid({
      el: document.getElementById('accGrid'),
      scrollX: false,
      scrollY: false,
//      pagination: true,
//     pageOptions: {
//        useClient: true,
//        perPage: 10,
//      },
      columns
    });

    loadData();
  }


  function loadData() {
    fetch('/erp/accounting/accFindAll')
      .then(res => res.json())
      .then(data => accGrid.resetData(data));
  }

  //상태 변경 [조회/ 수정 / 등록]
  function changeMode(mode) {
    currentMode = mode;
    document.getElementById('addRow').style.display = mode === 'create' ? '' : 'none';
    document.getElementById('excel').style.display = mode === 'create' ? '' : 'none';
    document.getElementById('excelTemplate').style.display = mode === 'create' ? '' : 'none';
    document.getElementById('excelUpload').style.display = mode === 'create' ? '' : 'none';
    document.getElementById('saveBtn').style.display = mode !== 'read' ? '' : 'none';
    initGrid(mode);
  }
  
			

  // 행 추가
  document.getElementById('addRow').addEventListener('click', () => {
    accGrid.prependRow({
      acctCode: '',
      acctType: '',
      acctClass: '',
      acctSubclass: '',
      name: '',
      acctYn: 'Y',
      note: ''
    });
  });

  // 저장
$('#saveBtn').on('click', function () {
    const changes = accGrid.getModifiedRows();

    const payload = {
        createdRows: changes.createdRows,
        updatedRows: changes.updatedRows,
        deletedRows: changes.deletedRows
    };

    fetch("/erp/accounting/saveAll", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.result === "success") {
            alert(data.message);
            accountList(); // 새로고침
        } else {
            alert("실패: " + data.message);
        }
    })
});
  

//전체 조회
  function accountList() {
     $.ajax({
        url: "/erp/accounting/accFindAll",
        method: "GET",
        success: function(result){
           console.log(result)
           accGrid.resetData(result);
        }
     });
  }

  // 필터 조회
  $('.typeBtn').on('click', function () {
    const type = $(this).data('type'); // ✔️ 올바른 속성명 사용
    const url = type ? `/erp/accounting/accFindByType?acctType=${type}` : `/erp/accounting/accFindAll`;

    $.get(url, function (data) {
      accGrid.resetData(data);
    });
  });
  // 페이지 로드 시 조회목록 시작
  window.onload = () => changeMode('read');
  
  
//엑셀 다운로드.
  const topOptions = {
             includeHiddenColumns: true,
             onlySelected: false,
             fileName: '계정과목',
           };
  $('#excel').on('click',function(){
     accGrid.export('xlsx',topOptions);
  })



  //양식 다운/////
  $('#excelTemplate').on('click', function () {
    const header = [
      ["대분류", "중분류","소분류", "계정명", "사용유무", "비고"]
    ];

    const ws = XLSX.utils.aoa_to_sheet(header); // 엑셀 시트 생성
    const wb = XLSX.utils.book_new();// 엑셀 워크북 생성
    XLSX.utils.book_append_sheet(wb, ws, "업로드양식"); // 시트 추가
    XLSX.writeFile(wb, "계정과목_업로드양식.xlsx");// 파일 저장
  });


  //엑셀폼의 한글컬럼과 데이터베이스 컬럼명을 멥핑
  function mapKeysToInternal(data){
  	const columnMap = {
  			  '대분류': 'acctType',
  			  '중분류': 'acctClass',
  			  '소분류': 'acctSubclass',
  			  '계정명': 'name',
  			  '사용유무': 'acctYn',
  			  '비고': 'note'
  	};
  	
  	return data.map(row => {
  		const newRow = {};
  		for(let key in row){
  			const mappedKey = columnMap[key];
  			if (mappedKey){
  				newRow[mappedKey] = row[key];
  			}
  		}
  		return newRow;
  	})
  }


  //엑셀 업로드  https://docs.sheetjs.com
  document.getElementById('excelUpload').addEventListener('change',function(e){
     const file = e.target.files[0];
     const reader = new FileReader();
     
     reader.onload = function(event){
        const data = event.target.result;
        const workbook = XLSX.read(data, {type: 'binary'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet); //첫 행이 칼럼인 행 불러오기
        
        //한글과 영어 매핑
        const mapped = mapKeysToInternal(json)
        
        // 토스트ui 데이터 표시
           console.log(mapped)
    mapped.forEach(item =>{
  	 accGrid.prependRow(item) 
    });
     };
     
     reader.readAsBinaryString(file);
  })
</script>


</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<head>
<style>
.main-table {
	border: 2px solid #0d6efd;
}

.main-table th {
	background-color: #e3f2fd;
	text-align: center;
	vertical-align: middle;
	font-weight: bold;
	border: 1px solid #ddd;
}

.main-table td {
	text-align: center;
	vertical-align: middle;
	border: 1px solid #ddd;
}

.detail-table {
	margin-top: 20px;
}

.detail-table th {
	background-color: #f8f9fa;
	text-align: center;
	font-size: 14px;
	padding: 8px;
}

.detail-table td {
	text-align: center;
	font-size: 14px;
	padding: 8px;
}

.search-container {
	margin-bottom: 20px;
}

.btn-group-custom {
	margin-bottom: 20px;
}

.tui-pagination {
	padding-bottom: 10px;
}

.grid-action {
	display: inline-block;
	padding: 3px 8px;
	font-size: 12px;
	border-radius: 12px;
	border: 1px solid lightgray; /* #cbd5e1 → lightgray */
	background-color: aliceblue; /* #f8fafc → aliceblue */
	color: darkslategray; /* #334155 → darkslategray */
	cursor: pointer;
	transition: all 0.2s ease-in-out;
}

.grid-action:hover {
	background-color: lightsteelblue; /* #e2e8f0 → lightsteelblue */
	border-color: silver; /* #94a3b8 → silver */
	color: midnightblue; /* #1e293b → midnightblue */
}
</style>
</head>
<body class="bg-light">
<div class="container-fluid mt-4">
		<h3 class="mb-4">입고관리</h3>
			<div class="btn-group-custom">
					<button class="btn btn-warning" id="purchasePage" type="button"><i class="fas fa-check-circle"></i> 주문입고</button>
					<button class="btn btn-secondary" id="inboundPage" type="button"><i class="fas fa-right-left"></i> 생산입고</button>
					<button class="btn btn-secondary" id="purchaseOrderPage" type="button"><i class="fas fa-right-left"></i> 발주의뢰</button>
			</div>
			


		<!-- 검색 및 버튼 영역 -->
		<div class="row mb-3">
			<div class="col-md-6 text-start">
				<div class="input-group search-container" style="width: 400px;">
					<input type="text" class="form-control" placeholder="검색어를 입력하세요">
					<button class="btn btn-outline-secondary" type="button">
						<i class="fas fa-search"></i>
					</button>
				</div>
			</div>

			<!-- custom button -->
			<div class="col-md-6 text-end">
				<div class="btn-group-custom">
					<button class="btn btn-danger" id="reset">
						<i class="fas fa-square-minus"></i> 초기화
					</button>
					<button class="btn btn-primary" data-bs-toggle="modal"
						data-bs-target="#inboundModal" id="inModal">
						<i class="fas fa-warehouse"></i> 입고
					</button>
				</div>
			</div>
		</div>
</div>

<!-- 메인 그리드 -->
<div id="Grids"></div>
<!-- 입고를 위한 모달 -->
<div class="modal fade" id="inboundModal" tabindex="-1"
	aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h1>입고</h1>
			</div>
			<div class="modal-body">
					<div class="d-grid gap-2 d-md-flex justify-content-md-end m-2">
						<button class="btn btn-danger" id="resetModal">
						<i class="fas fa-square-minus"></i> 초기화
						</button>
						<button class="btn btn-primary" id="registerBtn">
                        <i class="fas fa-warehouse"></i> 입고
                    	</button>
					</div>
					<div id="gridModal"></div>
			</div>
			<div class="modal-footer"></div>
		</div>
	</div>
</div>
<script th:inline="javascript">
// let empId = [[${#authentication.principal != 'anonymousUser' ? #authentication.principal.userId : 'e1018'}]];
//let empName = [[${#authentication.principal != 'anonymousUser' ? #authentication.principal.username : '김지현'}]];
//let comId = [[${#authentication.principal != 'anonymousUser' ? #authentication.principal.comId : 'com-101'}]];
//ajax -> toastUi에 넣기
function purchaseList(){
	$.ajax({
		url:"/erp/inventory/purchaseList",
		method:"GET",
		data: {comId},
	    success:function(result) {
		   purcharsegrid.resetData(result);
	   } // ajax호출 끝
	})
 };
purchaseList();
let warehouse = [];
// 창고리스트
function warehouseList(){
	  $.ajax({
		url:"/erp/inventory/warehouseList",
		method:"GET",
		data: {comId},
	    success:function(result) {
		  warehouse = result.map(item => ({
			   text:item.name,
			   value:item.locCode
		   }));
		// inboundGrid 그리기
			const inboundGrid = new tui.Grid({
				el: document.getElementById('gridModal'),
				pageOptions: {
			        perPage: 20,
			        useClient: true,
			    },
			    columns:[
					    	{ header: '발주상세코드', name: 'purOrdDtlCode', align:'center'},
					    	{ header: '품목코드', name: 'itemCode', align:'center'},
					    	{ header: '품목명', name: 'itemName', align:'center'},
					    	{ header: '발주량', name: 'quantity', align:'center'},
					    	/* { header: '기입고량', name: 'pquantity', align:'center'},
					    	{ header: '미입고량', name: 'notStock', align:'center'}, */
					    	{ header: '위치', name: 'loc', align:'center', width: 200
					    		, formatter:'listItemText'
					    		,  editor: {
					    		    type: 'select',
					    		    options: {
					    		      listItems: warehouse
					    		    }
					    		  }},
					    	{ header: '입고수량', name: 'qty', align:'center', editor: 'text'},
					    	{ header: '비고', name: 'note', align:'center', editor: 'text'},
					    	{ header: '추가/삭제', name: 'origin', align:'center'
					    		/* , renderer: CustomButton} */
					    	, formatter: (rowKey) => {
					    		if(rowKey.value){
					    			return `<button class="btn btn-sm btn-primary add-btn">+</button>`;
					    		}else{
					    		return `<button class="btn btn-sm btn-danger add-btn">-</button>`;
					    		}
					    	}}
			    		],
			    		columnOptions: {
						frozenCount: 4,
						frozenBorderWidth: 2
			    		}
			});
			// 체크한경우 데이터 넣기
			purcharsegrid.on('check', checkRow)
			purcharsegrid.on('checkAll', checkRow)
			// 체크아웃한경우 데이터 뺴기
			purcharsegrid.on('uncheck', checkRow);
			purcharsegrid.on('uncheckAll', checkRow);
			
			let data;
			// check 처리
			function checkRow(){
				data= [];
				  let rowCheck = purcharsegrid.getCheckedRows();
				  
				  
				  rowCheck.filter(item =>{
					  ee = {
						  purOrdDtlCode: item.purOrdDtlCode,
						  itemCode: item.itemCode,
						  itemName: item.itemName,
						  quantity : item.quantity,
						  price: item.price,
						  /* pquantity: item.pquantity,
					      notStock: item.notStock, */
						  loc : '',
						  qty : '',
						  note: '',
						  origin: true
					  }
					  data.push(ee);
				  })
				  inboundGrid.resetData(data);
			}
			
			
			
			// 초기화
			$('#reset').on('click', ()=>{
				purcharsegrid.uncheckAll();
			})
			// 모달 초기화
			$('#resetModal').on('click', ()=>{
				inboundGrid.resetData(data);
			})
			
			// 입고 등록
			$('#registerBtn').on('click', ()=>{
				let scr1data = inboundGrid.getData();
				for(item in scr1data){
					if(item.loc == ""){
						Swal.fire({
							  icon: "error",
							  title: "빈행 발견!",
							  text: "위치를 지정해주세요!"
							});
						return;
					}else if(item.qty == ""){
						Swal.fire({
							  icon: "error",
							  title: "빈행 발견!",
							  text: "수량을 입력해주세요!"
							});
						return;
					}
				}
				let param = []
				let code = '';
				let items = '';
				let params = []
				let quantityCheck = 0;
				let check = 0;
				let prices = 0;
				let status = ''; // 부분입고
				for(item in scr1data){
					if(item.purOrdDtlCode != ""){
					code = item.purOrdDtlCode
					items = item.itemCode
					prices = item.price
					quantityCheck = item.quantity
					check = 0;
					}

					check += Number(item.qty)
					if(quantityCheck < check){
						Swal.fire({
							  icon: "error",
							  title: "발주량보다 입고수량이 많습니다!",
							  text: "수량을 변경해주세요!"
							});
						return;
					}else if(quantityCheck == check){
							status = 'pct-02'; // 입고완료
					}else{
							status = 'pct-01'; // 부분 입고	
					}
						let params = {
									  purOrdDtlCode: code,
									  itemCode: items,
									  locCode: item.loc,
									  quantity: item.qty,
									  price: prices,
									  note: item.note,
									  empId: empName,
									  comId: comId,
									  currQty: 0,
									  status: status
								}
						param.push(params);
							}
					$.ajax({
						url:"/erp/inventory/purchaseRegister",
						method:"POST",
						dataType:"json",
						contentType: 'application/json',
						data: JSON.stringify(param),
						success:()=>{
						Swal.fire({
							  icon: "success",
							  title: "입고 완료!",
							  text: "입고가 완료되었습니다."
							});
						$('#inboundModal').modal('hide');
						purcharsegrid.uncheckAll();
						}
						})
				})
			
			// 행추가 rowKey값이 고정이 아니라서 문제가 있음.
			inboundGrid.on('click', (ev)=>{
				let { rowKey, columnName } = ev;
				
				// rowKey = 키값, columnName = 셀의 이름
				let addData = {
						      purOrdDtlCode: '',
						      itemCode: '',
						      itemName: '',
						      quantity: ''
						      /* , pquantity: ''
						      , notStock: '' */
						      , loc: ''
						      , qty: ''
						      , note: ''
						      , origin: false
						    };
				
				// 컬럼명과 값을 확인 후 추가 진행
				if(columnName === 'origin' &&
						inboundGrid.getValue(rowKey, columnName) === true){
					
				let idx = inboundGrid.getIndexOfRow(rowKey);
				
				 inboundGrid.appendRow(addData, {
					  at: idx + 1
					});
				}
			});
			
			
			//행삭제
		inboundGrid.on('click', (ev)=>{
				let { rowKey, columnName } = ev;
				// 조건문 = 컬럼명, 값
				if(columnName === 'origin' && inboundGrid.getValue(rowKey, columnName) === false){
				 inboundGrid.removeRow(rowKey);
				}
			})

			 // 모달안에서 그리드부를떄 참고.
			$('#inboundModal').on('shown.bs.modal',function(){
				/* if (inboundGrid.getRowCount() === 0) {
					inboundGrid.resetData([
						{
							purOrdDtlCode: '',
							itemCode: '',
							itemName: '',
							quantity: '',
							pquantity: '',
						    notStock: '',
							loc: '',
							qty: '',
							note: '',
							origin: false
						}
					]);
				} */
				inboundGrid.refreshLayout();
			})
	   } // ajax호출 끝
	})
 };
 
warehouseList();
//메인그리드 그리기

const purcharsegrid = new tui.Grid({
	//toastui 아이디 가져오기
    el: document.getElementById('Grids'),
    //checkbox부여
    rowHeaders: ['checkbox'],
    //페이지네이션
    pageOptions: {
        perPage: 10,
        useClient: true,
    },
    //필드값 구성
    columns:[
        // header: 필드 이름  name:객체 key값  align:정렬방법
        // editor:true -> cell안에 등록가능
        // width -> 크기조정
        { header: '발주서코드',name:'purOrdCode', align:'center'},
        { header: '발주상세코드',name:'purOrdDtlCode',align:'center'},
        { header: '제품명',name:'itemName',align:'center'},
        { header: '수량',name:'quantity',align:'center'},
        { header: '상태',name:'status',align:'center',
        	formatter: function(status){
        		if(status.value == 'pds-01'){
        			return status.value = '입고대기'
        		}else if(status.value == 'pds-02'){
        			return status.value = '부분입고'
        		}else{
        			return status.value = '입고완료'
        		}
        	},
        	filter: 'select'
        	},
        { header: '입고예정일자',name:'expDlvDate',align:'center'},
        { header: '입고일자',name:'reccvDate',align:'center'
    		/* ,formatter: function(expDlvDate){
    			if(expDlvDate.value == null){
    				return expDlvDate.value = '입고대기';
    			}else{
    				return expDlvDate.value;
    			}
    		} */
        },
        { header: '담당자',name:'empId',align:'center'},
        { header: '거래처',name:'vdrCode',align:'center'},
    ],
});

</script>
</body>
</html>